<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.3.3"/><meta name="description" content="Utilizing VPC Peering to separate AWS VPC Lattice Networks while providing access to a shared HTTP service." data-gatsby-head="true"/><meta property="og:title" content="VPC Lattice Part 2. Connecting Applications to Shared Services" data-gatsby-head="true"/><meta property="og:description" content="Utilizing VPC Peering to separate AWS VPC Lattice Networks while providing access to a shared HTTP service." data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="" data-gatsby-head="true"/><meta name="twitter:title" content="VPC Lattice Part 2. Connecting Applications to Shared Services" data-gatsby-head="true"/><meta name="twitter:description" content="Utilizing VPC Peering to separate AWS VPC Lattice Networks while providing access to a shared HTTP service." data-gatsby-head="true"/><style data-href="/devops-pastebin/styles.85ce37a33cee9bdbc90b.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/devops-pastebin/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/devops-pastebin/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/devops-pastebin/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/devops-pastebin/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/devops-pastebin/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/devops-pastebin/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/devops-pastebin/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/devops-pastebin/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/devops-pastebin/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/devops-pastebin/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/devops-pastebin/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/devops-pastebin/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/devops-pastebin/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/devops-pastebin/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/devops-pastebin/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/devops-pastebin/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/devops-pastebin/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/devops-pastebin/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/devops-pastebin/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/devops-pastebin/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/devops-pastebin/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/devops-pastebin/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/devops-pastebin/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/devops-pastebin/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/devops-pastebin/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/devops-pastebin/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-2xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#005b99;--color-text:#2e353f;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text-light);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio p,.bio-avatar{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><title data-gatsby-head="true">VPC Lattice Part 2. Connecting Applications to Shared Services | Yet Another DevOps Pastebin</title><link rel="sitemap" type="application/xml" href="/devops-pastebin/sitemap-index.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-HKJ4LSENQ9"></script><script>
    window.GATSBY_GTAG_PLUGIN_GA_TRACKING_ID = (
      'G-HKJ4LSENQ9'
    );
    window.GATSBY_GTAG_PLUGIN_ANONYMIZE = true;

    var options = {
      send_page_view: false
    };
    if (true) {
      options.anonymize_ip = true;
    }

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', 'G-HKJ4LSENQ9', options);
  </script><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="alternate" type="application/rss+xml" title="Sergey&#x27;s DevOps Pastebin RSS Feed" href="/devops-pastebin/rss.xml"/><link rel="icon" href="/devops-pastebin/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/devops-pastebin/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/devops-pastebin/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/devops-pastebin/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/devops-pastebin/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/devops-pastebin/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/devops-pastebin/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/devops-pastebin/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/devops-pastebin/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/devops-pastebin/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header class="global-header"><a class="header-link-home" href="/devops-pastebin/">Yet Another DevOps Pastebin</a></header><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">VPC Lattice Part 2. Connecting Applications to Shared Services</h1><p>April 14, 2023</p></header><section itemProp="articleBody"><h2>Introduction</h2>
<p>In Part 1 of the series, we looked at some of the benefits and drawbacks of VPC Lattice and theorized on possible use cases where this managed service might be helpful. We also discussed a “shared service” scenario, where some individual applications may desire access to a shared service while belonging to entirely separate networks. This pattern might present itself with a commonly shared HTTP endpoint - for example, for token generation and validation, tied to a shared encryption infrastructure. While not straightforward, utilizing VPC Lattice to support this topology is possible. Let’s now dive deeper and construct a functional multi-account and multi-VPC mini-landing zone - utilizing VPC Lattice as an application layer network.</p>
<p>Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out pulumi.com if you still need to become familiar with it. You can deploy these demo stacks using the Pulumi buttons below.</p>
<p>You may find the source code for this demo in <a href="https://github.com/svodwood/vpc-lattice-lab-1">this Github repo</a>.</p>
<blockquote>
<p>Disclaimer #1: in the Pulumi stacks, we use two AWS providers: aws and aws-native, which need separate configurations, e.g., AWS CLI profile name and region. The latter is the only option to work with Lattice from Pulumi. I cannot currently recommend the aws-native provider for production use.</p>
</blockquote>
<blockquote>
<p>Disclaimer #2: at the time of writing, some requests to VPC Lattice API return 429. AWS is still throttling requests to the service, although this may be related to your account status. Run “pulumi up” one more time if you experience this.</p>
</blockquote>
<h2>What We Are Going To Build</h2>
<p>Our focus today is on our hypothetical company’s three microservices:</p>
<ol>
<li>DirectoryService. A shared microservice.</li>
<li>BlueService. A standalone microservice.</li>
<li>GreenService. A standalone microservice.</li>
</ol>
<p>Separate development teams own the BlueService and the GreenService, respectively - each team has an isolated AWS account where they develop their microservices. An independent team maintains the third application (DirectoryService) and controls access to the application. This application runs in the third isolated AWS account.</p>
<p>Our network isolation requirements define that the GreenService must not be in the same network as the BlueService. Both services, however, need to perform HTTP GET requests to the DirectoryService - using dedicated query strings.</p>
<p>Below is the high-level diagram of the landing zone topology and network isolation requirements:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/d93d9/LatticeSharedServiceDiagram.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 136.0759493670886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGA0lEQVR42nVVCVAURxT9PbNz7M4e7HIth4CQoCAYLcASUVm0YkBABQlSEogk3kKColYUg0cMRg5LUTRRKQVEVPAoSYQyFUEglwoiisqtEYMxKldABaVTPbuLhCRd1Tv9+7//+vc/euFpRuiMXz/T2WKMQcbSZhQCDYA4lQDAUQg4XL4N8Nl4eJweNKlwqZcaACgpQ5sjGMLKCRYAJJAaMtaiPmm6SXvyjHEAgHYsnMJYK1kKAGgEQNEIGLmMZwi4dnuwU8O2mdpHyX4uAAA7I70ZEx5RIhEA+crIPr0+0E3ZnhroSRQYnyZ7jMDSLABIid7FwYHzGjOaw51pkBw6Xt2eFuhBCDD+jmBZlkYES6YAahkjEIKWlLkwmLfEou9wZBbeO53f6u8ASg6x4xxHsyQcZIRNGUeuxTSlzIOB3I/t+w5HHsRrgIr3EsBczhIvFQQns1ExbLwNwP0VKqEzVTcfr+fp3HAbeOctB56Q1Z3Mn1Sdm+1K1tNcHPjdvggexlupOlJ1IdgDAKeYAS9BEkMsQWautWV3n6iA81VPzM7VvQoob3ghpB0tAc/xE0TCO6dOeF/PzXYja68JnnzqsVI4X9OpLboz6F/Z+JIvqGgBldqMGSKcPNWPv1BxG8pr2nwuXW3qrqhtdyoqqwVHZ1fe2d6OAf2g7LRaZpKPn/R8aQ1cutYaUHatpbO0+qFladV9cHGb+IaQEZSs+0ebITynSvDaUxYVWdjIOoeuBAkviKXgaGvLmqvVJOgSVqnhXJZsh+DsGpXnrh+iUopuUS5+IUBzMsYYQw54gQgMTP9Apdh4JkY2NVSOSNYkHCGkkD6DrFgavMATLD03wVS+Lj+a05jJKAAeJGJSBL2HNs6khpA6YqPCMuncIgA/okQqOyfKQMQYCpfI4FDwDKyTLyosNp2JInG9SIFxSMU6oqRy8XRV8CqVZkNhzM7TR+w/jNARTyQMIyHkgPQGLCVTEGJaFZFoqlmXF7MrO9WeyGSaK3lejzIxp/OIzazVgv3WM4sLrhZPcBA5aAlCSG1oL/JVswo1t5Towr5Uvb3l5KqcKyUuf3410/3qRl8rXB8n8gmIl5OWYW2Cl5lZbSpcJnGbrdByjJRXKGWGzAkiDoEAiCPXYuwiEy2tN+QvJnY1yfPH5K+Yam0ID8iOLhyr6Uty8RNjFZcToW8rsTtEAMfpb3LvCz8o+cRb++LzMb6ibmXWArJv7CQTuZQ8KCBfFZugamp44H6lucdtf1mrrrrlL7e6tpfOPn4B8jfhEwea4z9L3tzY5vZjQ5d7Zmmzrvb+c9cbzR2u23ZkkJJRiQ9B0eW6ifWPXvfXPejDN1u7++sePMf1j151Z+Z8O4qcPnxmZhdZ3W1/3XO77QW+ea9HxN5tHxgorfrNw1AJwBRX3vVsejyICWFV41N8u+05JvLXx0vsRhIeOn7BuvGPQUwIqxufijZELr/x0MtIKEvdf9ymurkrvqa1J+Fm28CnNS09a6ubumIXxyVqRhLGrEgwqWrqjCMYEdvak1DV2BGfdep7azGBvFQmxsloQOpp2JrKPXt5KICnLvz8L/3wwzieF2MoEKFyGsDLggT7nqzoc9f3xUoPYIxuZW+BeT7ugHEZwvgsipuvg33LZyPAGBr2RJv0HI4u6i9YY98+c+hMfZaHUk+9h35P8Y/6Za03eeIZtZSW21uoFIZMI0etWjDEifWxkUhrt7zrUZkUxGFcbSQUPZTbqqVDVyiOnazu3ROo6c0Ignt7o2hcvAF6j60MfXZkeRjBWKnlFgjAyvCyIEOfg4RCbwjJj7utCkZpZDzGP8GNTTp4kh4A/TlLqMcHoqDzYFRQS3pYCDnQTMETMlsEYGptwpvwDM05WSr/6eGwwuV8nc1ojNNEoW3XPKr3m3DoPhAW0pUZGnJlsz/8x2CHrfVJGbbBG58oMa7HFlFtGeHQkhayoDU99P2OQ9FwOWkOxUuGmocy2Pyvh9RwQjLyVgdSuCwRcHkSZK+ZS43wjh6B1//rGUjVhmkBAJbDv6ZyXquR81rDnnHfiDHaETLp31r5UekiqsJsAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="VPC Lattice Shared Service Topology"
        title="VPC Lattice Shared Service Topology"
        src="/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/f058b/LatticeSharedServiceDiagram.png"
        srcset="/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/c26ae/LatticeSharedServiceDiagram.png 158w,
/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/6bdcf/LatticeSharedServiceDiagram.png 315w,
/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/f058b/LatticeSharedServiceDiagram.png 630w,
/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/40601/LatticeSharedServiceDiagram.png 945w,
/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/d93d9/LatticeSharedServiceDiagram.png 1243w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>To start building, we are going to need to meet the prerequisites:</p>
<ol>
<li>Three separate AWS accounts belong to a single AWS Organization. Additionally, we must enable RAM sharing across the Organization.</li>
<li>Three configured CLI profiles - for all three accounts, respectively. Mind that the aws:profile and aws-native:profile providers must be configured explicitly and separately. They may, however, reuse the same credentials.</li>
<li>A working Pulumi environment.</li>
<li>Account IDs of all three AWS accounts.</li>
</ol>
<h2>Pulumi Stacks and Deployment Procedures</h2>
<p>Our lab repository consists of three directories, each corresponding to a separate Pulumi stack:</p>
<ol>
<li>./a-common-service</li>
<li>./b-blue-service</li>
<li>./c-green-service</li>
</ol>
<p>A “common-service” stack contains the infrastructure for the DirectoryService application deployed to a separate AWS account. This specific account also owns the two independent VPC Lattice Service Networks:</p>
<ol>
<li>One is to control the communication with the GreenService.</li>
<li>Another is to control the communication with BlueService.</li>
</ol>
<p>We share the Service Networks with the respective microservice accounts via AWS RAM. As such, we provision the stacks in the same order listed above. Once the “common-service” stack is up, note the two VPC Lattice Service Networks - we must use their ARNs in the blue and green stack configurations, respectively. For simplicity, we will not use stack imports here and will copy-paste the correct values of the “common-service” stack output. Also, make a note of the “shared-service-fqdn” output value. Then, copy-paste that into both “blue-service” and “green-service” stack inputs.</p>
<p>Deploy the Common Service:
<a href="https://app.pulumi.com/new?template=https://github.com/svodwood/vpc-lattice-lab-1/tree/main/a-common-service"><img src="https://get.pulumi.com/new/button.svg" alt="Deploy"></a></p>
<p>Deploy the Blue Service:
<a href="https://app.pulumi.com/new?template=https://github.com/svodwood/vpc-lattice-lab-1/tree/main/b-blue-service"><img src="https://get.pulumi.com/new/button.svg" alt="Deploy"></a></p>
<p>Deploy the Green Service:
<a href="https://app.pulumi.com/new?template=https://github.com/svodwood/vpc-lattice-lab-1/tree/main/c-green-service"><img src="https://get.pulumi.com/new/button.svg" alt="Deploy"></a></p>
<h2>Pulumi Stack: Common Service</h2>
<p>Our “common-service” stack consists of essential VPC components, Lattice-specific network components, AWS RAM shares and a Lambda function running FastAPI. In addition, we use a private Application Load Balancer to front our Lambda function. First, let’s break down the stack.</p>
<p>Our Pulumi project consists of the following files:</p>
<ol>
<li>settings.py - holds generic settings and Pulumi configuration variables.</li>
<li>helpers.py - holds generic helper functions, if any.</li>
<li>vpc.py - constructs three VPCs in our shared service AWS account.</li>
<li>lattice.py - constructs Lattice Service Networks, associates them with the correct VPCs and shares them with the correct AWS accounts.</li>
<li>app_infra.py - constructs everything around the Lambda function, including the ALB, IAM and the Lambda itself.</li>
<li>main.py - executes the code.</li>
</ol>
<p>First, we define the settings and fetch configuration variables (settings.py):</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pulumi <span class="token keyword">import</span> Config

<span class="token triple-quoted-string string">"""
Various stack settings.
Below baseline tags must be applied to all created resources without exception:
1.  Key: "Account"
    Values: ["Management", "GreenSandbox", "BlueSandbox", "SharedServices"]
2.  Key: "AccountType"
    Values: ["Management", "Workload"]
3.  Key: "Provisioned"
    Values: ["Manually", "Pulumi", "Terraform", "Other"]
4.  Key: "StackName"
    Values: ["&lt;project-name-here>"]
"""</span>
pulumi_config <span class="token operator">=</span> Config<span class="token punctuation">(</span><span class="token punctuation">)</span>
provider_config <span class="token operator">=</span> Config<span class="token punctuation">(</span><span class="token string">"aws"</span><span class="token punctuation">)</span>
deployment_region <span class="token operator">=</span> provider_config<span class="token punctuation">.</span>require<span class="token punctuation">(</span><span class="token string">"region"</span><span class="token punctuation">)</span>

baseline_cost_tags <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Account"</span><span class="token punctuation">:</span> <span class="token string">"SharedServices"</span><span class="token punctuation">,</span>
    <span class="token string">"AccountType"</span><span class="token punctuation">:</span> <span class="token string">"Workload"</span><span class="token punctuation">,</span>
    <span class="token string">"Provisioned"</span><span class="token punctuation">:</span> <span class="token string">"Pulumi"</span><span class="token punctuation">,</span>
    <span class="token string">"StackName"</span><span class="token punctuation">:</span> <span class="token string">"common-service"</span>
<span class="token punctuation">}</span>

baseline_cost_tags_native <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"AccountType"</span><span class="token punctuation">,</span>
        <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"Workload"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"Account"</span><span class="token punctuation">,</span>
        <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"SharedServices"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"Provisioned"</span><span class="token punctuation">,</span>
        <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"Pulumi"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"StackName"</span><span class="token punctuation">,</span>
        <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"common-service"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

shared_services_main_vpc_cidr <span class="token operator">=</span> <span class="token string">"10.0.0.0/16"</span>

shared_service_subnet_cidrs_pub <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"10.0.0.0/22"</span><span class="token punctuation">,</span>
    <span class="token string">"10.0.4.0/22"</span>
<span class="token punctuation">]</span>

shared_service_subnet_cidrs_app <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"10.0.8.0/22"</span><span class="token punctuation">,</span>
    <span class="token string">"10.0.12.0/22"</span>
<span class="token punctuation">]</span>

<span class="token triple-quoted-string string">"""
VPC Lattice Local Peers
"""</span>
blue_network_vpc_cidr <span class="token operator">=</span> <span class="token string">"192.168.0.0/23"</span>
blue_subnet_cidrs <span class="token operator">=</span> <span class="token punctuation">[</span> 
    <span class="token string">"192.168.0.0/24"</span><span class="token punctuation">,</span>
    <span class="token string">"192.168.1.0/24"</span>	
<span class="token punctuation">]</span>

green_network_vpc_cidr <span class="token operator">=</span> <span class="token string">"192.168.2.0/23"</span>
green_subnet_cidrs <span class="token operator">=</span> <span class="token punctuation">[</span> 
    <span class="token string">"192.168.2.0/24"</span><span class="token punctuation">,</span>
    <span class="token string">"192.168.3.0/24"</span>	
<span class="token punctuation">]</span>

<span class="token triple-quoted-string string">"""
VPC Lattice Dev Accounts
"""</span>
green_principal <span class="token operator">=</span> pulumi_config<span class="token punctuation">.</span>require<span class="token punctuation">(</span><span class="token string">"green-principal"</span><span class="token punctuation">)</span>
blue_principal <span class="token operator">=</span> pulumi_config<span class="token punctuation">.</span>require<span class="token punctuation">(</span><span class="token string">"blue-principal"</span><span class="token punctuation">)</span></code></pre></div>
<p>Second, get some helpers (helpers.py):</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> get_caller_identity<span class="token punctuation">,</span> get_availability_zones

<span class="token triple-quoted-string string">"""
Various stack helper functions and configuration variables.
"""</span>

current_account <span class="token operator">=</span> get_caller_identity<span class="token punctuation">(</span><span class="token punctuation">)</span>
current_account_id <span class="token operator">=</span> current_account<span class="token punctuation">.</span>account_id
demo_azs <span class="token operator">=</span> get_availability_zones<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">"available"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>names</code></pre></div>
<p>Thirdly, construct the VPCs (vpc.py):</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> ec2
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> ResourceOptions

<span class="token keyword">from</span> settings <span class="token keyword">import</span> baseline_cost_tags<span class="token punctuation">,</span> deployment_region<span class="token punctuation">,</span> shared_services_main_vpc_cidr<span class="token punctuation">,</span> blue_network_vpc_cidr<span class="token punctuation">,</span> green_network_vpc_cidr<span class="token punctuation">,</span> blue_subnet_cidrs<span class="token punctuation">,</span> green_subnet_cidrs<span class="token punctuation">,</span> shared_service_subnet_cidrs_pub<span class="token punctuation">,</span> shared_service_subnet_cidrs_app
<span class="token keyword">from</span> helpers <span class="token keyword">import</span> demo_azs

<span class="token triple-quoted-string string">"""
Constructs Shared Services main VPC:
"""</span>
shared_services_main_vpc <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Vpc<span class="token punctuation">(</span><span class="token string">"SharedServicesMainVpc"</span><span class="token punctuation">,</span>
    cidr_block<span class="token operator">=</span>shared_services_main_vpc_cidr<span class="token punctuation">,</span>
    enable_dns_hostnames<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    enable_dns_support<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SharedServicesMainVpc-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

shared_services_main_igw <span class="token operator">=</span> ec2<span class="token punctuation">.</span>InternetGateway<span class="token punctuation">(</span><span class="token string">"SharedServicesMainVpcIgw"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SharedServicesMainVpcIgw-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs secondary VPCs for peering and Lattice connection:
"""</span>
green_network_vpc <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Vpc<span class="token punctuation">(</span><span class="token string">"GreenNetworkVpc"</span><span class="token punctuation">,</span>
    cidr_block<span class="token operator">=</span>green_network_vpc_cidr<span class="token punctuation">,</span>
    enable_dns_hostnames<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    enable_dns_support<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"GreenNetworkVpc-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

blue_network_vpc <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Vpc<span class="token punctuation">(</span><span class="token string">"BlueNetworkVpc"</span><span class="token punctuation">,</span>
    cidr_block<span class="token operator">=</span>blue_network_vpc_cidr<span class="token punctuation">,</span>
    enable_dns_hostnames<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    enable_dns_support<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"BlueNetworkVpc-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Establishes VPC peering connections:
"""</span>
green_peering_connection <span class="token operator">=</span> ec2<span class="token punctuation">.</span>VpcPeeringConnection<span class="token punctuation">(</span><span class="token string">"GreenPeeringConnection"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    peer_vpc_id<span class="token operator">=</span>green_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    auto_accept<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            shared_services_main_vpc<span class="token punctuation">,</span>
            green_network_vpc
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

green_peering_connection_options <span class="token operator">=</span> ec2<span class="token punctuation">.</span>PeeringConnectionOptions<span class="token punctuation">(</span><span class="token string">"GreenPeeringConnectionOptions"</span><span class="token punctuation">,</span>
    vpc_peering_connection_id<span class="token operator">=</span>green_peering_connection<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    accepter<span class="token operator">=</span>ec2<span class="token punctuation">.</span>PeeringConnectionOptionsAccepterArgs<span class="token punctuation">(</span>
        allow_remote_vpc_dns_resolution<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    requester<span class="token operator">=</span>ec2<span class="token punctuation">.</span>PeeringConnectionOptionsRequesterArgs<span class="token punctuation">(</span>
        allow_remote_vpc_dns_resolution<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>green_peering_connection<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            green_peering_connection
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

blue_peering_connection <span class="token operator">=</span> ec2<span class="token punctuation">.</span>VpcPeeringConnection<span class="token punctuation">(</span><span class="token string">"BluePeeringConnection"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    peer_vpc_id<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    auto_accept<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            shared_services_main_vpc<span class="token punctuation">,</span>
            blue_network_vpc
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

blue_peering_connection_options <span class="token operator">=</span> ec2<span class="token punctuation">.</span>PeeringConnectionOptions<span class="token punctuation">(</span><span class="token string">"BluePeeringConnectionOptions"</span><span class="token punctuation">,</span>
    vpc_peering_connection_id<span class="token operator">=</span>blue_peering_connection<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    accepter<span class="token operator">=</span>ec2<span class="token punctuation">.</span>PeeringConnectionOptionsAccepterArgs<span class="token punctuation">(</span>
        allow_remote_vpc_dns_resolution<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    requester<span class="token operator">=</span>ec2<span class="token punctuation">.</span>PeeringConnectionOptionsRequesterArgs<span class="token punctuation">(</span>
        allow_remote_vpc_dns_resolution<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>blue_peering_connection<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            blue_peering_connection
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs Shared Services main VPC's subnets:
"""</span>
shared_services_pub_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
shared_services_app_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

    shared_service_subnet_pub <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SharedServiceSubnetPub-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>shared_service_subnet_cidrs_pub<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SharedServiceSubnetPub-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_services_pub_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>shared_service_subnet_pub<span class="token punctuation">)</span>

    shared_service_rt_pub <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SharedServiceRtPub-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SharedServiceRtPub-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_service_subnet_pub<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_service_rt_pub_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SharedServiceRtaPub-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>shared_service_rt_pub<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>shared_service_subnet_pub<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_service_subnet_pub<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_service_pub_route_to_wan <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"WanPubRoute-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>shared_service_rt_pub<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        gateway_id<span class="token operator">=</span>shared_services_main_igw<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
            parent<span class="token operator">=</span>shared_service_rt_pub
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_service_subnet_app <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SharedServiceSubnetApp-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>shared_service_subnet_cidrs_app<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SharedServiceSubnetApp-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_services_app_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>shared_service_subnet_app<span class="token punctuation">)</span>

    shared_service_rt_app <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SharedServiceRtApp-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SharedServiceRtApp-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_service_subnet_app<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_service_rt_app_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SharedServiceAppRta-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>shared_service_rt_app<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>shared_service_subnet_app<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_service_subnet_app<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_service_route_to_green <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"RouteToGreenPeer-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>shared_service_rt_app<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        vpc_peering_connection_id<span class="token operator">=</span>green_peering_connection<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span>green_network_vpc_cidr<span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
            parent<span class="token operator">=</span>shared_service_rt_app<span class="token punctuation">,</span>
            depends_on<span class="token operator">=</span><span class="token punctuation">[</span>green_peering_connection<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    shared_service_route_to_blue <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"RouteToBluePeer-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>shared_service_rt_app<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        vpc_peering_connection_id<span class="token operator">=</span>blue_peering_connection<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span>blue_network_vpc_cidr<span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
            parent<span class="token operator">=</span>shared_service_rt_app<span class="token punctuation">,</span>
            depends_on<span class="token operator">=</span><span class="token punctuation">[</span>blue_peering_connection<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs green network peer subnets:
"""</span>
green_peer_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

    green_peer_subnet <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"GreenPeerSubnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>green_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>green_subnet_cidrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"GreenPeerSubnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>green_network_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    green_peer_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>green_peer_subnet<span class="token punctuation">)</span>
    
    green_peer_rt <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"GreenPeerRt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>green_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"GreenPeerRt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>green_peer_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    green_peer_rt_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"GreenPeerRta-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>green_peer_rt<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>green_peer_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>green_peer_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    green_peer_main_route <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"GreenPeerMainRoute-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>green_peer_rt<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        vpc_peering_connection_id<span class="token operator">=</span>green_peering_connection<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span>shared_services_main_vpc_cidr<span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
            parent<span class="token operator">=</span>green_peer_rt<span class="token punctuation">,</span>
            depends_on<span class="token operator">=</span><span class="token punctuation">[</span>green_peering_connection<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
Constructs blue network peer subnets:
"""</span>
blue_peer_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

    blue_peer_subnet <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"BluePeerSubnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>blue_subnet_cidrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"BluePeerSubnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    blue_peer_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>blue_peer_subnet<span class="token punctuation">)</span>
    
    blue_peer_rt <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"BluePeerRt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"BluePeerRt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>blue_peer_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    blue_peer_rt_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"BluePeerRta-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>blue_peer_rt<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>blue_peer_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>blue_peer_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    blue_peer_main_route <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"BluePeerMainRoute-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>blue_peer_rt<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        vpc_peering_connection_id<span class="token operator">=</span>blue_peering_connection<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span>shared_services_main_vpc_cidr<span class="token punctuation">,</span>
        opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
            parent<span class="token operator">=</span>blue_peer_rt<span class="token punctuation">,</span>
            depends_on<span class="token operator">=</span><span class="token punctuation">[</span>blue_peering_connection<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Creates demo security groups in the Green and Blue VPCs:
"""</span>
green_lattice_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"GreenSecurityGroup"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Green Lattice Security Group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>green_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    ingress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupIngressArgs<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any"</span><span class="token punctuation">,</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    egress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupEgressArgs<span class="token punctuation">(</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"GreenSecurityGroup-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>green_network_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

blue_lattice_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"BlueSecurityGroup"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Blue Lattice Security Group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    ingress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupIngressArgs<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any"</span><span class="token punctuation">,</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    egress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupEgressArgs<span class="token punctuation">(</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"BlueSecurityGroup-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Creates a demo security group in the main VPC, to be used with the Application Load Balancer:
"""</span>
main_lambda_alb_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"MainLambdaAlbSecurityGroup"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"ALB Security Group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    ingress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupIngressArgs<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any"</span><span class="token punctuation">,</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    egress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupEgressArgs<span class="token punctuation">(</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"MainLambdaAlbSecurityGroup-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>Fourthly, create Lattice networks (lattice.py):</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pulumi_aws_native <span class="token keyword">import</span> vpclattice
<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> ram
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> ResourceOptions<span class="token punctuation">,</span> export

<span class="token keyword">from</span> settings <span class="token keyword">import</span> baseline_cost_tags<span class="token punctuation">,</span> deployment_region<span class="token punctuation">,</span> baseline_cost_tags_native<span class="token punctuation">,</span> green_principal<span class="token punctuation">,</span> blue_principal
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> green_network_vpc<span class="token punctuation">,</span> blue_network_vpc<span class="token punctuation">,</span> green_lattice_sg<span class="token punctuation">,</span> blue_lattice_sg

<span class="token triple-quoted-string string">"""
Creates the RAM shares for Lattice service networks:
"""</span>
green_ram_share <span class="token operator">=</span> ram<span class="token punctuation">.</span>ResourceShare<span class="token punctuation">(</span><span class="token string">"GreenLatticeRamShare"</span><span class="token punctuation">,</span>
    allow_external_principals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token comment"># Make note that this share will not work outside your AWS Organization by default, set to True if needed</span>
    tags<span class="token operator">=</span>baseline_cost_tags
<span class="token punctuation">)</span>

blue_ram_share <span class="token operator">=</span> ram<span class="token punctuation">.</span>ResourceShare<span class="token punctuation">(</span><span class="token string">"BlueLatticeRamShare"</span><span class="token punctuation">,</span>
    allow_external_principals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token comment"># Make note that this share will not work outside your AWS Organization by default, set to True if needed</span>
    tags<span class="token operator">=</span>baseline_cost_tags
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Associates principals to the RAM shares:
"""</span>
green_principal_association <span class="token operator">=</span> ram<span class="token punctuation">.</span>PrincipalAssociation<span class="token punctuation">(</span><span class="token string">"GreenPrincipalAssociation"</span><span class="token punctuation">,</span>
    principal<span class="token operator">=</span>green_principal<span class="token punctuation">,</span>
    resource_share_arn<span class="token operator">=</span>green_ram_share<span class="token punctuation">.</span>arn
<span class="token punctuation">)</span>

blue_principal_association <span class="token operator">=</span> ram<span class="token punctuation">.</span>PrincipalAssociation<span class="token punctuation">(</span><span class="token string">"BluePrincipalAssociation"</span><span class="token punctuation">,</span>
    principal<span class="token operator">=</span>blue_principal<span class="token punctuation">,</span>
    resource_share_arn<span class="token operator">=</span>blue_ram_share<span class="token punctuation">.</span>arn
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs green and blue service networks:
"""</span>
green_service_network <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>ServiceNetwork<span class="token punctuation">(</span><span class="token string">"GreenServiceNetwork"</span><span class="token punctuation">,</span>
    auth_type<span class="token operator">=</span><span class="token string">"NONE"</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"green-service-network"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native
<span class="token punctuation">)</span>

export<span class="token punctuation">(</span><span class="token string">"green-service-network-arn"</span><span class="token punctuation">,</span> green_service_network<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

blue_service_network <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>ServiceNetwork<span class="token punctuation">(</span><span class="token string">"BlueServiceNetwork"</span><span class="token punctuation">,</span>
    auth_type<span class="token operator">=</span><span class="token string">"NONE"</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"blue-service-network"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native
<span class="token punctuation">)</span>

export<span class="token punctuation">(</span><span class="token string">"blue-service-network-arn"</span><span class="token punctuation">,</span> blue_service_network<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Adds service networks to respective RAM shares:
"""</span>
green_ram_share_association <span class="token operator">=</span> ram<span class="token punctuation">.</span>ResourceAssociation<span class="token punctuation">(</span><span class="token string">"GreenLatticeRamShareAssociation"</span><span class="token punctuation">,</span>
    resource_arn<span class="token operator">=</span>green_service_network<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    resource_share_arn<span class="token operator">=</span>green_ram_share<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>green_ram_share<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            green_service_network
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

blue_ram_share_association <span class="token operator">=</span> ram<span class="token punctuation">.</span>ResourceAssociation<span class="token punctuation">(</span><span class="token string">"BlueLatticeRamShareAssociation"</span><span class="token punctuation">,</span>
    resource_arn<span class="token operator">=</span>blue_service_network<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    resource_share_arn<span class="token operator">=</span>blue_ram_share<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>blue_ram_share<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            blue_service_network
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Adds service netowork VPC associations (Green Peer and Blue Peer in SharedServices):
"""</span>
green_service_network_vpc_association <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>ServiceNetworkVpcAssociation<span class="token punctuation">(</span><span class="token string">"GreenServiceNetworkVpcAssociation"</span><span class="token punctuation">,</span>
    security_group_ids<span class="token operator">=</span><span class="token punctuation">[</span>green_lattice_sg<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    service_network_identifier<span class="token operator">=</span>green_service_network<span class="token punctuation">,</span>
    vpc_identifier<span class="token operator">=</span>green_network_vpc<span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>green_service_network<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            green_service_network<span class="token punctuation">,</span>
            green_network_vpc
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

blue_service_network_vpc_association <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>ServiceNetworkVpcAssociation<span class="token punctuation">(</span><span class="token string">"BlueServiceNetworkVpcAssociation"</span><span class="token punctuation">,</span>
    security_group_ids<span class="token operator">=</span><span class="token punctuation">[</span>blue_lattice_sg<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    service_network_identifier<span class="token operator">=</span>blue_service_network<span class="token punctuation">,</span>
    vpc_identifier<span class="token operator">=</span>blue_network_vpc<span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        parent<span class="token operator">=</span>blue_service_network<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            blue_service_network<span class="token punctuation">,</span>
            blue_network_vpc
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>Finally, create the “SharedService” Lambda function and register it as a Lattice Service (app_infra.py):</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pulumi <span class="token keyword">import</span> ResourceOptions<span class="token punctuation">,</span> FileArchive<span class="token punctuation">,</span> AssetArchive<span class="token punctuation">,</span> export
<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> lb<span class="token punctuation">,</span> iam<span class="token punctuation">,</span> lambda_<span class="token punctuation">,</span> ec2
<span class="token keyword">from</span> pulumi_aws_native <span class="token keyword">import</span> vpclattice
<span class="token keyword">import</span> json

<span class="token keyword">from</span> settings <span class="token keyword">import</span> baseline_cost_tags<span class="token punctuation">,</span> deployment_region<span class="token punctuation">,</span> baseline_cost_tags_native<span class="token punctuation">,</span> blue_principal<span class="token punctuation">,</span> green_principal
<span class="token keyword">from</span> helpers <span class="token keyword">import</span> current_account_id
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> main_lambda_alb_sg<span class="token punctuation">,</span> shared_services_app_subnets<span class="token punctuation">,</span> shared_services_main_vpc
<span class="token keyword">from</span> lattice <span class="token keyword">import</span> green_service_network<span class="token punctuation">,</span> blue_service_network

<span class="token triple-quoted-string string">"""
Constructs a private Application Load Balancer for the Lambda function:
"""</span>
<span class="token comment"># This one costs money:</span>
shared_service_alb <span class="token operator">=</span> lb<span class="token punctuation">.</span>LoadBalancer<span class="token punctuation">(</span><span class="token string">"DirectoryServiceLb"</span><span class="token punctuation">,</span>
    internal<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    load_balancer_type<span class="token operator">=</span><span class="token string">"application"</span><span class="token punctuation">,</span>
    security_groups<span class="token operator">=</span><span class="token punctuation">[</span>main_lambda_alb_sg<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    subnets<span class="token operator">=</span>shared_services_app_subnets<span class="token punctuation">,</span>
    enable_deletion_protection<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"DirectoryServiceLb"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

shared_service_target_group <span class="token operator">=</span> lb<span class="token punctuation">.</span>TargetGroup<span class="token punctuation">(</span><span class="token string">"DirectoryServiceTg"</span><span class="token punctuation">,</span>
    target_type<span class="token operator">=</span><span class="token string">"lambda"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"DirectoryServiceTg"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># This one costs money (via ALB dependency):</span>
shared_service_listener <span class="token operator">=</span> lb<span class="token punctuation">.</span>Listener<span class="token punctuation">(</span><span class="token string">"DirectoryServiceListener"</span><span class="token punctuation">,</span>
    load_balancer_arn<span class="token operator">=</span>shared_service_alb<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"HTTP"</span><span class="token punctuation">,</span>
    default_actions<span class="token operator">=</span><span class="token punctuation">[</span>lb<span class="token punctuation">.</span>ListenerDefaultActionArgs<span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"forward"</span><span class="token punctuation">,</span>
        target_group_arn<span class="token operator">=</span>shared_service_target_group<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Creates a Lambda security group in the main VPC:
"""</span>
main_lambda_func_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"MainLambdaFuncSecurityGroup"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Lambda Security Group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    ingress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupIngressArgs<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any"</span><span class="token punctuation">,</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    egress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupEgressArgs<span class="token punctuation">(</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"MainLambdaFuncSecurityGroup-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
Constructs a Lambda IAM role
"""</span>
directory_service_execution_role <span class="token operator">=</span> iam<span class="token punctuation">.</span>Role<span class="token punctuation">(</span><span class="token string">"DirectoryServiceExecutionRole"</span><span class="token punctuation">,</span>
    assume_role_policy<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token string">"sts:AssumeRole"</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Sid"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"Service"</span><span class="token punctuation">:</span> <span class="token string">"lambda.amazonaws.com"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"DirectoryServiceExecutionRole"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

lambda_vpc_managed_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>get_policy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"AWSLambdaVPCAccessExecutionRole"</span><span class="token punctuation">)</span>

directory_service_execution_role_policy_attachment <span class="token operator">=</span> iam<span class="token punctuation">.</span>RolePolicyAttachment<span class="token punctuation">(</span><span class="token string">"DirectoryServiceExecutionRolePolicyAttachment"</span><span class="token punctuation">,</span>
    policy_arn<span class="token operator">=</span>lambda_vpc_managed_policy<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    role<span class="token operator">=</span>directory_service_execution_role
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Creates the DirectoryService Lambda layer:
"""</span>

layer_asset <span class="token operator">=</span> FileArchive<span class="token punctuation">(</span><span class="token string">"./directory_app_layer/lambda_layer.zip"</span><span class="token punctuation">)</span>

service_layer <span class="token operator">=</span> lambda_<span class="token punctuation">.</span>LayerVersion<span class="token punctuation">(</span><span class="token string">"DirectoryServiceLayer"</span><span class="token punctuation">,</span>
    compatible_runtimes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python3.8"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    code<span class="token operator">=</span>layer_asset<span class="token punctuation">,</span>
    layer_name<span class="token operator">=</span><span class="token string">"lambda_layer"</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs the DirectoryService Lambda function:
"""</span>
service_function <span class="token operator">=</span> lambda_<span class="token punctuation">.</span>Function<span class="token punctuation">(</span><span class="token string">"DirectoryServiceFunction"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"DirectoryServiceFunction"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    role<span class="token operator">=</span>directory_service_execution_role<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    vpc_config<span class="token operator">=</span>lambda_<span class="token punctuation">.</span>FunctionVpcConfigArgs<span class="token punctuation">(</span>
        security_group_ids<span class="token operator">=</span><span class="token punctuation">[</span>main_lambda_func_sg<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        subnet_ids<span class="token operator">=</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> shared_services_app_subnets<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    replace_security_groups_on_destroy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"DirectoryServiceFunction"</span><span class="token punctuation">,</span>
    runtime<span class="token operator">=</span><span class="token string">"python3.8"</span><span class="token punctuation">,</span>
    layers<span class="token operator">=</span><span class="token punctuation">[</span>service_layer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    code<span class="token operator">=</span>AssetArchive<span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
            <span class="token string">"."</span><span class="token punctuation">:</span> FileArchive<span class="token punctuation">(</span><span class="token string">"./directory_app"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    handler<span class="token operator">=</span><span class="token string">"main.lambda_handler"</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Adds the ALB Lambda invoke permission:
"""</span>
alb_invoke_permission <span class="token operator">=</span> lambda_<span class="token punctuation">.</span>Permission<span class="token punctuation">(</span><span class="token string">"AlbFunctionPermission"</span><span class="token punctuation">,</span>
    action<span class="token operator">=</span><span class="token string">"lambda:InvokeFunction"</span><span class="token punctuation">,</span>
    function<span class="token operator">=</span>service_function<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    principal<span class="token operator">=</span><span class="token string">"elasticloadbalancing.amazonaws.com"</span><span class="token punctuation">,</span>
    source_arn<span class="token operator">=</span>shared_service_target_group<span class="token punctuation">.</span>arn
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Attaches the Lambda function to the target group:
"""</span>
service_function_target_group_attachment <span class="token operator">=</span> lb<span class="token punctuation">.</span>TargetGroupAttachment<span class="token punctuation">(</span><span class="token string">"FunctionTargetGroupAttachment"</span><span class="token punctuation">,</span>
    target_group_arn<span class="token operator">=</span>shared_service_target_group<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    target_id<span class="token operator">=</span>service_function<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>depends_on<span class="token operator">=</span><span class="token punctuation">[</span>alb_invoke_permission<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Creates a Lattice target group:
"""</span>
shared_service_lattice_tg <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>TargetGroup<span class="token punctuation">(</span><span class="token string">"SharedServiceTargetGroup"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ALB"</span><span class="token punctuation">,</span>
    config<span class="token operator">=</span>vpclattice<span class="token punctuation">.</span>TargetGroupConfigArgs<span class="token punctuation">(</span>
        port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"HTTP"</span><span class="token punctuation">,</span>
        vpc_identifier<span class="token operator">=</span>shared_services_main_vpc<span class="token punctuation">.</span><span class="token builtin">id</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"shared-service-target"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native<span class="token punctuation">,</span>
    targets<span class="token operator">=</span><span class="token punctuation">[</span>vpclattice<span class="token punctuation">.</span>TargetGroupTargetArgs<span class="token punctuation">(</span>
        <span class="token builtin">id</span><span class="token operator">=</span>shared_service_alb<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        port<span class="token operator">=</span><span class="token number">80</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Creates a Lattice service and listener:
"""</span>
<span class="token comment"># From here big money:</span>
shared_service_lattice_service <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>Service<span class="token punctuation">(</span><span class="token string">"SharedServiceLatticeService"</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"shared-service"</span><span class="token punctuation">,</span>
    auth_type<span class="token operator">=</span><span class="token string">"AWS_IAM"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native
<span class="token punctuation">)</span>

export<span class="token punctuation">(</span><span class="token string">"shared-service-fqdn"</span><span class="token punctuation">,</span> shared_service_lattice_service<span class="token punctuation">.</span>dns_entry<span class="token punctuation">.</span>domain_name<span class="token punctuation">)</span>

shared_service_lattice_service_listener <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>Listener<span class="token punctuation">(</span><span class="token string">"SharedServiceLatticeServiceListener"</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"shared-service-listener"</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"HTTP"</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
    service_identifier<span class="token operator">=</span>shared_service_lattice_service<span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native<span class="token punctuation">,</span>
    default_action<span class="token operator">=</span>vpclattice<span class="token punctuation">.</span>ListenerDefaultActionArgs<span class="token punctuation">(</span>
        forward<span class="token operator">=</span>vpclattice<span class="token punctuation">.</span>ListenerForwardArgs<span class="token punctuation">(</span>
            target_groups<span class="token operator">=</span><span class="token punctuation">[</span>
                vpclattice<span class="token punctuation">.</span>ListenerWeightedTargetGroupArgs<span class="token punctuation">(</span>
                    target_group_identifier<span class="token operator">=</span>shared_service_lattice_tg<span class="token punctuation">,</span>
                    weight<span class="token operator">=</span><span class="token number">100</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            shared_service_lattice_service
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

blue_service_lattice_service_association <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>ServiceNetworkServiceAssociation<span class="token punctuation">(</span><span class="token string">"BlueServiceLatticeServiceAssociation"</span><span class="token punctuation">,</span>
    service_identifier<span class="token operator">=</span>shared_service_lattice_service<span class="token punctuation">,</span>
    service_network_identifier<span class="token operator">=</span>blue_service_network<span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            shared_service_lattice_service
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

green_service_lattice_service_association <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>ServiceNetworkServiceAssociation<span class="token punctuation">(</span><span class="token string">"GreenServiceLatticeServiceAssociation"</span><span class="token punctuation">,</span>
    service_identifier<span class="token operator">=</span>shared_service_lattice_service<span class="token punctuation">,</span>
    service_network_identifier<span class="token operator">=</span>green_service_network<span class="token punctuation">,</span>
    tags<span class="token operator">=</span>baseline_cost_tags_native<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            shared_service_lattice_service
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

shared_service_auth_policy <span class="token operator">=</span> vpclattice<span class="token punctuation">.</span>AuthPolicy<span class="token punctuation">(</span><span class="token string">"SharedServiceAuthPolicy"</span><span class="token punctuation">,</span>
    policy<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span><span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">"Effect"</span><span class="token punctuation">:</span><span class="token string">"Allow"</span><span class="token punctuation">,</span>
                <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
                <span class="token string">"Action"</span><span class="token punctuation">:</span><span class="token string">"vpc-lattice-svcs:Invoke"</span><span class="token punctuation">,</span>
                <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
                <span class="token string">"Condition"</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
                    <span class="token string">"StringEquals"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"vpc-lattice-svcs:RequestMethod"</span><span class="token punctuation">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
                        <span class="token string">"vpc-lattice-svcs:RequestQueryString/q"</span><span class="token punctuation">:</span> <span class="token string">"blue"</span><span class="token punctuation">,</span>
                        <span class="token string">"vpc-lattice-svcs:SourceVpcOwnerAccount"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>blue_principal<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"Effect"</span><span class="token punctuation">:</span><span class="token string">"Allow"</span><span class="token punctuation">,</span>
                <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
                <span class="token string">"Action"</span><span class="token punctuation">:</span><span class="token string">"vpc-lattice-svcs:Invoke"</span><span class="token punctuation">,</span>
                <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
                <span class="token string">"Condition"</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
                    <span class="token string">"StringEquals"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"vpc-lattice-svcs:RequestMethod"</span><span class="token punctuation">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
                        <span class="token string">"vpc-lattice-svcs:RequestQueryString/q"</span><span class="token punctuation">:</span> <span class="token string">"green"</span><span class="token punctuation">,</span>
                        <span class="token string">"vpc-lattice-svcs:SourceVpcOwnerAccount"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>green_principal<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    resource_identifier<span class="token operator">=</span>shared_service_lattice_service<span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            shared_service_lattice_service
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>Notice above how we restricted access to the Lattice Service using the “vpc-lattice-svcs:RequestMethod”, “vpc-lattice-svcs:RequestQueryString/q”, and “vpc-lattice-svcs:SourceVpcOwnerAccount” parameters, where “q” is just a query string key.</p>
<p>The function is rudimentary and uses a single Lambda layer for FastAPI and Mangum. I provided the layer for your convenience as a .zip archive inside the GitHub repository, so you do not have to rebuild it.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> mangum <span class="token keyword">import</span> Mangum
  
<span class="token comment"># Initialise the app</span>
app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"endpoint"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>q<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>

lambda_handler <span class="token operator">=</span> Mangum<span class="token punctuation">(</span>app<span class="token punctuation">)</span></code></pre></div>
<p>By design, we only allow GET requests from the BlueFunction to the ”<a href="http://lattice-shared-service-fqdn/?q=blue">http://lattice-shared-service-fqdn/?q=blue</a>” endpoint to succeed. Identically, only GET requests from the GreenFunction to the ”<a href="http://lattice-shared-service-fqdn/?q=green">http://lattice-shared-service-fqdn/?q=green</a>” endpoint will succeed.</p>
<h2>Pulumi Stack: Blue and Green Services</h2>
<p>Our “blue-service” and “green-service” stacks are identical apart from configuration, so we will only focus on one. The Pulumi project contains the following files:</p>
<ol>
<li>settings.py - holds generic settings and Pulumi configuration variables.</li>
<li>helpers.py - holds generic helper functions, if any.</li>
<li>vpc.py - constructs a single VPC.</li>
<li>app_infra.py - constructs everything around the Lambda function, including the ALB, IAM and the Lambda itself.</li>
<li>main.py - executes the code.</li>
</ol>
<p>Let’s take a look at app_infra.py specifically here:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pulumi <span class="token keyword">import</span> ResourceOptions<span class="token punctuation">,</span> FileArchive<span class="token punctuation">,</span> AssetArchive
<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> lb<span class="token punctuation">,</span> iam<span class="token punctuation">,</span> lambda_<span class="token punctuation">,</span> ec2
<span class="token keyword">import</span> json

<span class="token keyword">from</span> settings <span class="token keyword">import</span> baseline_cost_tags<span class="token punctuation">,</span> deployment_region<span class="token punctuation">,</span> shared_service_fqdn
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> blue_sandbox_vpc<span class="token punctuation">,</span> blue_sandbox_app_subnets

<span class="token triple-quoted-string string">"""
Lambda security group
"""</span>

blue_lambda_func_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"BlueLambdaFuncSecurityGroup"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Lambda Security Group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>blue_sandbox_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    ingress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupIngressArgs<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any"</span><span class="token punctuation">,</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    egress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupEgressArgs<span class="token punctuation">(</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"BlueLambdaFuncSecurityGroup-</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>blue_sandbox_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs a Lambda IAM role
"""</span>
blue_lambda_execution_role <span class="token operator">=</span> iam<span class="token punctuation">.</span>Role<span class="token punctuation">(</span><span class="token string">"BlueLambdaExecutionRole"</span><span class="token punctuation">,</span>
    assume_role_policy<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token string">"sts:AssumeRole"</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Sid"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token string">"Principal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"Service"</span><span class="token punctuation">:</span> <span class="token string">"lambda.amazonaws.com"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"BlueLambdaExecutionRole"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

lambda_vpc_managed_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>get_policy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"AWSLambdaVPCAccessExecutionRole"</span><span class="token punctuation">)</span>

blue_lambda_execution_role_policy_attachment <span class="token operator">=</span> iam<span class="token punctuation">.</span>RolePolicyAttachment<span class="token punctuation">(</span><span class="token string">"BlueLambdaRolePolicyAttachment"</span><span class="token punctuation">,</span>
    policy_arn<span class="token operator">=</span>lambda_vpc_managed_policy<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    role<span class="token operator">=</span>blue_lambda_execution_role
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Constructs the Blue Lambda function:
"""</span>
blue_function <span class="token operator">=</span> lambda_<span class="token punctuation">.</span>Function<span class="token punctuation">(</span><span class="token string">"BlueFunction"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>baseline_cost_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"BlueFunction"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    role<span class="token operator">=</span>blue_lambda_execution_role<span class="token punctuation">.</span>arn<span class="token punctuation">,</span>
    vpc_config<span class="token operator">=</span>lambda_<span class="token punctuation">.</span>FunctionVpcConfigArgs<span class="token punctuation">(</span>
        security_group_ids<span class="token operator">=</span><span class="token punctuation">[</span>blue_lambda_func_sg<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        subnet_ids<span class="token operator">=</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> blue_sandbox_app_subnets<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    replace_security_groups_on_destroy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">"BlueFunction"</span><span class="token punctuation">,</span>
    runtime<span class="token operator">=</span><span class="token string">"python3.8"</span><span class="token punctuation">,</span>
    code<span class="token operator">=</span>AssetArchive<span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
            <span class="token string">"."</span><span class="token punctuation">:</span> FileArchive<span class="token punctuation">(</span><span class="token string">"./blue_app"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    handler<span class="token operator">=</span><span class="token string">"main.lambda_handler"</span><span class="token punctuation">,</span>
    environment<span class="token operator">=</span>lambda_<span class="token punctuation">.</span>FunctionEnvironmentArgs<span class="token punctuation">(</span>
        variables<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"BLUE_ENDPOINT"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"http://</span><span class="token interpolation"><span class="token punctuation">{</span>shared_service_fqdn<span class="token punctuation">}</span></span><span class="token string">/?q=blue"</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>This is a rudimentary Lambda function to execute a GET request towards our shared service Lattice endpoint.</p>
<h2>Testing Connectivity</h2>
<p>You may have noticed that our environments are private, and all Lambda functions reside within their dedicated VPCs, which have no route to WAN. Let’s create a default test execution of our BlueFunction. First, we ensure the BLUE_ENDPOINT environment variable contains the “q=blue” query string:</p>
<p><img src="/devops-pastebin/844ac503cea08f1f7521b90dbf07df87/BlueLambdaEnvConfig.png" alt="AWS Lambda Blue Configuration Correct"></p>
<p>Executing the function will produce the desired result:</p>
<p><img src="/devops-pastebin/d4548e3542c75d1226b76b23697491d1/BlueLambdaEndpointTestSuccess.png" alt="AWS Lambda Blue Test Success"></p>
<p>Let’s now manually edit the query string within the BLUE_ENDPOINT environment variable:</p>
<p><img src="/devops-pastebin/d4394d32cd13636ff7028daa5a45bba5/BlueLambdaEnvConfigWrong.png" alt="AWS Lambda Blue Configuration Wrong"></p>
<p>And execute the function one more time:</p>
<p><img src="/devops-pastebin/57826e5d64a5014fccb7a4314e280e90/BlueLambdaTestForbidden.png" alt="AWS Lambda Blue Test Fail"></p>
<p>Success! Feel free to perform the same steps with the GreenFunction.</p>
<h2>Cleaning Up</h2>
<p>Run “pulumi destroy” on all the stacks in reverse order. Start from “green-service”, then “blue-service”, then “common-service”. Afterwards, delete CloudWatch Lambda log groups from all three accounts manually if needed. Due to AWS’s throttling, you may need to manually delete some VPC Lattice objects and do a “pulumi refresh” instead, although there is usually no need. If you experience throttling, running “pulumi destroy” several times resolves the issue.</p></section><hr/><footer><div class="bio"><div data-gatsby-image-wrapper="" style="width:50px;height:50px" class="gatsby-image-wrapper bio-avatar"><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#383838;width:50px;height:50px;position:relative"></div><picture><source type="image/avif" data-srcset="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/d4bf4/profile-pic.avif 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" data-srcset="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/3faea/profile-pic.webp 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png" data-srcset="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e9b55/profile-pic.png 100w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/d4bf4/profile-pic.avif 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" srcSet="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/3faea/profile-pic.webp 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" src="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png" srcSet="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e9b55/profile-pic.png 100w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p>Written by <strong>Sergey Vodwood,</strong> <!-- -->a rock climber, dad, and cloud infrastructure developer working in Israel.<!-- --> <a href="https://linkedin.com/in/vodwood">You should add him on LinkedIn.</a></p></div></footer></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/devops-pastebin/lattice-part-one/">← <!-- -->VPC Lattice Part 1. Overview</a></li><li></li></ul></nav></main><footer>© <!-- -->2023<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/lattice-part-two/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-b30435f07f03c3a4781a.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-86c6079eb03a2ae7dfe2.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-74138ca0a4cce02ffa2f.js\"],\"component---src-pages-using-typescript-tsx\":[\"/component---src-pages-using-typescript-tsx-594199879152f85e5f24.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-efe475c86500a1e03273.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="a7a26892a3345b7a2e3c";</script><script src="/devops-pastebin/webpack-runtime-15a6a54a9e8a3ace077b.js" async></script><script src="/devops-pastebin/framework-21741add02df4f0bf800.js" async></script><script src="/devops-pastebin/app-b30435f07f03c3a4781a.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>