<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Gatsby Starter Blog RSS Feed]]></title><description><![CDATA[Random thoughts on cloud infrastructure and DevOps.]]></description><link>https://gatsbystarterblogsource.gatsbyjs.io</link><generator>GatsbyJS</generator><lastBuildDate>Sat, 12 Nov 2022 21:45:55 GMT</lastBuildDate><item><title><![CDATA[AWS EC2 Auto Scaling, Target Tracking Policies and Prometheus Exporters]]></title><description><![CDATA[Introduction Quite a few workloads may still require deployment to virtual machines instead of container orchestration platforms, yet still…]]></description><link>https://gatsbystarterblogsource.gatsbyjs.io/ec2-autoscaling-groups-prometheus-metrics/</link><guid isPermaLink="false">https://gatsbystarterblogsource.gatsbyjs.io/ec2-autoscaling-groups-prometheus-metrics/</guid><pubDate>Thu, 10 Nov 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Quite a few workloads may still require deployment to virtual machines instead of container orchestration platforms, yet still, have to be intelligently autoscaled. For example, a compound workload running on a stateless EC2 instance in an EC2 Autoscaling Group may emit various Prometheus-compatible metrics via Prometheus exporters. A simplified model for such a use case could be an Amazon Linux 2 instance running a node-exporter, exposing OS metrics, and a workload application delivering its own set of Prometheus-compatible metrics.&lt;/p&gt;
&lt;p&gt;This post will illustrate how to configure an EC2 Autoscaling Group to use these metrics within Target Tracking Scaling Policies with the help of the AWS Cloudwatch agent.&lt;/p&gt;
&lt;p&gt;Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out &lt;a href=&quot;https://pulumi.com&quot;&gt;pulumi.com&lt;/a&gt; if you still need to become familiar with it. You can deploy this demo stack using the Pulumi button below.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-ec2-cloudwatch-prometheus-autoscaling&quot;&gt;&lt;img src=&quot;https://get.pulumi.com/new/button.svg&quot; alt=&quot;Deploy&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;You may find the source code for this demo in &lt;a href=&quot;https://github.com/svodwood/pulumi-ec2-cloudwatch-prometheus-autoscaling&quot;&gt;this Github repo&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;What We Are Going To Build&lt;/h2&gt;
&lt;p&gt;We will create a pair of identical EC2 instances running in an EC2 Autoscaling Group behind a public Application Load Balancer, each running a demo web workload and exposing node-exporter and web-server metrics. Next, AWS Cloudwatch agent will scrape the metrics and publish them to Cloudwatch. Finally, a Target Tracking Scaling Policy will govern autoscaling decisions based on a customized metric specification.&lt;/p&gt;
&lt;p&gt;To start building, we are going to need to meet the prerequisites:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;An AWS account with a named AWS CLI profile configured.&lt;/li&gt;
&lt;li&gt;A working Pulumi environment.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Basic Infrastructure&lt;/h2&gt;
&lt;p&gt;First, we will construct a VPC consisting of a pair of public subnets and a pair of private subnets:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
vpc.py
&quot;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Create a VPC and Internet Gateway:&lt;/span&gt;
demo_vpc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Vpc&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-vpc&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    cidr_block&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc_cidr&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    enable_dns_hostnames&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    enable_dns_support&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-vpc-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;config&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;region&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

demo_igw &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InternetGateway&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-igw&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-igw-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;config&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;region&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Create a default any-any security group for demo purposes:&lt;/span&gt;
demo_sg &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SecurityGroup&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-security-group&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    description&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Allow any-any&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    ingress&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SecurityGroupIngressArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        description&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Any&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        from_port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        to_port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        protocol&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;-1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        cidr_blocks&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0.0.0.0/0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        ipv6_cidr_blocks&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;::/0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    egress&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;SecurityGroupEgressArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        from_port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        to_port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        protocol&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;-1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        cidr_blocks&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0.0.0.0/0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        ipv6_cidr_blocks&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;::/0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-sg-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;config&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;region&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Create subnets:&lt;/span&gt;
demo_azs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; get_availability_zones&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;available&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;names
demo_public_subnets &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
demo_private_subnets &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    prefix &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;demo_azs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
    
    demo_public_subnet &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Subnet&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-public-subnet-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        cidr_block&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnet_cidrs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        availability_zone&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_azs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-public-subnet-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    demo_public_subnets&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;demo_public_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    demo_public_route_table &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;RouteTable&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-public-rt-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-spoke-rt-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    demo_public_route_table_association &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;RouteTableAssociation&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-public-rt-association-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        route_table_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_route_table&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        subnet_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    demo_public_wan_route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-public-wan-route-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        route_table_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_route_table&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        gateway_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_igw&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        destination_cidr_block&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0.0.0.0/0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    demo_eip &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Eip&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-eip-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-eip-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    demo_nat_gateway &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;NatGateway&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-nat-gateway-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        allocation_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_eip&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        subnet_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-nat-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;depends_on&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    demo_private_subnet &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Subnet&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-private-subnet-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        cidr_block&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_subnet_cidrs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        availability_zone&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_azs&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-private-subnet-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    demo_private_subnets&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;demo_private_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    demo_private_route_table &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;RouteTable&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-private-rt-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-private-rt-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    demo_private_route_table_association &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;RouteTableAssociation&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-private-rt-association-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        route_table_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_route_table&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        subnet_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_subnet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    demo_private_wan_route &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ec2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Route&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;demo-private-wan-route-&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;prefix&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        route_table_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_route_table&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        nat_gateway_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_nat_gateway&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        destination_cidr_block&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0.0.0.0/0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_private_subnet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Second, let’s create an Application Load Balancer, a Target Group and Listener:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
alb.py
&quot;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Create a load balancer:&lt;/span&gt;
demo_alb &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LoadBalancer&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-alb&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    internal&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    load_balancer_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;application&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    security_groups&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;demo_sg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    subnets&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_public_subnets&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    enable_deletion_protection&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;demo-alb&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Create a target group:&lt;/span&gt;
demo_target_group &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TargetGroup&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-target-group&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    protocol&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;HTTP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    vpc_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_vpc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;demo-alb&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    health_check&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;lb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TargetGroupHealthCheckArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        enabled&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        healthy_threshold&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        interval&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        protocol&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;HTTP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;80&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_alb&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Create a listener:&lt;/span&gt;
demo_listener &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Listener&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-listener&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    load_balancer_arn&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_alb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;arn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    protocol&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;HTTP&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    default_actions&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;lb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ListenerDefaultActionArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token builtin&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;forward&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        target_group_arn&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_target_group&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;arn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    opts&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;pulumi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ResourceOptions&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_alb&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With our basic infrastructure completed, we can continue configuring our EC2 web server, which will host all our custom configurations.&lt;/p&gt;
&lt;h2&gt;Nginx, Node Exporter, Nginx Prometheus Exporter, Cloudwatch Agent - Oh My!&lt;/h2&gt;
&lt;p&gt;The stack extensively uses AWS SSM Parameter Store, where we push all relevant configuration parameters. As a result, an Amazon Linux 2 instance configuration using user data during boot is effortless - it is simply a matter of fetching the correct parameter with AWS CLI:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;aws ssm get-parameter &lt;span class=&quot;token parameter variable&quot;&gt;--name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; cwa_prometheus_parameter_path &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--region&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; region &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; --with-decryption &lt;span class=&quot;token parameter variable&quot;&gt;--output&lt;/span&gt; text &lt;span class=&quot;token parameter variable&quot;&gt;--query&lt;/span&gt; Parameter.Value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /opt/aws/amazon-cloudwatch-agent/etc/prometheus.yml&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;AWS SSM Parameter Store is also one of the easiest ways to configure AWS Cloudwatch agent natively, but we will get to this later. Onwards!&lt;/p&gt;
&lt;p&gt;Our primary web server workload will be represented by an Nginx server, exposing a default page over port 80 and emulating a workload application. We will use Amazon Linux 2 x86_64 as our OS. On the observability layer, we will install Node Exporter to expose OS-level metrics and Nginx Prometheus Exporter to query the Nginx stub_status endpoint and convert this information into a Prometheus-compatible set of metrics. Both will run on every EC2 instance in the Autoscaling Group as system processes.&lt;/p&gt;
&lt;p&gt;Let’s take care of enabling the stub_status Nginx module:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
nginx_config.py
&quot;&quot;&quot;&lt;/span&gt;
demo_nginx_stub_status_configuration_file &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Template&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
server {
        listen 127.0.0.1:{{ port }};
        location = /metrics {
                stub_status;
        }
}
&quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
demo_nginx_stub_status_configuration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; demo_nginx_stub_status_configuration_file&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;render&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;port&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;nginx_stub_status_port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

demo_nginx_configuration_parameter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ssm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Parameter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-nginx-config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token builtin&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;String&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    data_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;text&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;nginx_stub_status_config_parameter_path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;demo-nginx-config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_nginx_stub_status_configuration
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, let’s define our Cloudwatch agent configuration:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
cwa.py
&quot;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Cloudwatch Agent configuration, written to SSM parameter store:&lt;/span&gt;
demo_cwa_configuration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dumps&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;agent&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;metrics_collection_interval&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;logs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;metrics_collected&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token string&quot;&gt;&quot;prometheus&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;cluster_name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;log_group_name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Prometheus&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;prometheus_config_path&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/opt/aws/amazon-cloudwatch-agent/etc/prometheus.yml&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;emf_processor&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
					&lt;span class=&quot;token string&quot;&gt;&quot;metric_declaration_dedup&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
					&lt;span class=&quot;token string&quot;&gt;&quot;metric_namespace&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;_Prometheus&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
					&lt;span class=&quot;token string&quot;&gt;&quot;metric_unit&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
						&lt;span class=&quot;token string&quot;&gt;&quot;node_sockstat_TCP_inuse&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Count&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
						&lt;span class=&quot;token string&quot;&gt;&quot;nginx_connections_waiting&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Count&quot;&lt;/span&gt;
					&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
					&lt;span class=&quot;token string&quot;&gt;&quot;metric_declaration&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
						&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;source_labels&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
								&lt;span class=&quot;token string&quot;&gt;&quot;origin&quot;&lt;/span&gt;
							&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;label_matcher&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;^web-server-node-exporter$&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;dimensions&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
									&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
									&lt;span class=&quot;token string&quot;&gt;&quot;node&quot;&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
									&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
							&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;metric_selectors&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
								&lt;span class=&quot;token string&quot;&gt;&quot;^node_sockstat_TCP_inuse$&quot;&lt;/span&gt;
							&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
						&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
						&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;source_labels&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
								&lt;span class=&quot;token string&quot;&gt;&quot;origin&quot;&lt;/span&gt;
							&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;label_matcher&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;^web-server-nginx$&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;dimensions&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
									&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
									&lt;span class=&quot;token string&quot;&gt;&quot;node&quot;&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
									&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;
								&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
							&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
							&lt;span class=&quot;token string&quot;&gt;&quot;metric_selectors&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
								&lt;span class=&quot;token string&quot;&gt;&quot;^nginx_connections_waiting$&quot;&lt;/span&gt;
							&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
						&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
					&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
				&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;metrics&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;namespace&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;_Memory&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;append_dimensions&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;${aws:AutoScalingGroupName}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token string&quot;&gt;&quot;node&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;${aws:InstanceId}&quot;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;aggregation_dimensions&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;metrics_collected&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token string&quot;&gt;&quot;mem&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;measurement&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
					&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
						&lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;mem_used_percent&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
						&lt;span class=&quot;token string&quot;&gt;&quot;rename&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;MemoryUtilization&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
						&lt;span class=&quot;token string&quot;&gt;&quot;unit&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Percent&quot;&lt;/span&gt;
					&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
				&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;token string&quot;&gt;&quot;metrics_collection_interval&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

demo_ssm_cwa_configuration_parameter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ssm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Parameter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-cwa-config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token builtin&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;String&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    data_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;text&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;cwa_settings_parameter_path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;demo-cwa-config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_cwa_configuration
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Cloudwatch Agent prometheus scrape configuration, written to SSM parameter store:&lt;/span&gt;
demo_prometheus_configuration_template &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Template&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
global:
  scrape_interval: 1m
  scrape_timeout: 10s
scrape_configs:
  - job_name: Local_NodeExporter_Metrics
    static_configs:
      - targets:
          - &apos;localhost:9100&apos;
        labels:
          origin: web-server-node-exporter
          AutoScalingGroupName: {{autoscaling_group_name}}
  - job_name: Local_Nginx_Metrics
    static_configs:
      - targets:
          - &apos;localhost:9113&apos;
        labels:
          origin: web-server-nginx
          AutoScalingGroupName: {{autoscaling_group_name}}
&quot;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

demo_prometheus_configuration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; demo_prometheus_configuration_template&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;render&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;autoscaling_group_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

demo_ssm_cwa_promscrape_configuration_parameter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ssm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Parameter&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-cwa-prom-config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token builtin&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;String&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    data_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;text&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;cwa_prometheus_parameter_path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;demo-cwa-prom-config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_prometheus_configuration
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Create a CloudWatch log group for the prometheus metrics:&lt;/span&gt;
demo_prom_loggroup &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cloudwatch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LogGroup&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-cwa-log-group&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Prometheus&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	retention_in_days&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;demo-cwa-log-group&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Several noteworthy things happened here. First, we set up the Cloudwatch agent for Prometheus metrics collection. Cloudwatch agent supports standard Prometheus scrape configurations. For example, we are interested in scraping a Node Exporter endpoint on port 9100 and an Nginx Prometheus Exporter endpoint on port 9113. Both jobs will append an “AutoScalingGroupName” tag to the metrics. Second, we configure the &lt;code class=&quot;language-text&quot;&gt;{&quot;logs&quot;:{&quot;metrics_collected&quot;:{&quot;prometheus&quot;:{}}}}&lt;/code&gt; stanza to only include “node_sockstat_TCP_inuse” and “nginx_connections_waiting” in our aggregations since, in this case, we are confident we can make autoscaling decisions based on these metrics alone. Notice that we will aggregate both metrics by “AutoScalingGroupName”. Finally, to top it off, let’s add the built-in memory reporting inside the &lt;code class=&quot;language-text&quot;&gt;{&quot;metrics&quot;:{&quot;metrics_collected&quot;:{&quot;mem&quot;:{}}}}&lt;/code&gt; stanza - it’s always nice to stay on top of our memory utilization.&lt;/p&gt;
&lt;p&gt;With our Cloudwatch agent configuration sorted, let’s move on to our EC2 user data.&lt;/p&gt;
&lt;h2&gt;Configuring the Instance at Boot&lt;/h2&gt;
&lt;p&gt;A straightforward way to do this is via a bash script:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;
yum update &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Install CWA&lt;/span&gt;
yum &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; amazon-cloudwatch-agent &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Install Nginx and configure the stub status module&lt;/span&gt;
amazon-linux-extras &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; nginx1.12 &lt;span class=&quot;token parameter variable&quot;&gt;-y&lt;/span&gt; 
aws ssm get-parameter &lt;span class=&quot;token parameter variable&quot;&gt;--name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; nginx_stub_status_config_parameter_path &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--region&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; region &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--output&lt;/span&gt; text &lt;span class=&quot;token parameter variable&quot;&gt;--query&lt;/span&gt; Parameter.Value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; nginx_config_file_path &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Add a user to run the exporters&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;useradd&lt;/span&gt; --no-create-home metrics_exporter

&lt;span class=&quot;token comment&quot;&gt;# Install Node Exporter&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;wget&lt;/span&gt; https://github.com/prometheus/node_exporter/releases/download/v1.4.0/node_exporter-1.4.0.linux-amd64.tar.gz
&lt;span class=&quot;token function&quot;&gt;tar&lt;/span&gt; xzf node_exporter-1.4.0.linux-amd64.tar.gz
&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; node_exporter-1.4.0.linux-amd64/node_exporter /usr/local/bin/node_exporter
&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-rf&lt;/span&gt; node_exporter-1.4.0.linux-amd64.tar.gz node_exporter-1.4.0.linux-amd64

&lt;span class=&quot;token comment&quot;&gt;# Create Node Exporter systemd service&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;EOF&apos;&lt;span class=&quot;token bash punctuation&quot;&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /etc/systemd/system/node-exporter.service&lt;/span&gt;
[Unit]
Description=Prometheus Node Exporter Service
After=network.target
[Service]
User=metrics_exporter
Group=metrics_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter
[Install]
WantedBy=multi-user.target
EOF&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Install Nginx Exporter&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;wget&lt;/span&gt; https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.11.0/nginx-prometheus-exporter_0.11.0_linux_amd64.tar.gz
&lt;span class=&quot;token function&quot;&gt;tar&lt;/span&gt; xzf nginx-prometheus-exporter_0.11.0_linux_amd64.tar.gz
&lt;span class=&quot;token function&quot;&gt;cp&lt;/span&gt; nginx-prometheus-exporter /usr/local/bin/nginx-prometheus-exporter
&lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-rf&lt;/span&gt; nginx-prometheus-exporter_0.11.0_linux_amd64.tar.gz nginx-prometheus-exporter

&lt;span class=&quot;token comment&quot;&gt;# Create Nginx Exporter systemd service&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;EOF&apos;&lt;span class=&quot;token bash punctuation&quot;&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /etc/systemd/system/nginx-prometheus-exporter.service&lt;/span&gt;
[Unit]
Description=Prometheus Nginx Exporter Service
After=network.target
[Service]
User=metrics_exporter
Group=metrics_exporter
Type=simple
ExecStart=/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri http://127.0.0.1:{{ nginx_stub_status_port }}/metrics -web.listen-address=127.0.0.1:9113
[Install]
WantedBy=multi-user.target
EOF&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Configure CWA&lt;/span&gt;
aws ssm get-parameter &lt;span class=&quot;token parameter variable&quot;&gt;--name&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; cwa_prometheus_parameter_path &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--region&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; region &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; --with-decryption &lt;span class=&quot;token parameter variable&quot;&gt;--output&lt;/span&gt; text &lt;span class=&quot;token parameter variable&quot;&gt;--query&lt;/span&gt; Parameter.Value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; /opt/aws/amazon-cloudwatch-agent/etc/prometheus.yml
/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl &lt;span class=&quot;token parameter variable&quot;&gt;-a&lt;/span&gt; fetch-config &lt;span class=&quot;token parameter variable&quot;&gt;-m&lt;/span&gt; ec2 &lt;span class=&quot;token parameter variable&quot;&gt;-c&lt;/span&gt; ssm:&lt;span class=&quot;token string&quot;&gt;&quot;{{ cwa_settings_parameter_path }}&quot;&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;-s&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# Start everything up&lt;/span&gt;
systemctl daemon-reload
systemctl &lt;span class=&quot;token builtin class-name&quot;&gt;enable&lt;/span&gt; nginx
systemctl start nginx
systemctl &lt;span class=&quot;token builtin class-name&quot;&gt;enable&lt;/span&gt; node-exporter
systemctl start node-exporter
systemctl &lt;span class=&quot;token builtin class-name&quot;&gt;enable&lt;/span&gt; nginx-prometheus-exporter
systemctl start nginx-prometheus-exporter&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here is where we make use of our SSM Parameter Store parameters. Querying is made possible by attaching several managed IAM policies to the instance profile. AWS CLI is available out of the box on an Amazon Linux 2 AMI.&lt;/p&gt;
&lt;h2&gt;Houston, we have worming!&lt;/h2&gt;
&lt;p&gt;Generate some continuous GET requests to the Application Load Balancer public DNS  name, and after a while, we should see some squiggly lines appear in Cloudwatch.&lt;/p&gt;
&lt;h5&gt;Custom Namespaces:&lt;/h5&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/f213e/cw-namespaces.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 24.68354430379747%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAvklEQVQY03WQyW7DMAxE/f8/2EuRphtqwIuSVCYtLppWMnso0h4ewBEHgxEHZsaaEqZpwjzPGMcROWegVrgb3AwWNF3dg9/6xzOICDbekT7p4JaxcQGLddQc3sMdYg4q1mm7ogaSA2vB1TGYKRIpzivjtBBeLzveLzteVsZbYuRiva2o4WHMeJw2nGbCeSF8XHc8r4SnhVA0AlvDNgD1oAaha7RTVdxYuv7L5/HtHtjMIoHe0/bHjeLtP9934BeH9ocIlUVpsgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Cloudwatch Custom Namespaces&quot;
        title=&quot;Cloudwatch Custom Namespaces&quot;
        src=&quot;/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/f058b/cw-namespaces.png&quot;
        srcset=&quot;/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/c26ae/cw-namespaces.png 158w,
/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/6bdcf/cw-namespaces.png 315w,
/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/f058b/cw-namespaces.png 630w,
/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/40601/cw-namespaces.png 945w,
/devops-pastebin/static/2b478e3deb79eaede68c91df2009018a/f213e/cw-namespaces.png 1192w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h5&gt;Nginx Metric:&lt;/h5&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/dc0c1/nginx-metric.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 49.36708860759494%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABb0lEQVQoz32RiU7kMBBE8/+fiNCyMLcTx1fb3T4yhewJCwi0kZ5c6bQrdtf09HrC899XzMsCHwKc99+wgUb9K9oY6NUgEMFYh5uasWgNva6YYoxIKaGUglLrYx3Un7Wua4XkjJwzaq3IpYBZRk0kY2Jm/O+533/Xbbv/2j9RjOimIjL+2k+Sc0GSgsgySJwRd7qmJGDJ30++64k4wwVCCGEYb9uGWhtqa6Oxtcc1+9W6rvvmVh/6K8MwmAXeGazWjmA667qOAffh98F/BPQRSthXYy3UvIyA1DxjNRbT4e0Nh+MJPiZ4IlhPcBQROoHQR5KYBzGlf7DISPhyvQ2jq9oNvXNQaoYP3SjBEsNFHslFIlAISDGCiCDCA+aELILSk2VGzjLe+7fp4iL+nG94PpxxswE+Vzj5xJcG5SJezgpnbXE1HiZlWC4PpI61964pY9JRcFQap1mDSkOs2ydlQ6p3OM44qmVw0fZn306vvwNUagY6yFgK/QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Nginx Metric&quot;
        title=&quot;Nginx Metric&quot;
        src=&quot;/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/f058b/nginx-metric.png&quot;
        srcset=&quot;/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/c26ae/nginx-metric.png 158w,
/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/6bdcf/nginx-metric.png 315w,
/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/f058b/nginx-metric.png 630w,
/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/40601/nginx-metric.png 945w,
/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/78612/nginx-metric.png 1260w,
/devops-pastebin/static/c4668c7aee671a0d77ca12b7ec30dbe9/dc0c1/nginx-metric.png 2348w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h5&gt;Node Exporter Metric:&lt;/h5&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/dc0c1/node-exporter-metric.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 49.36708860759494%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABhElEQVQoz4WSS27cMAyGdf8TFL1CDlCgm6L7btLs2gnymM54LEuWbL1lyX9AJXaSIkUJfKAoiDTNn+zXwwmH+wcMQmA2BtM872jyxmLNATUHzNZCTxPEOEKOCsZacCFabsclBiHBvHfw3iPnjLwsr+RnX8qCLz9P+HrzB2XJSDkjxoSUEpZlQYyx4WNCiBGsris+su3+6scRn779xvXdBVIp/M9YKaUd1nXd2WKyz99vwaVGjQ5cSmzvPzLKYUsp74q9L7zChAQ9Wzjv26/VWv9JqQVsVgO0km3IfBjABwE5jhBStuE7Z3exSAQ6byit9/c9HzAqBXZ8fMTxdIZxHrN10MY2bwhjmyfRfAitS4JiEkDpCd2lx6j0S0ENRpcUTLOFNg7KBmhLyQHmpRPrXOuOim6Fw6ZuCM2HEBqMgr7nOJ+7llRraatCsyUBaDbOefSctx2kD9CK0co0Stk9rRS7Vx6HTuL2IjGEAhkrxBtkWtG7hMNF4NAJ3A0KIj6/+xvKfwLDtgQi3II7gwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Node Exporter Metric&quot;
        title=&quot;Node Exporter Metric&quot;
        src=&quot;/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/f058b/node-exporter-metric.png&quot;
        srcset=&quot;/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/c26ae/node-exporter-metric.png 158w,
/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/6bdcf/node-exporter-metric.png 315w,
/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/f058b/node-exporter-metric.png 630w,
/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/40601/node-exporter-metric.png 945w,
/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/78612/node-exporter-metric.png 1260w,
/devops-pastebin/static/5902535d61acd2ebdb7e103ac1fbce26/dc0c1/node-exporter-metric.png 2348w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h5&gt;High-cardinality Log Streams&lt;/h5&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/8579d/log-streams.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABpElEQVQoz61Sy27bMBDk/39Lgd4KFKjT5oEksuvU57g+9NCKkigxFJ+iHlMsLbuKziUwWHCXM7vcXba5f8LmIcO3+0d8+XqLm9sHPO/22L0ckO0P2K7wvHvB03af8Jh9T8huPiH7/AHbuw3Y6+sRp9MJeZ4nCCHQDz2GYcAw9Oj79/DeX9FqDWM04vEO8fAR4dcPsEZKqLZNAuM4JhDROpdI5F+LWusQY0xvUxzAAMDFEawoSmhjoLVGCAHjNGGaJmhtUgVEWB6KkY/sNN+ncQSmESF4MFHX1+ouBAKJG2sRQnf1XbB8t/QRh3kf8L9O6Dow68I8gBnUw8W9X/UwLmx85xvgvAdra45SCBRVhbIS+MM5RNMg5wWKsgK1RCqVBrcE9XcN8rOfx2MSMMZeA8acB0KDoYFZa+Gcg1L/xMqKkjWgLaHElajPgnUjIeVbIpFAF2NaifSl2VICekP2EqcCLonaVp+TKQXWGgsu3qBsgPEdhtXOUR+p2bwokOc8kfW8TmvQbxgJ/ZYOhXJwYVHZClJKNE0D2tuc85Rk+ZaS01D+AnEdmX+0JecEAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;High-cardinality Log Streams&quot;
        title=&quot;High-cardinality Log Streams&quot;
        src=&quot;/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/f058b/log-streams.png&quot;
        srcset=&quot;/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/c26ae/log-streams.png 158w,
/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/6bdcf/log-streams.png 315w,
/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/f058b/log-streams.png 630w,
/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/40601/log-streams.png 945w,
/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/78612/log-streams.png 1260w,
/devops-pastebin/static/93d9593b299016e8ee8359595465ac22/8579d/log-streams.png 2412w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Target Tracking Scaling Policies&lt;/h2&gt;
&lt;p&gt;Let’s imagine a hypothetical situation where we are sure that &lt;code class=&quot;language-text&quot;&gt;nginx_connections_waiting&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;node_sockstat_TCP_inuse&lt;/code&gt; should have the following average values across our instances in the autoscaling group during production operation at baseline. We are deliberately using some ridiculous values here for the sake of the demo:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;target_nginx_connections_waiting &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
target_node_sockstat_TCP_inuse &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To quote the official documentation:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;To create a target tracking scaling policy, you specify an Amazon CloudWatch metric and a target value that represents the ideal average utilization or throughput level for your application. Amazon EC2 Auto Scaling can then scale out your group (add more instances) to handle peak traffic, and scale in your group (run fewer instances) to reduce costs during periods of low utilization or throughput.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;To achieve this, we will define two Target Tracking scaling policies:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
scaling_policies.py
&quot;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Define target tracking scaling policies:&lt;/span&gt;
nginx_tracking_policy &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Policy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-nginx-tracking-policy&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    autoscaling_group_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_autoscaling_group&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    estimated_instance_warmup&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    policy_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;TargetTrackingScaling&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    target_tracking_configuration&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PolicyTargetTrackingConfigurationArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        target_value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;target_nginx_connections_waiting&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        disable_scale_in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        customized_metric_specification&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PolicyTargetTrackingConfigurationCustomizedMetricSpecificationArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            metric_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;nginx_connections_waiting&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            namespace&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;_Prometheus&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            statistic&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Average&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            unit&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Count&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            metric_dimensions&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PolicyTargetTrackingConfigurationCustomizedMetricSpecificationMetricDimensionArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                    name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

netstat_tracking_policy &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Policy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-netstat-tracking-policy&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    autoscaling_group_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_autoscaling_group&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    estimated_instance_warmup&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    policy_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;TargetTrackingScaling&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    target_tracking_configuration&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PolicyTargetTrackingConfigurationArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        target_value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;target_node_sockstat_TCP_inuse&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        disable_scale_in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        customized_metric_specification&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PolicyTargetTrackingConfigurationCustomizedMetricSpecificationArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            metric_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;node_sockstat_TCP_inuse&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            namespace&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;_Prometheus&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            statistic&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Average&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            unit&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Count&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            metric_dimensions&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                autoscaling&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PolicyTargetTrackingConfigurationCustomizedMetricSpecificationMetricDimensionArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                    name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;AutoScalingGroupName&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                    value&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;cluster_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The policies are visible in the Autoscaling Group user interface:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/2acc9/policies.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABhUlEQVQoz4VSXXOEIAzk///CPvSqV78QBEERRb3bTlLv6rUPzcwOBDYJ2SDKRuI9u+LtkiMvSmhjYXqHYRwxhoAxjMf+dX1iGA58+6KsKrxfLrh8ZLjmGWxzhVU1VNehkS1apaGNgVQKnTFo2hb2KOgp0Sk5+aJ3DkprDmiaBk1dwZqOqzrvmTSego21MLZH7zy8H54+gV9IREsHxsAYixBnbPsN27b9YF153bcNMc5cYBwDwjSh7x3oUZQwhABBOtEFIwSuQgTypxgRY8Q0xT8t+kO7eVkYcZ45RtChlBJStnDOPaufbd93bp84sm25VYqjYmdb1xXCew/ddfyKZVmwpISUEu8p4Ha74X6/c2s0lAcvHbx4dEG8bd8hnPPI8hxFUT7xWRSoqgpKKdaOEpL4WZajLKsXHv0SrfVPQtKCplvThGmta9aIkjyMyKRrXRNHHmhY87NRccFfwg/sPNpIaX0hUnL6uMQ980iz31oLmmRaV778xsYr63gE8hTj/D9vnvEFWCtMm5aE7bIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Autoscaling Policies&quot;
        title=&quot;Autoscaling Policies&quot;
        src=&quot;/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/f058b/policies.png&quot;
        srcset=&quot;/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/c26ae/policies.png 158w,
/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/6bdcf/policies.png 315w,
/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/f058b/policies.png 630w,
/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/40601/policies.png 945w,
/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/78612/policies.png 1260w,
/devops-pastebin/static/690121fec7ca1f2fb30c8fd93a781d28/2acc9/policies.png 2378w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;After several minutes of inactivity and initial data gathering, our Cloudwatch alarms have traced our idle state. The warnings now indicate that we are over-provisioned, running at minimum capacity:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/f36fd/alarms.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABu0lEQVQoz1VTW27cMAzc8/csPUDv0M+iXwGKNlsk6/Vatt4PSppiuNmkEUCQJsThzBg6PS8Gr+sN+77Dh6BhncNhrYbzXoP9R37UQesIfxi46xl+u+B0XRZsm4GIoNSK1hq8D9ozZtdeKuUO4jxCjHBvoDEGxDaQ//6E//YF7vtXnHjBWgtpDb0Lcs6IKUG6oJSK/bA6vB8HNrMrs5QSSik4jgPWOviQUGUgpIITmb0eCc8mwsSKUhukZIze0ZooIwKMMZQxrSEI5bLXpCGVCOlNZ069d7zYgt9bgs0CkQ6kiDm6DpAJo/cBTz+dU+m0Zk5AhiBUj9wS5px3wPOe8XQNSG3ohSQJPNK7yidD3qNEekuWtIan9QqX7QcgaV5cwa9bxMtR0HpHnwMTwJxDgRhkS/mUylxrVQD26Tcz4xPDNVT1bcaA+QZEdilnrbdtw7qummOM4FYy9MV+lry4qqA8urEV0kP/z0P2cym6gHL5M9UWWtQiqtQHoOCPSfjx4nA2GalV3aaXRZQJg/W63nBZFmX5YEgglw+dUcn3l+GxOw9jHZwPCCG+vwr1Lcb3F/KoP3pcmHSG3/8AWdVTxJpzGZQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Cloudwatch Alarms&quot;
        title=&quot;Cloudwatch Alarms&quot;
        src=&quot;/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/f058b/alarms.png&quot;
        srcset=&quot;/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/c26ae/alarms.png 158w,
/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/6bdcf/alarms.png 315w,
/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/f058b/alarms.png 630w,
/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/40601/alarms.png 945w,
/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/78612/alarms.png 1260w,
/devops-pastebin/static/02df1e2d00c925f84ca199b529d0070d/f36fd/alarms.png 2488w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Load Testing&lt;/h2&gt;
&lt;p&gt;Out Autoscaling Group is now at its minimum capacity of two, with eight instances of maximum allowed capacity.
Let us now test our scale-out and scale-in policies by running a basic load test with the help of Locust:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;
./load-test/locustfile.py
&quot;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; locust &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; HttpUser&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; task
            
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;HttpUser&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token decorator annotation punctuation&quot;&gt;@task&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mainPage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/36d90b1621630872f6e99ca8ccbca790/1cfc2/locust-start.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 115.18987341772151%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAAEF0lEQVQ4y62Ve0yVZRzH+csKFDmH++FyOMA5wDnvuXE4F4G4FKUNQ+4cDpIi/QElzMsmJEzEMhpam8sK3VxZaJtW1mqrVZu6oRnFQsXj4ZZykvzDdKvV2vqDT3uf4xEpdNV6tu/7/T2X9/v8nt/v97xvSJw9i/8TIfIjNidTdOId91jo+Avf9c7fBIMT0dkZKIxaIs06oiw6lGYdkZagrRW20hTg4DuLiYYExbKesFHYVISjLg9TmQN7bS6WcqeAoy6XnJpcXPX5WCtdqJz6e3soP2JsmaQWm3DW52KpcApxe10u5nKHEHd58gNcny82kEMT79CjchpQOQzCDm5wJ4YJTiOJTjMquxGVQyI+R0Jll4g0aVEa01EY04iQ0sSxY20ZRJg0hEsphEtqFOa0OyEQgpFWLdmri9nQ0U7jllaqWtbhbnuauo3NPLmhnjXNHkqb3MIua64XXNJQQZG7jJKGSuxlJcTYMgIeJjgNhGYm0vFSLz/duMH099PIbW5ujn/avhg6RYQpVRw9JMEp8VBmAl17dvPrz7/gn/Hzb9uXZ07PC8puRlm1WEuLaNjUIo5a1bqe6mea7osamVvXi/WPeMrnjyyynJOBOs+MtsiOyqFHnWch0pxGuF7N0qwkFJIGpVEj+hFSCg9o4whJiiBErRC8RBs3nxRZYLkxRXj1wWefMHjiOEc/ek/gyIeLIzB3nHdOHOP9Tz9m+54XRGIDSXFJPJihondfP3/89jv/pQ2PjogyEjGUi3OZQc26rc8yNHyOk18NcXZkmKFvv+bMvTAyfHvNOUa9Y+x78wBKSzrxCwrbJYk4ysFVmFKJydaJZEVb5TudLljuy7Yc32WSWjiyVJ8svFtQ2PJC06qHRfYeX1tFsXsNKxuredRTTomngsfWVopxeUxmeXxF5UpWVK6ioG41ltKi+SzLRw7TJ9HW08nk1BTecR/jU5OM+bxMTE1yZeYqF72XhD164TzfXTjP2GWvGJfZNz7OG4cPEZUdTMrtwu7eu5vr/mtMeH1cvzaL7+Il/Feu4p+Z4bLXy4+zs4z7fExPTePzXubWzVv84Pcz5Zvg0OBhom26gKCcGaU5jfzGcjoOvszm/X1s2d/H1oF+Nu/dxabe7Wx+vpu2HR2CN+3qEmjf2Un7zufY9mKPKPKobN3CD6zSpiPUoiHMmkqYRUOoVUOYKYUlabGoiiw89XYfNa91UTewA/fBHtwHdlD7ejfrj/ZTvK0JpfGuqyeLyilX2fULkOiSiDanY2soZeDmN3SdHKT79BF6zh6j69QgnZ+/xavXhmh59xWWZyUT7zQs/KcshpjsDJILrOS11FLY3kBhu4eCNo+wCzbWC9tYXUJ08Kbc7w8W3EjUpqRBoU8JwHAXG1KIMqffqcM/AYtdxLrhXrhRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Start Locust&quot;
        title=&quot;Start Locust&quot;
        src=&quot;/devops-pastebin/static/36d90b1621630872f6e99ca8ccbca790/f058b/locust-start.png&quot;
        srcset=&quot;/devops-pastebin/static/36d90b1621630872f6e99ca8ccbca790/c26ae/locust-start.png 158w,
/devops-pastebin/static/36d90b1621630872f6e99ca8ccbca790/6bdcf/locust-start.png 315w,
/devops-pastebin/static/36d90b1621630872f6e99ca8ccbca790/f058b/locust-start.png 630w,
/devops-pastebin/static/36d90b1621630872f6e99ca8ccbca790/1cfc2/locust-start.png 900w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Soon enough, we shall see a scale-out event:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/57f7d/scale-out.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABiUlEQVQoz21SCY6DMAzk/w/cctNAuFoIR6EgrlmNaauttEiWM2PH2BNbXddhmibUtUHbdViWBeP4RN8/5Lyu67dtK7btm9u2Tfzz+YS1LifJotM8y5mF6rpG07YwxqA2BsY057muUVWn/cWML+sKq59b7McOpWIopSThOA7EcQI/CMRcz8f1qhBGEYIgFO/5AaLoCt8PhLvd7+BnsRgLPB4D+r7HOI6Cb7c7irJEluXI8wJlWaIoTuM5z3OJF0UhHO9LwX5qse+7XDwDD8FhGMFxPTiOi8vFlo5c14NtO8L9XGzBF9uB7bjIskwasfZjk5GbpsW9qtA0jRQkpkbUhzKcOpqPr14cY8TzPP/f4TAMgqkptfFfnbFjYurpeT4c1xXO80+sdfrdIdeHfxrGUf6U5bkkJYlGojXSNPsYx4uTRHh65g3D+Orw9cpMosBvDfkQaXoW5IszrrWGimPBNJ2m4slxQulw3RYpyMWmXjIy1yZJZD1k1DASCa5KibEIea4SV4ex9yv/AkWB8FOSSd6/AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Scale-out events&quot;
        title=&quot;Scale-out events&quot;
        src=&quot;/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/f058b/scale-out.png&quot;
        srcset=&quot;/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/c26ae/scale-out.png 158w,
/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/6bdcf/scale-out.png 315w,
/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/f058b/scale-out.png 630w,
/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/40601/scale-out.png 945w,
/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/78612/scale-out.png 1260w,
/devops-pastebin/static/d3dbf806f71b597c13c1bc478eb477ab/57f7d/scale-out.png 2088w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The total number of instances is now eight:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/31df8/scale-out-instances.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 51.26582278481012%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpklEQVQozz1SC8/TMAzs//95MCRAMD7t2xBr8344cZr1UNyulU5u7Mv17Hr69fuKL5cLvl6+4fuPn3guC7S18FbD6yeCWWCshdJG4qwUrHMIMcKHAB+DvMs5BkyDpI2FMkaEhuCiNeZ/DzzvfzD/vWFRWjB4z3mBcQ7+EHQD3gvGedLa4PPzjpQyWmuCdV3BbQWvXWJb99y79uYNEBGc8zB2dz3FlDBElVJojVFKwcjlnE+klM4c5SycdMScsoha6+B9wFRrRcqE2XgEYlBlhBB2oUNscMZlKhUukvC996BCMMGg8l4fvImZEWvHVRdcVUbgF7xzIjQwLr4fah03W6F8hloWlFZwdx+oa5X6GMfEQ7116MRYYkXijkIkXxugUrBtG7btJTO11JAKI8UEXhkmK6y9YdsgMxXBUFZ8aNod1n44zIfDsNvbNhB33F2BDhlaKRQueLjb6bDtDhmlvTBHFpfUXjL40yHR0fAG7i+Y3BALI4YoDnVexOHZ8himyxU3nXA3GaE0OGvPZR371XsX8mj1YQnaJ9mKXDIe9hNUSTjj5/wHa6ICQYF2fU0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Scale-out instances&quot;
        title=&quot;Scale-out instances&quot;
        src=&quot;/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/f058b/scale-out-instances.png&quot;
        srcset=&quot;/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/c26ae/scale-out-instances.png 158w,
/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/6bdcf/scale-out-instances.png 315w,
/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/f058b/scale-out-instances.png 630w,
/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/40601/scale-out-instances.png 945w,
/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/78612/scale-out-instances.png 1260w,
/devops-pastebin/static/b485bcf097a6fada5e13164ef6161cce/31df8/scale-out-instances.png 2366w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Let’s stop the load test and wait for the scale-in event. It should take around fifteen minutes, according to the Cloudwatch alarm:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/31df8/scale-in.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 51.26582278481012%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABeUlEQVQoz3VS7XKDMAzj/R+wBdYPIBBoN0iABFooaCdz7Lbd9kMXO45l2U7QNAaZUsjzAn4YMM8zpmn6Or/j+Xz+CcZ652Bsi8C2rRjGWtB+PB5C7Lz/N/l3Meccuq5D1/UImDxNM4ZxRNM0QshEPhjHEcMwfMF7L2Cx3Ze3fQ9jDJ7TtClsjIUxFmEUS2BZFpxOZ4RRhMPhiDh+EzAeRTHCMBL/eAyRppmIKMtKzoAqXq+XyE6SFHXdYFlXaK2hdYmiKKDyHErlkkybM1dKoSi0qOUIrG2lo4Byu96h7TpJYKtUmJNI5bhcrkizTGwWTNINvKN/u92ldZ5sP2CFcXzIQM+XC6qqEkJRkikpsuN6TX74/BkUQKKPupY9BFw3SUlIAra+K2RrTOQ9IcrSTRljLHC/vwshZ8/WhdD7AX1PhVeRLoT5RriTCWGytborZ9xaK8vgvPljAjok4BwKreGcx7quUpmoqht0WQpYZAd9vqcgKiQxl/sJKaXzxdI8de4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Scale-in events&quot;
        title=&quot;Scale-in events&quot;
        src=&quot;/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/f058b/scale-in.png&quot;
        srcset=&quot;/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/c26ae/scale-in.png 158w,
/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/6bdcf/scale-in.png 315w,
/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/f058b/scale-in.png 630w,
/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/40601/scale-in.png 945w,
/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/78612/scale-in.png 1260w,
/devops-pastebin/static/92e9c810d7cc18a7708a21026d4026b3/31df8/scale-in.png 2366w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Summing It All Up&lt;/h2&gt;
&lt;p&gt;We successfully demonstrated that it is possible to effectively manage the EC2 instance capacity of an Autoscaling Group using metrics scraped from various Prometheus exporters - this means implementing autoscaling policies based on application-level metrics in a real-world production scenario.&lt;/p&gt;
&lt;h2&gt;Cleaning Up&lt;/h2&gt;
&lt;p&gt;Clean up by running &lt;code class=&quot;language-text&quot;&gt;pulumi destroy&lt;/code&gt;. Happy autoscaling!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[AWS Application Load Balancer Access Logs, Lambda-promtail and Grafana Loki]]></title><description><![CDATA[Introduction An AWS Application Load Balancer is a simple and convenient AWS construct to implement cloud-native Layer 7 load balancing. For…]]></description><link>https://gatsbystarterblogsource.gatsbyjs.io/lambda-promtail/</link><guid isPermaLink="false">https://gatsbystarterblogsource.gatsbyjs.io/lambda-promtail/</guid><pubDate>Mon, 07 Nov 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;An AWS Application Load Balancer is a simple and convenient AWS construct to implement cloud-native Layer 7 load balancing. For public-facing and private Application Load Balancers, we sometimes need to store and analyze access logs to create graphs and alerts or for general troubleshooting purposes. One of the possible ways to achieve this is by sending ALB access logs to a customer’s S3 bucket of choice. &lt;a href=&quot;https://github.com/grafana/loki/tree/main/tools/lambda-promtail&quot;&gt;Lambda-promtail&lt;/a&gt;, in turn, allows sending ALB access logs stored in S3 to a Loki endpoint.&lt;/p&gt;
&lt;p&gt;In this post, I will demonstrate the concept of collecting access log data from several S3 buckets in different spoke accounts with the help of a single lambda-promtail instance running in a hub account. A common occurrence within an enterprise hub and spoke use case is when different teams utilize separate AWS accounts and virtual networks for application delivery. We will use Grafana Cloud (free tier) to receive the data via Grafana’s managed Loki endpoint.&lt;/p&gt;
&lt;p&gt;Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out &lt;a href=&quot;https://pulumi.com&quot;&gt;pulumi.com&lt;/a&gt; if you still need to become familiar with it. You can deploy this demo stack using the Pulumi buttons below.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Keep in mind that sending data from a VPC-bound Lambda function to a public Loki endpoint will incur costs for NAT gateways and outbound data transfer.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;You may find the source code for this demo in &lt;a href=&quot;https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc&quot;&gt;this Github repo&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;What We Are Going To Build&lt;/h2&gt;
&lt;p&gt;I separated the infrastructure into two Pulumi stacks: the hub and the spoke. For simplicity’s sake, we will not use stack references here. So mind the bucket name variable present in both stacks. The value has to be the same across both stacks for everything to work as expected:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;log-bucket-name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;your_unique_bucket_name&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To start building, we are going to need to meet the prerequisites:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;One “hub” AWS account for the lambda-promtail instance.&lt;/li&gt;
&lt;li&gt;One “spoke” AWS account to host our Application Load Balancer and an S3 bucket for the logs.&lt;/li&gt;
&lt;li&gt;Two named AWS CLI profiles for the hub and for the spoke, respectively.&lt;/li&gt;
&lt;li&gt;A Grafana Cloud account with an auto-generated Loki endpoint connection string.&lt;/li&gt;
&lt;li&gt;A container image URL of lambda-promtail, uploaded to the private ECR registry of the “hub” account.&lt;/li&gt;
&lt;li&gt;A working Pulumi environment.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;An S3 bucket policy in the spoke account will use the Lambda ARN obtained from the hub account. Therefore, we will deploy the hub stack first to define the Lambda ARN without utilising stack references.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Ensure the ECR image and both accounts share the same AWS region.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;Grafana Cloud&lt;/h2&gt;
&lt;p&gt;To simplify our installation, we will use managed Loki in Grafana Cloud. Once in the Grafana UI, proceed to “Integrations and Connections”. Search for “Hosted logs” and proceed to generate the API key, selecting the option “Send logs from a standalone host”:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/74e37/grafana-datasource.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.68354430379746%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACAUlEQVQ4y5WTzW6dMBCFef4uuutbVOqm79JEvamagIF7wWBsg23+vsomyW3UpE2RjmZY+PDN+JBhL6hhQLY1U3vi7v6B090Pbr+f0MYwThPGWuw4vkuZMwOq7zlXBW15R/7zJ+e6pqxrZNcl0/eaJcPJB0ajEKdv5Lc3lDc39HVN03Wcm4ZeKbS1yfg9yrTWjJNj2XY2YAWWdWVdV+Z5wYdwyIdr/xdlXd/jvWee5zS60RprDMMwsG3R/v+eRBgN/byS14qi7hDnnryWnKWh0x5lA1IHQpjxwV+J4zkfnifato0s3qD3DjfviIuirCrqS0NVnynKkqaVWGsRjcWMLpEPWhNBlDr6aLbve6pZrwfco2HVOTrtkINDapfoUj+MiHYizNcVRIMnRbJlOSizVV8I3hHmmaYzyGFCqolWjcm86W2qvZ4YYzSsJYQQHV+YPinbRkkIxy7yIj+U5xRFgRAi1aqqEKUgLwQPeUHTtkzOHYG3FmNs+lja4aoe8G5k2/e0t0vTImVH07THwWl6HGlJusbIJznnklnsEyGDSITrupHn95SiwGiVfscY6rj4vlfEeEWi38eD/Y+dZrJzOB8SRdUYxHngLO2LWDzRxN2tjxF5TWlk0Ry4Lmx8/NLy4XPDp68SP++vBnd/4zKeCRfXpxzGl2XdCfOW6r8OvmX4C54xhuwf+disAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Grafana Loki Datasource&quot;
        title=&quot;Grafana Loki Datasource&quot;
        src=&quot;/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/f058b/grafana-datasource.png&quot;
        srcset=&quot;/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/c26ae/grafana-datasource.png 158w,
/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/6bdcf/grafana-datasource.png 315w,
/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/f058b/grafana-datasource.png 630w,
/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/40601/grafana-datasource.png 945w,
/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/78612/grafana-datasource.png 1260w,
/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/74e37/grafana-datasource.png 1732w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Hold on to the generated connection string - we will use it later to configure our lambda-promtail instance.&lt;/p&gt;
&lt;h2&gt;Hub AWS Account: Lambda-promtail&lt;/h2&gt;
&lt;p&gt;To start the deployment, click the button below or keep reading.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-hub&quot;&gt;&lt;img src=&quot;https://get.pulumi.com/new/button.svg&quot; alt=&quot;Deploy&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The hub account will host our lambda-promtail instance, which will fetch data from S3 in the spoke account. We will need a single-az VPC to run the AWS Lambda function. For the sake of simplicity, we are not going to lock into a specific availability zone id during object creation, but this ideally has to be done to minimize data transfer costs in a production environment. Although, a multi-az setup is a recommended option in a real-world scenario. Additionally, the VPC will include an S3 Interface endpoint to reach the bucket’s contents - to minimize charges for outgoing traffic from the VPC towards the internet.&lt;/p&gt;
&lt;p&gt;When the stack is up, please note Lambda’s IAM role ARN and the ARN of the function itself via stack export variables:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;lambda-promtail-role-arn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;role_arn_output&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;lambda-promtail-function-arn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;function_arn_output&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Locate the &lt;code class=&quot;language-text&quot;&gt;WRITE_ADDRESS&lt;/code&gt; environment variable in the lambda function definition (promtail_lambda.py) and run “pulumi up”. You may parametrize the connection string and convert the variable into a Pulumi secret!&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Create the Lambda function from the ECR image:&lt;/span&gt;
demo_promtail_lambda_function &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lambda_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Function&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;demo-lambda-promtail&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;lambda_promtail&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    image_uri&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_promtail_image_uri&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    role&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;demo_promtail_role&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;arn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    memory_size&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    timeout&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    architectures&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;arm64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    package_type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Image&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    vpc_config&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;lambda_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;FunctionVpcConfigArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        subnet_ids&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;demo_private_subnet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        security_group_ids&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;demo_sg&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    environment&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;lambda_&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;FunctionEnvironmentArgs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        variables&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;WRITE_ADDRESS&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; Loki connection string
            &lt;span class=&quot;token string&quot;&gt;&quot;USERNAME&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;PASSWORD&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;BEARER_TOKEN&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;KEEP_STREAM&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;BATCH_SIZE&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;EXTRA_LABELS&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;TENANT_ID&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    tags&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;general_tags&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You may find the source code for the stack in the &lt;a href=&quot;https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-hub&quot;&gt;lambda-promtail-hub&lt;/a&gt; directory of the project’s repository.&lt;/p&gt;
&lt;h2&gt;Spoke AWS Account: ALB and S3&lt;/h2&gt;
&lt;p&gt;To start the deployment, click the button below or keep reading.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-spoke&quot;&gt;&lt;img src=&quot;https://get.pulumi.com/new/button.svg&quot; alt=&quot;Deploy&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The spoke stack will emulate our random application team’s account - it will host one Application Load Balancer with a dummy target group and an S3 bucket. We will modify the default bucket policy to allow the ALB to publish logs to the bucket and for the lambda-promtail instance in the hub account to read the log data.&lt;/p&gt;
&lt;p&gt;Populate the required variables obtained from the hub account:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;lambda-promtail-role-arn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;role_arn_output&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;lambda-promtail-function-arn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;function_arn_output&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;log-bucket-name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;your_unique_bucket_name&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To allow our Application Load Balancer to write logs to S3, we need to grant the regional Load Balancing AWS account-specific permissions via a Bucket Policy. For this, we need to select a correct load balancer account id from the ones listed &lt;a href=&quot;https://docs.aws.amazon.com/elasticloadbalancing/latest/application/enable-access-logging.html#attach-bucket-policy&quot;&gt;here&lt;/a&gt;. If you are deploying the stacks in us-east-1, the default stack value will be correct out of the box. If you chose a different deployment region, replace the configuration variable with a valid id.&lt;/p&gt;
&lt;p&gt;When the stack is up, obtain the Application Load Balancer’s DNS name and open it in your browser:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/668c6/alb-response.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 25.949367088607595%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqUlEQVQY06WM3QqCQBCF9ymKXLdU6KbILqQfF6onUQoKXbXVpGdXQdgTCQlpQdCBj4Fv5gyZmxZmCwO2swbnB6w2HFt3B5fvYS8dmNYUGh1DZyYoM0D1yRsjjWEwpC1ExBIiSiFEgvMlQBDGCEWMNMsh0xuuMmvI83vjkkS27rkPwgief4Tnn5pJqrJEVZUoigJ1XeNblFL4JeRTsV9Wnceqd/+CdMW/PACr6Df6NaSMZAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Application Load Balancer Response 200&quot;
        title=&quot;Application Load Balancer Response 200&quot;
        src=&quot;/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/f058b/alb-response.png&quot;
        srcset=&quot;/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/c26ae/alb-response.png 158w,
/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/6bdcf/alb-response.png 315w,
/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/f058b/alb-response.png 630w,
/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/40601/alb-response.png 945w,
/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/78612/alb-response.png 1260w,
/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/668c6/alb-response.png 1692w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The access log should land in the S3 bucket in a few seconds. An S3 notification will trigger lambda-promtail in our hub account, forcing promtail to parse the event message, obtain the log file object’s name, fetch it and post its contents to our Loki endpoint.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/1c181/grafana-results.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABAUlEQVQoz6VS246EIBTj/z91dEDuN7GbHnTWh03MZElqOQg9LUGVWtF6R2t98j+hjuPAE/Awv7PiZ4y7wPjwGHNOHiez3sdA7/tvve+iwVrFVJBSRs4ZScA6getc+wu1NpRSUcq1NyHGyWrZMrz3iDHChwjtqszfW5HaWota52GK8c6vNHREEesctDbyX4UQRNBs24Qx0MZgXVcs64q31nDOIcQobkKI0kDE6ZCpznWy6r2DoGUfAqx1s6MxIr5ZC2kagjAPUSSXgtaapJnpgjRVr9ciDggOivNgPaN9M7hf6dMFHV5uKU5+fE6nyP1OlZcY+dOFznh/jC7P5Qvw+fwASsYPS3QZ46gAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Grafana Cloud Loki&quot;
        title=&quot;Grafana Cloud Loki&quot;
        src=&quot;/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/f058b/grafana-results.png&quot;
        srcset=&quot;/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/c26ae/grafana-results.png 158w,
/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/6bdcf/grafana-results.png 315w,
/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/f058b/grafana-results.png 630w,
/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/40601/grafana-results.png 945w,
/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/78612/grafana-results.png 1260w,
/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/1c181/grafana-results.png 2696w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;You may find the source code for the stack in the &lt;a href=&quot;https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-spoke&quot;&gt;lambda-promtail-spoke&lt;/a&gt; directory of the project’s repository.&lt;/p&gt;
&lt;h2&gt;Cleaning Up&lt;/h2&gt;
&lt;p&gt;Clean up by running &lt;code class=&quot;language-text&quot;&gt;pulumi destroy&lt;/code&gt;. Start by destroying the spoke account resources, then continue to the hub.
If the S3 bucket fails to delete, try manually removing the objects inside by running the command:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;aws s3 &lt;span class=&quot;token function&quot;&gt;rm&lt;/span&gt; s3://&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;your_unique_bucket_name&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--recursive&lt;/span&gt; &lt;span class=&quot;token parameter variable&quot;&gt;--profile&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;spoke-aws-profile&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item></channel></rss>