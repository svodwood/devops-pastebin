{"componentChunkName":"component---src-templates-blog-post-js","path":"/lambda-promtail/","result":{"data":{"site":{"siteMetadata":{"title":"Yet Another DevOps Pastebin"}},"markdownRemark":{"id":"fd3baf9f-c4a4-5569-9e45-1004d89b9e4a","excerpt":"Introduction An AWS Application Load Balancer is a simple and convenient AWS construct to implement cloud-native Layer 7 load balancing. For public-facing and…","html":"<h2>Introduction</h2>\n<p>An AWS Application Load Balancer is a simple and convenient AWS construct to implement cloud-native Layer 7 load balancing. For public-facing and private Application Load Balancers, we sometimes need to store and analyze access logs to create graphs and alerts or for general troubleshooting purposes. One of the possible ways to achieve this is by sending ALB access logs to a customer’s S3 bucket of choice. <a href=\"https://github.com/grafana/loki/tree/main/tools/lambda-promtail\">Lambda-promtail</a>, in turn, allows sending ALB access logs stored in S3 to a Loki endpoint.</p>\n<p>In this post, I will demonstrate the concept of collecting access log data from several S3 buckets in different spoke accounts with the help of a single lambda-promtail instance running in a hub account. A common occurrence within an enterprise hub and spoke use case is when different teams utilize separate AWS accounts and virtual networks for application delivery. We will use Grafana Cloud (free tier) to receive the data via Grafana’s managed Loki endpoint.</p>\n<p>Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out <a href=\"https://pulumi.com\">pulumi.com</a> if you still need to become familiar with it. You can deploy this demo stack using the Pulumi buttons below.</p>\n<blockquote>\n<p>Keep in mind that sending data from a VPC-bound Lambda function to a public Loki endpoint will incur costs for NAT gateways and outbound data transfer.</p>\n</blockquote>\n<p>You may find the source code for this demo in <a href=\"https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc\">this Github repo</a>.</p>\n<h2>What We Are Going To Build</h2>\n<p>I separated the infrastructure into two Pulumi stacks: the hub and the spoke. For simplicity’s sake, we will not use stack references here. So mind the bucket name variable present in both stacks. The value has to be the same across both stacks for everything to work as expected:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">log-bucket-name</span><span class=\"token punctuation\">:</span> &lt;your_unique_bucket_name<span class=\"token punctuation\">></span></code></pre></div>\n<p>To start building, we are going to need to meet the prerequisites:</p>\n<ol>\n<li>One “hub” AWS account for the lambda-promtail instance.</li>\n<li>One “spoke” AWS account to host our Application Load Balancer and an S3 bucket for the logs.</li>\n<li>Two named AWS CLI profiles for the hub and for the spoke, respectively.</li>\n<li>A Grafana Cloud account with an auto-generated Loki endpoint connection string.</li>\n<li>A container image URL of lambda-promtail, uploaded to the private ECR registry of the “hub” account.</li>\n<li>A working Pulumi environment.</li>\n</ol>\n<p>An S3 bucket policy in the spoke account will use the Lambda ARN obtained from the hub account. Therefore, we will deploy the hub stack first to define the Lambda ARN without utilising stack references.</p>\n<blockquote>\n<p>Ensure the ECR image and both accounts share the same AWS region.</p>\n</blockquote>\n<h2>Grafana Cloud</h2>\n<p>To simplify our installation, we will use managed Loki in Grafana Cloud. Once in the Grafana UI, proceed to “Integrations and Connections”. Search for “Hosted logs” and proceed to generate the API key, selecting the option “Send logs from a standalone host”:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/74e37/grafana-datasource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.68354430379746%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/UlEQVR42pWSWW7cMBBE5/zJDXIGHyAnCeItsLVrJJIiqY0SpReQmnEmgQE7AgrdH1R1d1WddntGdRrZlgztM08vCY/Pv3h4fML2Pf0wvNXP4DRajVKKukhpimfSl1fOdU1RVQipMNZ+muwgnB29VuSPP8ge7invf6LqmkYIzk1Dp3Uk/SxOxhjGaWLddjbAA6v3eO9Z1pXZuQ/hbnCSSsVmcQ6lJNYYrLVordn3MOL/vrjh7GYmt5JUiqyS5LUirSS1sEgzo6xDmAW3LMzzfGwWaoSL1wRs28bJ2h7nZka3k9eSoiqpzw1lVZMVJa2Q0eW8CU5Ph6bGoI2h60JvI9G+75H0pLSOG45uo5QT0kwIPSHMHLcLfdsN5O3I6i8S7ESCKwLRuq4HoTfnuOHsFs7SIvWI6IaIQN6qPlZlRoZLJoPmgfWW9IqTH0R8ME0zSZqQZilpmpJl2RvKsiTPc9IsJ0kzhBCM40iQKwwIJg7DeCHsUtw84beNoqxoWhF1a5o29mFQ0CicFHCNx9WUELmweTAnEmKK6J5fV5LkhbLMsUZHwZXqLlUR4tX3wyHhzYnX7+1kIaeon/cb+dmQ1ZpaDH+icbPNshzvrjH5FzE2eTOwLDNm9Hy5a/h61/Dtu2Tb3w/ue0b8Zco6dXH6Yf/Osm74Lebiw5/fI/wNsKuHCbL7OAoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Grafana Loki Datasource\"\n        title=\"Grafana Loki Datasource\"\n        src=\"/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/f058b/grafana-datasource.png\"\n        srcset=\"/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/c26ae/grafana-datasource.png 158w,\n/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/6bdcf/grafana-datasource.png 315w,\n/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/f058b/grafana-datasource.png 630w,\n/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/40601/grafana-datasource.png 945w,\n/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/78612/grafana-datasource.png 1260w,\n/devops-pastebin/static/da8aa5d3f4e1b6536197ffc851486b6f/74e37/grafana-datasource.png 1732w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Hold on to the generated connection string - we will use it later to configure our lambda-promtail instance.</p>\n<h2>Hub AWS Account: Lambda-promtail</h2>\n<p>To start the deployment, click the button below or keep reading.</p>\n<p><a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-hub\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<p>The hub account will host our lambda-promtail instance, which will fetch data from S3 in the spoke account. We will need a single-az VPC to run the AWS Lambda function. For the sake of simplicity, we are not going to lock into a specific availability zone id during object creation, but this ideally has to be done to minimize data transfer costs in a production environment. Although, a multi-az setup is a recommended option in a real-world scenario. Additionally, the VPC will include an S3 Interface endpoint to reach the bucket’s contents - to minimize charges for outgoing traffic from the VPC towards the internet.</p>\n<p>When the stack is up, please note Lambda’s IAM role ARN and the ARN of the function itself via stack export variables:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">lambda-promtail-role-arn</span><span class=\"token punctuation\">:</span> &lt;role_arn_output<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">lambda-promtail-function-arn</span><span class=\"token punctuation\">:</span> &lt;function_arn_output<span class=\"token punctuation\">></span></code></pre></div>\n<p>Locate the <code class=\"language-text\">WRITE_ADDRESS</code> environment variable in the lambda function definition (promtail_lambda.py) and run “pulumi up”. You may parametrize the connection string and convert the variable into a Pulumi secret!</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Create the Lambda function from the ECR image:</span>\ndemo_promtail_lambda_function <span class=\"token operator\">=</span> lambda_<span class=\"token punctuation\">.</span>Function<span class=\"token punctuation\">(</span><span class=\"token string\">\"demo-lambda-promtail\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"lambda_promtail\"</span><span class=\"token punctuation\">,</span>\n    image_uri<span class=\"token operator\">=</span>demo_promtail_image_uri<span class=\"token punctuation\">,</span>\n    role<span class=\"token operator\">=</span>demo_promtail_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    memory_size<span class=\"token operator\">=</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span>\n    timeout<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n    architectures<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"arm64\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    package_type<span class=\"token operator\">=</span><span class=\"token string\">\"Image\"</span><span class=\"token punctuation\">,</span>\n    vpc_config<span class=\"token operator\">=</span>lambda_<span class=\"token punctuation\">.</span>FunctionVpcConfigArgs<span class=\"token punctuation\">(</span>\n        subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_private_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        security_group_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    environment<span class=\"token operator\">=</span>lambda_<span class=\"token punctuation\">.</span>FunctionEnvironmentArgs<span class=\"token punctuation\">(</span>\n        variables<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"WRITE_ADDRESS\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span> Loki connection string\n            <span class=\"token string\">\"USERNAME\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"PASSWORD\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"BEARER_TOKEN\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"KEEP_STREAM\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"BATCH_SIZE\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"EXTRA_LABELS\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"TENANT_ID\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>general_tags<span class=\"token punctuation\">)</span></code></pre></div>\n<p>You may find the source code for the stack in the <a href=\"https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-hub\">lambda-promtail-hub</a> directory of the project’s repository.</p>\n<h2>Spoke AWS Account: ALB and S3</h2>\n<p>To start the deployment, click the button below or keep reading.</p>\n<p><a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-spoke\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<p>The spoke stack will emulate our random application team’s account - it will host one Application Load Balancer with a dummy target group and an S3 bucket. We will modify the default bucket policy to allow the ALB to publish logs to the bucket and for the lambda-promtail instance in the hub account to read the log data.</p>\n<p>Populate the required variables obtained from the hub account:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">lambda-promtail-role-arn</span><span class=\"token punctuation\">:</span> &lt;role_arn_output<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">lambda-promtail-function-arn</span><span class=\"token punctuation\">:</span> &lt;function_arn_output<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">log-bucket-name</span><span class=\"token punctuation\">:</span> &lt;your_unique_bucket_name<span class=\"token punctuation\">></span></code></pre></div>\n<p>To allow our Application Load Balancer to write logs to S3, we need to grant the regional Load Balancing AWS account-specific permissions via a Bucket Policy. For this, we need to select a correct load balancer account id from the ones listed <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/enable-access-logging.html#attach-bucket-policy\">here</a>. If you are deploying the stacks in us-east-1, the default stack value will be correct out of the box. If you chose a different deployment region, replace the configuration variable with a valid id.</p>\n<p>When the stack is up, obtain the Application Load Balancer’s DNS name and open it in your browser:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/668c6/alb-response.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.949367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAm0lEQVR42q2MXQuCMBiF9yMsMk3TLgKLCGNG/ayGUVsLnSb95zVPuD7oPl94eM45Fy9J4hjzJMIqpaDZHulmC5rtbF4s1winM4y9AJMggueHNnf+MHJ9OAMXzvAFEbKAlAqcSxxPHGcuIS5XKFWjLCuUbzfNHaq6oSjUd1dVDSEkDiwHY7k1MeaBDq01+jjyW9q2hTHmL0j3pE+eP508GCOIkfQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Application Load Balancer Response 200\"\n        title=\"Application Load Balancer Response 200\"\n        src=\"/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/f058b/alb-response.png\"\n        srcset=\"/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/c26ae/alb-response.png 158w,\n/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/6bdcf/alb-response.png 315w,\n/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/f058b/alb-response.png 630w,\n/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/40601/alb-response.png 945w,\n/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/78612/alb-response.png 1260w,\n/devops-pastebin/static/776e71f7c1cd0961db0389a782adec2d/668c6/alb-response.png 1692w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The access log should land in the S3 bucket in a few seconds. An S3 notification will trigger lambda-promtail in our hub account, forcing promtail to parse the event message, obtain the log file object’s name, fetch it and post its contents to our Loki endpoint.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/1c181/grafana-results.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABCUlEQVR42q1Sa28EIQj0///UbtcnqLveOc2wj7b36ZqUZAKI4AC6bduwj/FvcKDMaZimcdow284uOe153X3NBeBoPJ/PG3O+6t9x4vF4YIxxx+lfMSfaUWtFaw21Nmg9fDHd7thPbPsOjqr3Dq0VqgoRtbvuMzaUUswpovB5swtr6uanlO7k1rrZ82yTjJiXc0YIEaoVjsm5FDsIIcB7j9V7LMtiWFePlDJE5GQiVpzsWz+6IctSxNg7bobzsDZF7bWcC0KMiDEi5XwUUjVdz7ZZdN93yztyxWLu42MxBkyk8IEi8t3an2TC+RBsTmxhjGN7LE59fY93YVtmG6R/CZlxhlzU63d5B19Y3Q9r0Wz5ugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Grafana Cloud Loki\"\n        title=\"Grafana Cloud Loki\"\n        src=\"/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/f058b/grafana-results.png\"\n        srcset=\"/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/c26ae/grafana-results.png 158w,\n/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/6bdcf/grafana-results.png 315w,\n/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/f058b/grafana-results.png 630w,\n/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/40601/grafana-results.png 945w,\n/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/78612/grafana-results.png 1260w,\n/devops-pastebin/static/6d4c9a22faafc900a1543720e7e7c8d9/1c181/grafana-results.png 2696w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>You may find the source code for the stack in the <a href=\"https://github.com/svodwood/pulumi-lambda-promtail-aws-multiacc/tree/main/lambda-promtail-spoke\">lambda-promtail-spoke</a> directory of the project’s repository.</p>\n<h2>Cleaning Up</h2>\n<p>Clean up by running <code class=\"language-text\">pulumi destroy</code>. Start by destroying the spoke account resources, then continue to the hub.\nIf the S3 bucket fails to delete, try manually removing the objects inside by running the command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws s3 <span class=\"token function\">rm</span> s3://<span class=\"token operator\">&lt;</span>your_unique_bucket_name<span class=\"token operator\">></span> <span class=\"token parameter variable\">--recursive</span> <span class=\"token parameter variable\">--profile</span> <span class=\"token operator\">&lt;</span>spoke-aws-profile<span class=\"token operator\">></span></code></pre></div>","frontmatter":{"title":"AWS Application Load Balancer Access Logs, Lambda-promtail and Grafana Loki","date":"November 07, 2022","description":"Collecting AWS Application Load Balancer access logs from several spoke AWS accounts into Grafana Cloud Loki using a lambda-promtail instance."}},"previous":null,"next":{"fields":{"slug":"/ec2-autoscaling-groups-prometheus-metrics/"},"frontmatter":{"title":"AWS EC2 Auto Scaling, Target Tracking Policies and Prometheus Exporters"}}},"pageContext":{"id":"fd3baf9f-c4a4-5569-9e45-1004d89b9e4a","previousPostId":null,"nextPostId":"cfbe8729-5f29-5754-95f7-4837e543d14c"}},"staticQueryHashes":["4135132960","805692932"],"slicesMap":{}}