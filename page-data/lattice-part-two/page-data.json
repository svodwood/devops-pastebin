{"componentChunkName":"component---src-templates-blog-post-js","path":"/lattice-part-two/","result":{"data":{"site":{"siteMetadata":{"title":"Yet Another DevOps Pastebin"}},"markdownRemark":{"id":"e8cb3abb-dd79-5151-ad5e-6ad4f9632e9a","excerpt":"Introduction In Part 1 of the series, we looked at some of the benefits and drawbacks of VPC Lattice and theorized on possible use cases where this managed…","html":"<h2>Introduction</h2>\n<p>In Part 1 of the series, we looked at some of the benefits and drawbacks of VPC Lattice and theorized on possible use cases where this managed service might be helpful. We also discussed a “shared service” scenario, where some individual applications may desire access to a shared service while belonging to entirely separate networks. This pattern might present itself with a commonly shared HTTP endpoint - for example, for token generation and validation, tied to a shared encryption infrastructure. While not straightforward, utilizing VPC Lattice to support this topology is possible. Let’s now dive deeper and construct a functional multi-account and multi-VPC mini-landing zone - utilizing VPC Lattice as an application layer network.</p>\n<p>Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out pulumi.com if you still need to become familiar with it. You can deploy these demo stacks using the Pulumi buttons below.</p>\n<p>You may find the source code for this demo in <a href=\"https://github.com/svodwood/vpc-lattice-lab-1\">this Github repo</a>.</p>\n<blockquote>\n<p>Disclaimer #1: in the Pulumi stacks, we use two AWS providers: aws and aws-native, which need separate configurations, e.g., AWS CLI profile name and region. The latter is the only option to work with Lattice from Pulumi. I cannot currently recommend the aws-native provider for production use.</p>\n</blockquote>\n<blockquote>\n<p>Disclaimer #2: at the time of writing, some requests to VPC Lattice API return 429. AWS is still throttling requests to the service, although this may be related to your account status. Run “pulumi up” one more time if you experience this.</p>\n</blockquote>\n<h2>What We Are Going To Build</h2>\n<p>Our focus today is on our hypothetical company’s three microservices:</p>\n<ol>\n<li>DirectoryService. A shared microservice.</li>\n<li>BlueService. A standalone microservice.</li>\n<li>GreenService. A standalone microservice.</li>\n</ol>\n<p>Separate development teams own the BlueService and the GreenService, respectively - each team has an isolated AWS account where they develop their microservices. An independent team maintains the third application (DirectoryService) and controls access to the application. This application runs in the third isolated AWS account.</p>\n<p>Our network isolation requirements define that the GreenService must not be in the same network as the BlueService. Both services, however, need to perform HTTP GET requests to the DirectoryService - using dedicated query strings.</p>\n<p>Below is the high-level diagram of the landing zone topology and network isolation requirements:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/d93d9/LatticeSharedServiceDiagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 136.0759493670886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGA0lEQVR42nVVCVAURxT9PbNz7M4e7HIth4CQoCAYLcASUVm0YkBABQlSEogk3kKColYUg0cMRg5LUTRRKQVEVPAoSYQyFUEglwoiisqtEYMxKldABaVTPbuLhCRd1Tv9+7//+vc/euFpRuiMXz/T2WKMQcbSZhQCDYA4lQDAUQg4XL4N8Nl4eJweNKlwqZcaACgpQ5sjGMLKCRYAJJAaMtaiPmm6SXvyjHEAgHYsnMJYK1kKAGgEQNEIGLmMZwi4dnuwU8O2mdpHyX4uAAA7I70ZEx5RIhEA+crIPr0+0E3ZnhroSRQYnyZ7jMDSLABIid7FwYHzGjOaw51pkBw6Xt2eFuhBCDD+jmBZlkYES6YAahkjEIKWlLkwmLfEou9wZBbeO53f6u8ASg6x4xxHsyQcZIRNGUeuxTSlzIOB3I/t+w5HHsRrgIr3EsBczhIvFQQns1ExbLwNwP0VKqEzVTcfr+fp3HAbeOctB56Q1Z3Mn1Sdm+1K1tNcHPjdvggexlupOlJ1IdgDAKeYAS9BEkMsQWautWV3n6iA81VPzM7VvQoob3ghpB0tAc/xE0TCO6dOeF/PzXYja68JnnzqsVI4X9OpLboz6F/Z+JIvqGgBldqMGSKcPNWPv1BxG8pr2nwuXW3qrqhtdyoqqwVHZ1fe2d6OAf2g7LRaZpKPn/R8aQ1cutYaUHatpbO0+qFladV9cHGb+IaQEZSs+0ebITynSvDaUxYVWdjIOoeuBAkviKXgaGvLmqvVJOgSVqnhXJZsh+DsGpXnrh+iUopuUS5+IUBzMsYYQw54gQgMTP9Apdh4JkY2NVSOSNYkHCGkkD6DrFgavMATLD03wVS+Lj+a05jJKAAeJGJSBL2HNs6khpA6YqPCMuncIgA/okQqOyfKQMQYCpfI4FDwDKyTLyosNp2JInG9SIFxSMU6oqRy8XRV8CqVZkNhzM7TR+w/jNARTyQMIyHkgPQGLCVTEGJaFZFoqlmXF7MrO9WeyGSaK3lejzIxp/OIzazVgv3WM4sLrhZPcBA5aAlCSG1oL/JVswo1t5Towr5Uvb3l5KqcKyUuf3410/3qRl8rXB8n8gmIl5OWYW2Cl5lZbSpcJnGbrdByjJRXKGWGzAkiDoEAiCPXYuwiEy2tN+QvJnY1yfPH5K+Yam0ID8iOLhyr6Uty8RNjFZcToW8rsTtEAMfpb3LvCz8o+cRb++LzMb6ibmXWArJv7CQTuZQ8KCBfFZugamp44H6lucdtf1mrrrrlL7e6tpfOPn4B8jfhEwea4z9L3tzY5vZjQ5d7Zmmzrvb+c9cbzR2u23ZkkJJRiQ9B0eW6ifWPXvfXPejDN1u7++sePMf1j151Z+Z8O4qcPnxmZhdZ3W1/3XO77QW+ea9HxN5tHxgorfrNw1AJwBRX3vVsejyICWFV41N8u+05JvLXx0vsRhIeOn7BuvGPQUwIqxufijZELr/x0MtIKEvdf9ymurkrvqa1J+Fm28CnNS09a6ubumIXxyVqRhLGrEgwqWrqjCMYEdvak1DV2BGfdep7azGBvFQmxsloQOpp2JrKPXt5KICnLvz8L/3wwzieF2MoEKFyGsDLggT7nqzoc9f3xUoPYIxuZW+BeT7ugHEZwvgsipuvg33LZyPAGBr2RJv0HI4u6i9YY98+c+hMfZaHUk+9h35P8Y/6Za03eeIZtZSW21uoFIZMI0etWjDEifWxkUhrt7zrUZkUxGFcbSQUPZTbqqVDVyiOnazu3ROo6c0Ignt7o2hcvAF6j60MfXZkeRjBWKnlFgjAyvCyIEOfg4RCbwjJj7utCkZpZDzGP8GNTTp4kh4A/TlLqMcHoqDzYFRQS3pYCDnQTMETMlsEYGptwpvwDM05WSr/6eGwwuV8nc1ojNNEoW3XPKr3m3DoPhAW0pUZGnJlsz/8x2CHrfVJGbbBG58oMa7HFlFtGeHQkhayoDU99P2OQ9FwOWkOxUuGmocy2Pyvh9RwQjLyVgdSuCwRcHkSZK+ZS43wjh6B1//rGUjVhmkBAJbDv6ZyXquR81rDnnHfiDHaETLp31r5UekiqsJsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"VPC Lattice Shared Service Topology\"\n        title=\"VPC Lattice Shared Service Topology\"\n        src=\"/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/f058b/LatticeSharedServiceDiagram.png\"\n        srcset=\"/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/c26ae/LatticeSharedServiceDiagram.png 158w,\n/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/6bdcf/LatticeSharedServiceDiagram.png 315w,\n/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/f058b/LatticeSharedServiceDiagram.png 630w,\n/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/40601/LatticeSharedServiceDiagram.png 945w,\n/devops-pastebin/static/d26599aac5a3e0a457e5146fbde011c4/d93d9/LatticeSharedServiceDiagram.png 1243w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>To start building, we are going to need to meet the prerequisites:</p>\n<ol>\n<li>Three separate AWS accounts belong to a single AWS Organization. Additionally, we must enable RAM sharing across the Organization.</li>\n<li>Three configured CLI profiles - for all three accounts, respectively. Mind that the aws:profile and aws-native:profile providers must be configured explicitly and separately. They may, however, reuse the same credentials.</li>\n<li>A working Pulumi environment.</li>\n<li>Account IDs of all three AWS accounts.</li>\n</ol>\n<h2>Pulumi Stacks and Deployment Procedures</h2>\n<p>Our lab repository consists of three directories, each corresponding to a separate Pulumi stack:</p>\n<ol>\n<li>./a-common-service</li>\n<li>./b-blue-service</li>\n<li>./c-green-service</li>\n</ol>\n<p>A “common-service” stack contains the infrastructure for the DirectoryService application deployed to a separate AWS account. This specific account also owns the two independent VPC Lattice Service Networks:</p>\n<ol>\n<li>One is to control the communication with the GreenService.</li>\n<li>Another is to control the communication with BlueService.</li>\n</ol>\n<p>We share the Service Networks with the respective microservice accounts via AWS RAM. As such, we provision the stacks in the same order listed above. Once the “common-service” stack is up, note the two VPC Lattice Service Networks - we must use their ARNs in the blue and green stack configurations, respectively. For simplicity, we will not use stack imports here and will copy-paste the correct values of the “common-service” stack output. Also, make a note of the “shared-service-fqdn” output value. Then, copy-paste that into both “blue-service” and “green-service” stack inputs.</p>\n<p>Deploy the Common Service:\n<a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/vpc-lattice-lab-1/tree/main/a-common-service\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<p>Deploy the Blue Service:\n<a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/vpc-lattice-lab-1/tree/main/b-blue-service\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<p>Deploy the Green Service:\n<a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/vpc-lattice-lab-1/tree/main/c-green-service\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<h2>Pulumi Stack: Common Service</h2>\n<p>Our “common-service” stack consists of essential VPC components, Lattice-specific network components, AWS RAM shares and a Lambda function running FastAPI. In addition, we use a private Application Load Balancer to front our Lambda function. First, let’s break down the stack.</p>\n<p>Our Pulumi project consists of the following files:</p>\n<ol>\n<li>settings.py - holds generic settings and Pulumi configuration variables.</li>\n<li>helpers.py - holds generic helper functions, if any.</li>\n<li>vpc.py - constructs three VPCs in our shared service AWS account.</li>\n<li>lattice.py - constructs Lattice Service Networks, associates them with the correct VPCs and shares them with the correct AWS accounts.</li>\n<li>app_infra.py - constructs everything around the Lambda function, including the ALB, IAM and the Lambda itself.</li>\n<li>main.py - executes the code.</li>\n</ol>\n<p>First, we define the settings and fetch configuration variables (settings.py):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pulumi <span class=\"token keyword\">import</span> Config\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nVarious stack settings.\nBelow baseline tags must be applied to all created resources without exception:\n1.  Key: \"Account\"\n    Values: [\"Management\", \"GreenSandbox\", \"BlueSandbox\", \"SharedServices\"]\n2.  Key: \"AccountType\"\n    Values: [\"Management\", \"Workload\"]\n3.  Key: \"Provisioned\"\n    Values: [\"Manually\", \"Pulumi\", \"Terraform\", \"Other\"]\n4.  Key: \"StackName\"\n    Values: [\"&lt;project-name-here>\"]\n\"\"\"</span>\npulumi_config <span class=\"token operator\">=</span> Config<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nprovider_config <span class=\"token operator\">=</span> Config<span class=\"token punctuation\">(</span><span class=\"token string\">\"aws\"</span><span class=\"token punctuation\">)</span>\ndeployment_region <span class=\"token operator\">=</span> provider_config<span class=\"token punctuation\">.</span>require<span class=\"token punctuation\">(</span><span class=\"token string\">\"region\"</span><span class=\"token punctuation\">)</span>\n\nbaseline_cost_tags <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Account\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"SharedServices\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"AccountType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Workload\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Provisioned\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pulumi\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"StackName\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"common-service\"</span>\n<span class=\"token punctuation\">}</span>\n\nbaseline_cost_tags_native <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AccountType\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Workload\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Account\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"SharedServices\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Provisioned\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pulumi\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"StackName\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"common-service\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span>\n\nshared_services_main_vpc_cidr <span class=\"token operator\">=</span> <span class=\"token string\">\"10.0.0.0/16\"</span>\n\nshared_service_subnet_cidrs_pub <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"10.0.0.0/22\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"10.0.4.0/22\"</span>\n<span class=\"token punctuation\">]</span>\n\nshared_service_subnet_cidrs_app <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"10.0.8.0/22\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"10.0.12.0/22\"</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nVPC Lattice Local Peers\n\"\"\"</span>\nblue_network_vpc_cidr <span class=\"token operator\">=</span> <span class=\"token string\">\"192.168.0.0/23\"</span>\nblue_subnet_cidrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> \n    <span class=\"token string\">\"192.168.0.0/24\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"192.168.1.0/24\"</span>\t\n<span class=\"token punctuation\">]</span>\n\ngreen_network_vpc_cidr <span class=\"token operator\">=</span> <span class=\"token string\">\"192.168.2.0/23\"</span>\ngreen_subnet_cidrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> \n    <span class=\"token string\">\"192.168.2.0/24\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"192.168.3.0/24\"</span>\t\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nVPC Lattice Dev Accounts\n\"\"\"</span>\ngreen_principal <span class=\"token operator\">=</span> pulumi_config<span class=\"token punctuation\">.</span>require<span class=\"token punctuation\">(</span><span class=\"token string\">\"green-principal\"</span><span class=\"token punctuation\">)</span>\nblue_principal <span class=\"token operator\">=</span> pulumi_config<span class=\"token punctuation\">.</span>require<span class=\"token punctuation\">(</span><span class=\"token string\">\"blue-principal\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Second, get some helpers (helpers.py):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pulumi_aws <span class=\"token keyword\">import</span> get_caller_identity<span class=\"token punctuation\">,</span> get_availability_zones\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nVarious stack helper functions and configuration variables.\n\"\"\"</span>\n\ncurrent_account <span class=\"token operator\">=</span> get_caller_identity<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ncurrent_account_id <span class=\"token operator\">=</span> current_account<span class=\"token punctuation\">.</span>account_id\ndemo_azs <span class=\"token operator\">=</span> get_availability_zones<span class=\"token punctuation\">(</span>state<span class=\"token operator\">=</span><span class=\"token string\">\"available\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>names</code></pre></div>\n<p>Thirdly, construct the VPCs (vpc.py):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pulumi_aws <span class=\"token keyword\">import</span> ec2\n<span class=\"token keyword\">from</span> pulumi <span class=\"token keyword\">import</span> ResourceOptions\n\n<span class=\"token keyword\">from</span> settings <span class=\"token keyword\">import</span> baseline_cost_tags<span class=\"token punctuation\">,</span> deployment_region<span class=\"token punctuation\">,</span> shared_services_main_vpc_cidr<span class=\"token punctuation\">,</span> blue_network_vpc_cidr<span class=\"token punctuation\">,</span> green_network_vpc_cidr<span class=\"token punctuation\">,</span> blue_subnet_cidrs<span class=\"token punctuation\">,</span> green_subnet_cidrs<span class=\"token punctuation\">,</span> shared_service_subnet_cidrs_pub<span class=\"token punctuation\">,</span> shared_service_subnet_cidrs_app\n<span class=\"token keyword\">from</span> helpers <span class=\"token keyword\">import</span> demo_azs\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs Shared Services main VPC:\n\"\"\"</span>\nshared_services_main_vpc <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Vpc<span class=\"token punctuation\">(</span><span class=\"token string\">\"SharedServicesMainVpc\"</span><span class=\"token punctuation\">,</span>\n    cidr_block<span class=\"token operator\">=</span>shared_services_main_vpc_cidr<span class=\"token punctuation\">,</span>\n    enable_dns_hostnames<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    enable_dns_support<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServicesMainVpc-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\nshared_services_main_igw <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>InternetGateway<span class=\"token punctuation\">(</span><span class=\"token string\">\"SharedServicesMainVpcIgw\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServicesMainVpcIgw-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs secondary VPCs for peering and Lattice connection:\n\"\"\"</span>\ngreen_network_vpc <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Vpc<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenNetworkVpc\"</span><span class=\"token punctuation\">,</span>\n    cidr_block<span class=\"token operator\">=</span>green_network_vpc_cidr<span class=\"token punctuation\">,</span>\n    enable_dns_hostnames<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    enable_dns_support<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenNetworkVpc-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\nblue_network_vpc <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Vpc<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueNetworkVpc\"</span><span class=\"token punctuation\">,</span>\n    cidr_block<span class=\"token operator\">=</span>blue_network_vpc_cidr<span class=\"token punctuation\">,</span>\n    enable_dns_hostnames<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    enable_dns_support<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"BlueNetworkVpc-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nEstablishes VPC peering connections:\n\"\"\"</span>\ngreen_peering_connection <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>VpcPeeringConnection<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenPeeringConnection\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    peer_vpc_id<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    auto_accept<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            shared_services_main_vpc<span class=\"token punctuation\">,</span>\n            green_network_vpc\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\ngreen_peering_connection_options <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>PeeringConnectionOptions<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenPeeringConnectionOptions\"</span><span class=\"token punctuation\">,</span>\n    vpc_peering_connection_id<span class=\"token operator\">=</span>green_peering_connection<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    accepter<span class=\"token operator\">=</span>ec2<span class=\"token punctuation\">.</span>PeeringConnectionOptionsAccepterArgs<span class=\"token punctuation\">(</span>\n        allow_remote_vpc_dns_resolution<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requester<span class=\"token operator\">=</span>ec2<span class=\"token punctuation\">.</span>PeeringConnectionOptionsRequesterArgs<span class=\"token punctuation\">(</span>\n        allow_remote_vpc_dns_resolution<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>green_peering_connection<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            green_peering_connection\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nblue_peering_connection <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>VpcPeeringConnection<span class=\"token punctuation\">(</span><span class=\"token string\">\"BluePeeringConnection\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    peer_vpc_id<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    auto_accept<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            shared_services_main_vpc<span class=\"token punctuation\">,</span>\n            blue_network_vpc\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nblue_peering_connection_options <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>PeeringConnectionOptions<span class=\"token punctuation\">(</span><span class=\"token string\">\"BluePeeringConnectionOptions\"</span><span class=\"token punctuation\">,</span>\n    vpc_peering_connection_id<span class=\"token operator\">=</span>blue_peering_connection<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    accepter<span class=\"token operator\">=</span>ec2<span class=\"token punctuation\">.</span>PeeringConnectionOptionsAccepterArgs<span class=\"token punctuation\">(</span>\n        allow_remote_vpc_dns_resolution<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    requester<span class=\"token operator\">=</span>ec2<span class=\"token punctuation\">.</span>PeeringConnectionOptionsRequesterArgs<span class=\"token punctuation\">(</span>\n        allow_remote_vpc_dns_resolution<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>blue_peering_connection<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            blue_peering_connection\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs Shared Services main VPC's subnets:\n\"\"\"</span>\nshared_services_pub_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nshared_services_app_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    prefix <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n\n    shared_service_subnet_pub <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceSubnetPub-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>shared_service_subnet_cidrs_pub<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceSubnetPub-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_services_pub_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>shared_service_subnet_pub<span class=\"token punctuation\">)</span>\n\n    shared_service_rt_pub <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceRtPub-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceRtPub-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_service_subnet_pub<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_service_rt_pub_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceRtaPub-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>shared_service_rt_pub<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>shared_service_subnet_pub<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_service_subnet_pub<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_service_pub_route_to_wan <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"WanPubRoute-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>shared_service_rt_pub<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        gateway_id<span class=\"token operator\">=</span>shared_services_main_igw<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n            parent<span class=\"token operator\">=</span>shared_service_rt_pub\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_service_subnet_app <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceSubnetApp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>shared_service_subnet_cidrs_app<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceSubnetApp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_services_app_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>shared_service_subnet_app<span class=\"token punctuation\">)</span>\n\n    shared_service_rt_app <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceRtApp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceRtApp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_service_subnet_app<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_service_rt_app_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SharedServiceAppRta-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>shared_service_rt_app<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>shared_service_subnet_app<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_service_subnet_app<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_service_route_to_green <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"RouteToGreenPeer-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>shared_service_rt_app<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        vpc_peering_connection_id<span class=\"token operator\">=</span>green_peering_connection<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span>green_network_vpc_cidr<span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n            parent<span class=\"token operator\">=</span>shared_service_rt_app<span class=\"token punctuation\">,</span>\n            depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>green_peering_connection<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    shared_service_route_to_blue <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"RouteToBluePeer-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>shared_service_rt_app<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        vpc_peering_connection_id<span class=\"token operator\">=</span>blue_peering_connection<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span>blue_network_vpc_cidr<span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n            parent<span class=\"token operator\">=</span>shared_service_rt_app<span class=\"token punctuation\">,</span>\n            depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>blue_peering_connection<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs green network peer subnets:\n\"\"\"</span>\ngreen_peer_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    prefix <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n\n    green_peer_subnet <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenPeerSubnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>green_subnet_cidrs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenPeerSubnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    green_peer_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>green_peer_subnet<span class=\"token punctuation\">)</span>\n    \n    green_peer_rt <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenPeerRt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenPeerRt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>green_peer_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    green_peer_rt_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenPeerRta-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>green_peer_rt<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>green_peer_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>green_peer_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    green_peer_main_route <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenPeerMainRoute-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>green_peer_rt<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        vpc_peering_connection_id<span class=\"token operator\">=</span>green_peering_connection<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span>shared_services_main_vpc_cidr<span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n            parent<span class=\"token operator\">=</span>green_peer_rt<span class=\"token punctuation\">,</span>\n            depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>green_peering_connection<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs blue network peer subnets:\n\"\"\"</span>\nblue_peer_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    prefix <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n\n    blue_peer_subnet <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"BluePeerSubnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>blue_subnet_cidrs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"BluePeerSubnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    blue_peer_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>blue_peer_subnet<span class=\"token punctuation\">)</span>\n    \n    blue_peer_rt <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"BluePeerRt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"BluePeerRt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>blue_peer_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    blue_peer_rt_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"BluePeerRta-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>blue_peer_rt<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>blue_peer_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>blue_peer_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    blue_peer_main_route <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"BluePeerMainRoute-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>blue_peer_rt<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        vpc_peering_connection_id<span class=\"token operator\">=</span>blue_peering_connection<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span>shared_services_main_vpc_cidr<span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n            parent<span class=\"token operator\">=</span>blue_peer_rt<span class=\"token punctuation\">,</span>\n            depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>blue_peering_connection<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates demo security groups in the Green and Blue VPCs:\n\"\"\"</span>\ngreen_lattice_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenSecurityGroup\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"Green Lattice Security Group\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    ingress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupIngressArgs<span class=\"token punctuation\">(</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    egress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupEgressArgs<span class=\"token punctuation\">(</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"GreenSecurityGroup-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nblue_lattice_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueSecurityGroup\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"Blue Lattice Security Group\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    ingress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupIngressArgs<span class=\"token punctuation\">(</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    egress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupEgressArgs<span class=\"token punctuation\">(</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"BlueSecurityGroup-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates a demo security group in the main VPC, to be used with the Application Load Balancer:\n\"\"\"</span>\nmain_lambda_alb_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"MainLambdaAlbSecurityGroup\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"ALB Security Group\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    ingress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupIngressArgs<span class=\"token punctuation\">(</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    egress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupEgressArgs<span class=\"token punctuation\">(</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"MainLambdaAlbSecurityGroup-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Fourthly, create Lattice networks (lattice.py):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pulumi_aws_native <span class=\"token keyword\">import</span> vpclattice\n<span class=\"token keyword\">from</span> pulumi_aws <span class=\"token keyword\">import</span> ram\n<span class=\"token keyword\">from</span> pulumi <span class=\"token keyword\">import</span> ResourceOptions<span class=\"token punctuation\">,</span> export\n\n<span class=\"token keyword\">from</span> settings <span class=\"token keyword\">import</span> baseline_cost_tags<span class=\"token punctuation\">,</span> deployment_region<span class=\"token punctuation\">,</span> baseline_cost_tags_native<span class=\"token punctuation\">,</span> green_principal<span class=\"token punctuation\">,</span> blue_principal\n<span class=\"token keyword\">from</span> vpc <span class=\"token keyword\">import</span> green_network_vpc<span class=\"token punctuation\">,</span> blue_network_vpc<span class=\"token punctuation\">,</span> green_lattice_sg<span class=\"token punctuation\">,</span> blue_lattice_sg\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates the RAM shares for Lattice service networks:\n\"\"\"</span>\ngreen_ram_share <span class=\"token operator\">=</span> ram<span class=\"token punctuation\">.</span>ResourceShare<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenLatticeRamShare\"</span><span class=\"token punctuation\">,</span>\n    allow_external_principals<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># Make note that this share will not work outside your AWS Organization by default, set to True if needed</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags\n<span class=\"token punctuation\">)</span>\n\nblue_ram_share <span class=\"token operator\">=</span> ram<span class=\"token punctuation\">.</span>ResourceShare<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueLatticeRamShare\"</span><span class=\"token punctuation\">,</span>\n    allow_external_principals<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># Make note that this share will not work outside your AWS Organization by default, set to True if needed</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nAssociates principals to the RAM shares:\n\"\"\"</span>\ngreen_principal_association <span class=\"token operator\">=</span> ram<span class=\"token punctuation\">.</span>PrincipalAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenPrincipalAssociation\"</span><span class=\"token punctuation\">,</span>\n    principal<span class=\"token operator\">=</span>green_principal<span class=\"token punctuation\">,</span>\n    resource_share_arn<span class=\"token operator\">=</span>green_ram_share<span class=\"token punctuation\">.</span>arn\n<span class=\"token punctuation\">)</span>\n\nblue_principal_association <span class=\"token operator\">=</span> ram<span class=\"token punctuation\">.</span>PrincipalAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"BluePrincipalAssociation\"</span><span class=\"token punctuation\">,</span>\n    principal<span class=\"token operator\">=</span>blue_principal<span class=\"token punctuation\">,</span>\n    resource_share_arn<span class=\"token operator\">=</span>blue_ram_share<span class=\"token punctuation\">.</span>arn\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs green and blue service networks:\n\"\"\"</span>\ngreen_service_network <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>ServiceNetwork<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenServiceNetwork\"</span><span class=\"token punctuation\">,</span>\n    auth_type<span class=\"token operator\">=</span><span class=\"token string\">\"NONE\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"green-service-network\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native\n<span class=\"token punctuation\">)</span>\n\nexport<span class=\"token punctuation\">(</span><span class=\"token string\">\"green-service-network-arn\"</span><span class=\"token punctuation\">,</span> green_service_network<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">)</span>\n\nblue_service_network <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>ServiceNetwork<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueServiceNetwork\"</span><span class=\"token punctuation\">,</span>\n    auth_type<span class=\"token operator\">=</span><span class=\"token string\">\"NONE\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"blue-service-network\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native\n<span class=\"token punctuation\">)</span>\n\nexport<span class=\"token punctuation\">(</span><span class=\"token string\">\"blue-service-network-arn\"</span><span class=\"token punctuation\">,</span> blue_service_network<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nAdds service networks to respective RAM shares:\n\"\"\"</span>\ngreen_ram_share_association <span class=\"token operator\">=</span> ram<span class=\"token punctuation\">.</span>ResourceAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenLatticeRamShareAssociation\"</span><span class=\"token punctuation\">,</span>\n    resource_arn<span class=\"token operator\">=</span>green_service_network<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    resource_share_arn<span class=\"token operator\">=</span>green_ram_share<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>green_ram_share<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            green_service_network\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nblue_ram_share_association <span class=\"token operator\">=</span> ram<span class=\"token punctuation\">.</span>ResourceAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueLatticeRamShareAssociation\"</span><span class=\"token punctuation\">,</span>\n    resource_arn<span class=\"token operator\">=</span>blue_service_network<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    resource_share_arn<span class=\"token operator\">=</span>blue_ram_share<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>blue_ram_share<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            blue_service_network\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nAdds service netowork VPC associations (Green Peer and Blue Peer in SharedServices):\n\"\"\"</span>\ngreen_service_network_vpc_association <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>ServiceNetworkVpcAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenServiceNetworkVpcAssociation\"</span><span class=\"token punctuation\">,</span>\n    security_group_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>green_lattice_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    service_network_identifier<span class=\"token operator\">=</span>green_service_network<span class=\"token punctuation\">,</span>\n    vpc_identifier<span class=\"token operator\">=</span>green_network_vpc<span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>green_service_network<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            green_service_network<span class=\"token punctuation\">,</span>\n            green_network_vpc\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nblue_service_network_vpc_association <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>ServiceNetworkVpcAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueServiceNetworkVpcAssociation\"</span><span class=\"token punctuation\">,</span>\n    security_group_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>blue_lattice_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    service_network_identifier<span class=\"token operator\">=</span>blue_service_network<span class=\"token punctuation\">,</span>\n    vpc_identifier<span class=\"token operator\">=</span>blue_network_vpc<span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        parent<span class=\"token operator\">=</span>blue_service_network<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            blue_service_network<span class=\"token punctuation\">,</span>\n            blue_network_vpc\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Finally, create the “SharedService” Lambda function and register it as a Lattice Service (app_infra.py):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pulumi <span class=\"token keyword\">import</span> ResourceOptions<span class=\"token punctuation\">,</span> FileArchive<span class=\"token punctuation\">,</span> AssetArchive<span class=\"token punctuation\">,</span> export\n<span class=\"token keyword\">from</span> pulumi_aws <span class=\"token keyword\">import</span> lb<span class=\"token punctuation\">,</span> iam<span class=\"token punctuation\">,</span> lambda_<span class=\"token punctuation\">,</span> ec2\n<span class=\"token keyword\">from</span> pulumi_aws_native <span class=\"token keyword\">import</span> vpclattice\n<span class=\"token keyword\">import</span> json\n\n<span class=\"token keyword\">from</span> settings <span class=\"token keyword\">import</span> baseline_cost_tags<span class=\"token punctuation\">,</span> deployment_region<span class=\"token punctuation\">,</span> baseline_cost_tags_native<span class=\"token punctuation\">,</span> blue_principal<span class=\"token punctuation\">,</span> green_principal\n<span class=\"token keyword\">from</span> helpers <span class=\"token keyword\">import</span> current_account_id\n<span class=\"token keyword\">from</span> vpc <span class=\"token keyword\">import</span> main_lambda_alb_sg<span class=\"token punctuation\">,</span> shared_services_app_subnets<span class=\"token punctuation\">,</span> shared_services_main_vpc\n<span class=\"token keyword\">from</span> lattice <span class=\"token keyword\">import</span> green_service_network<span class=\"token punctuation\">,</span> blue_service_network\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs a private Application Load Balancer for the Lambda function:\n\"\"\"</span>\n<span class=\"token comment\"># This one costs money:</span>\nshared_service_alb <span class=\"token operator\">=</span> lb<span class=\"token punctuation\">.</span>LoadBalancer<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceLb\"</span><span class=\"token punctuation\">,</span>\n    internal<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    load_balancer_type<span class=\"token operator\">=</span><span class=\"token string\">\"application\"</span><span class=\"token punctuation\">,</span>\n    security_groups<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>main_lambda_alb_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    subnets<span class=\"token operator\">=</span>shared_services_app_subnets<span class=\"token punctuation\">,</span>\n    enable_deletion_protection<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DirectoryServiceLb\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\nshared_service_target_group <span class=\"token operator\">=</span> lb<span class=\"token punctuation\">.</span>TargetGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceTg\"</span><span class=\"token punctuation\">,</span>\n    target_type<span class=\"token operator\">=</span><span class=\"token string\">\"lambda\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DirectoryServiceTg\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># This one costs money (via ALB dependency):</span>\nshared_service_listener <span class=\"token operator\">=</span> lb<span class=\"token punctuation\">.</span>Listener<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceListener\"</span><span class=\"token punctuation\">,</span>\n    load_balancer_arn<span class=\"token operator\">=</span>shared_service_alb<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    port<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span>\n    default_actions<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>lb<span class=\"token punctuation\">.</span>ListenerDefaultActionArgs<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"forward\"</span><span class=\"token punctuation\">,</span>\n        target_group_arn<span class=\"token operator\">=</span>shared_service_target_group<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates a Lambda security group in the main VPC:\n\"\"\"</span>\nmain_lambda_func_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"MainLambdaFuncSecurityGroup\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"Lambda Security Group\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    ingress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupIngressArgs<span class=\"token punctuation\">(</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    egress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupEgressArgs<span class=\"token punctuation\">(</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"MainLambdaFuncSecurityGroup-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs a Lambda IAM role\n\"\"\"</span>\ndirectory_service_execution_role <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>Role<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceExecutionRole\"</span><span class=\"token punctuation\">,</span>\n    assume_role_policy<span class=\"token operator\">=</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Version\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Statement\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Action\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Effect\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Sid\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Principal\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DirectoryServiceExecutionRole\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\nlambda_vpc_managed_policy <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>get_policy<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"AWSLambdaVPCAccessExecutionRole\"</span><span class=\"token punctuation\">)</span>\n\ndirectory_service_execution_role_policy_attachment <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>RolePolicyAttachment<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceExecutionRolePolicyAttachment\"</span><span class=\"token punctuation\">,</span>\n    policy_arn<span class=\"token operator\">=</span>lambda_vpc_managed_policy<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    role<span class=\"token operator\">=</span>directory_service_execution_role\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates the DirectoryService Lambda layer:\n\"\"\"</span>\n\nlayer_asset <span class=\"token operator\">=</span> FileArchive<span class=\"token punctuation\">(</span><span class=\"token string\">\"./directory_app_layer/lambda_layer.zip\"</span><span class=\"token punctuation\">)</span>\n\nservice_layer <span class=\"token operator\">=</span> lambda_<span class=\"token punctuation\">.</span>LayerVersion<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceLayer\"</span><span class=\"token punctuation\">,</span>\n    compatible_runtimes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"python3.8\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token operator\">=</span>layer_asset<span class=\"token punctuation\">,</span>\n    layer_name<span class=\"token operator\">=</span><span class=\"token string\">\"lambda_layer\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs the DirectoryService Lambda function:\n\"\"\"</span>\nservice_function <span class=\"token operator\">=</span> lambda_<span class=\"token punctuation\">.</span>Function<span class=\"token punctuation\">(</span><span class=\"token string\">\"DirectoryServiceFunction\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"DirectoryServiceFunction\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    role<span class=\"token operator\">=</span>directory_service_execution_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    vpc_config<span class=\"token operator\">=</span>lambda_<span class=\"token punctuation\">.</span>FunctionVpcConfigArgs<span class=\"token punctuation\">(</span>\n        security_group_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>main_lambda_func_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> shared_services_app_subnets<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    replace_security_groups_on_destroy<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"DirectoryServiceFunction\"</span><span class=\"token punctuation\">,</span>\n    runtime<span class=\"token operator\">=</span><span class=\"token string\">\"python3.8\"</span><span class=\"token punctuation\">,</span>\n    layers<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>service_layer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token operator\">=</span>AssetArchive<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\".\"</span><span class=\"token punctuation\">:</span> FileArchive<span class=\"token punctuation\">(</span><span class=\"token string\">\"./directory_app\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    handler<span class=\"token operator\">=</span><span class=\"token string\">\"main.lambda_handler\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nAdds the ALB Lambda invoke permission:\n\"\"\"</span>\nalb_invoke_permission <span class=\"token operator\">=</span> lambda_<span class=\"token punctuation\">.</span>Permission<span class=\"token punctuation\">(</span><span class=\"token string\">\"AlbFunctionPermission\"</span><span class=\"token punctuation\">,</span>\n    action<span class=\"token operator\">=</span><span class=\"token string\">\"lambda:InvokeFunction\"</span><span class=\"token punctuation\">,</span>\n    function<span class=\"token operator\">=</span>service_function<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n    principal<span class=\"token operator\">=</span><span class=\"token string\">\"elasticloadbalancing.amazonaws.com\"</span><span class=\"token punctuation\">,</span>\n    source_arn<span class=\"token operator\">=</span>shared_service_target_group<span class=\"token punctuation\">.</span>arn\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nAttaches the Lambda function to the target group:\n\"\"\"</span>\nservice_function_target_group_attachment <span class=\"token operator\">=</span> lb<span class=\"token punctuation\">.</span>TargetGroupAttachment<span class=\"token punctuation\">(</span><span class=\"token string\">\"FunctionTargetGroupAttachment\"</span><span class=\"token punctuation\">,</span>\n    target_group_arn<span class=\"token operator\">=</span>shared_service_target_group<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    target_id<span class=\"token operator\">=</span>service_function<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>alb_invoke_permission<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates a Lattice target group:\n\"\"\"</span>\nshared_service_lattice_tg <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>TargetGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"SharedServiceTargetGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ALB\"</span><span class=\"token punctuation\">,</span>\n    config<span class=\"token operator\">=</span>vpclattice<span class=\"token punctuation\">.</span>TargetGroupConfigArgs<span class=\"token punctuation\">(</span>\n        port<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span>\n        vpc_identifier<span class=\"token operator\">=</span>shared_services_main_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"shared-service-target\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native<span class=\"token punctuation\">,</span>\n    targets<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>vpclattice<span class=\"token punctuation\">.</span>TargetGroupTargetArgs<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span>shared_service_alb<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        port<span class=\"token operator\">=</span><span class=\"token number\">80</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreates a Lattice service and listener:\n\"\"\"</span>\n<span class=\"token comment\"># From here big money:</span>\nshared_service_lattice_service <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>Service<span class=\"token punctuation\">(</span><span class=\"token string\">\"SharedServiceLatticeService\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"shared-service\"</span><span class=\"token punctuation\">,</span>\n    auth_type<span class=\"token operator\">=</span><span class=\"token string\">\"AWS_IAM\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native\n<span class=\"token punctuation\">)</span>\n\nexport<span class=\"token punctuation\">(</span><span class=\"token string\">\"shared-service-fqdn\"</span><span class=\"token punctuation\">,</span> shared_service_lattice_service<span class=\"token punctuation\">.</span>dns_entry<span class=\"token punctuation\">.</span>domain_name<span class=\"token punctuation\">)</span>\n\nshared_service_lattice_service_listener <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>Listener<span class=\"token punctuation\">(</span><span class=\"token string\">\"SharedServiceLatticeServiceListener\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"shared-service-listener\"</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n    service_identifier<span class=\"token operator\">=</span>shared_service_lattice_service<span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native<span class=\"token punctuation\">,</span>\n    default_action<span class=\"token operator\">=</span>vpclattice<span class=\"token punctuation\">.</span>ListenerDefaultActionArgs<span class=\"token punctuation\">(</span>\n        forward<span class=\"token operator\">=</span>vpclattice<span class=\"token punctuation\">.</span>ListenerForwardArgs<span class=\"token punctuation\">(</span>\n            target_groups<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                vpclattice<span class=\"token punctuation\">.</span>ListenerWeightedTargetGroupArgs<span class=\"token punctuation\">(</span>\n                    target_group_identifier<span class=\"token operator\">=</span>shared_service_lattice_tg<span class=\"token punctuation\">,</span>\n                    weight<span class=\"token operator\">=</span><span class=\"token number\">100</span>\n                <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            shared_service_lattice_service\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nblue_service_lattice_service_association <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>ServiceNetworkServiceAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueServiceLatticeServiceAssociation\"</span><span class=\"token punctuation\">,</span>\n    service_identifier<span class=\"token operator\">=</span>shared_service_lattice_service<span class=\"token punctuation\">,</span>\n    service_network_identifier<span class=\"token operator\">=</span>blue_service_network<span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            shared_service_lattice_service\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\ngreen_service_lattice_service_association <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>ServiceNetworkServiceAssociation<span class=\"token punctuation\">(</span><span class=\"token string\">\"GreenServiceLatticeServiceAssociation\"</span><span class=\"token punctuation\">,</span>\n    service_identifier<span class=\"token operator\">=</span>shared_service_lattice_service<span class=\"token punctuation\">,</span>\n    service_network_identifier<span class=\"token operator\">=</span>green_service_network<span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>baseline_cost_tags_native<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            shared_service_lattice_service\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nshared_service_auth_policy <span class=\"token operator\">=</span> vpclattice<span class=\"token punctuation\">.</span>AuthPolicy<span class=\"token punctuation\">(</span><span class=\"token string\">\"SharedServiceAuthPolicy\"</span><span class=\"token punctuation\">,</span>\n    policy<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Version\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Statement\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Effect\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Principal\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Action\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"vpc-lattice-svcs:Invoke\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Resource\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Condition\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"StringEquals\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"vpc-lattice-svcs:RequestMethod\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"vpc-lattice-svcs:RequestQueryString/q\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"blue\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"vpc-lattice-svcs:SourceVpcOwnerAccount\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>blue_principal<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Effect\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Principal\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Action\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"vpc-lattice-svcs:Invoke\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Resource\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"Condition\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"StringEquals\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"vpc-lattice-svcs:RequestMethod\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"vpc-lattice-svcs:RequestQueryString/q\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"green\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"vpc-lattice-svcs:SourceVpcOwnerAccount\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>green_principal<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    resource_identifier<span class=\"token operator\">=</span>shared_service_lattice_service<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            shared_service_lattice_service\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Notice above how we restricted access to the Lattice Service using the “vpc-lattice-svcs:RequestMethod”, “vpc-lattice-svcs:RequestQueryString/q”, and “vpc-lattice-svcs:SourceVpcOwnerAccount” parameters, where “q” is just a query string key.</p>\n<p>The function is rudimentary and uses a single Lambda layer for FastAPI and Mangum. I provided the layer for your convenience as a .zip archive inside the GitHub repository, so you do not have to rebuild it.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> fastapi <span class=\"token keyword\">import</span> FastAPI\n<span class=\"token keyword\">from</span> mangum <span class=\"token keyword\">import</span> Mangum\n  \n<span class=\"token comment\"># Initialise the app</span>\napp <span class=\"token operator\">=</span> FastAPI<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">root</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"endpoint\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>q<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n\nlambda_handler <span class=\"token operator\">=</span> Mangum<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span></code></pre></div>\n<p>By design, we only allow GET requests from the BlueFunction to the ”<a href=\"http://lattice-shared-service-fqdn/?q=blue\">http://lattice-shared-service-fqdn/?q=blue</a>” endpoint to succeed. Identically, only GET requests from the GreenFunction to the ”<a href=\"http://lattice-shared-service-fqdn/?q=green\">http://lattice-shared-service-fqdn/?q=green</a>” endpoint will succeed.</p>\n<h2>Pulumi Stack: Blue and Green Services</h2>\n<p>Our “blue-service” and “green-service” stacks are identical apart from configuration, so we will only focus on one. The Pulumi project contains the following files:</p>\n<ol>\n<li>settings.py - holds generic settings and Pulumi configuration variables.</li>\n<li>helpers.py - holds generic helper functions, if any.</li>\n<li>vpc.py - constructs a single VPC.</li>\n<li>app_infra.py - constructs everything around the Lambda function, including the ALB, IAM and the Lambda itself.</li>\n<li>main.py - executes the code.</li>\n</ol>\n<p>Let’s take a look at app_infra.py specifically here:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pulumi <span class=\"token keyword\">import</span> ResourceOptions<span class=\"token punctuation\">,</span> FileArchive<span class=\"token punctuation\">,</span> AssetArchive\n<span class=\"token keyword\">from</span> pulumi_aws <span class=\"token keyword\">import</span> lb<span class=\"token punctuation\">,</span> iam<span class=\"token punctuation\">,</span> lambda_<span class=\"token punctuation\">,</span> ec2\n<span class=\"token keyword\">import</span> json\n\n<span class=\"token keyword\">from</span> settings <span class=\"token keyword\">import</span> baseline_cost_tags<span class=\"token punctuation\">,</span> deployment_region<span class=\"token punctuation\">,</span> shared_service_fqdn\n<span class=\"token keyword\">from</span> vpc <span class=\"token keyword\">import</span> blue_sandbox_vpc<span class=\"token punctuation\">,</span> blue_sandbox_app_subnets\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nLambda security group\n\"\"\"</span>\n\nblue_lambda_func_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueLambdaFuncSecurityGroup\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"Lambda Security Group\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>blue_sandbox_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    ingress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupIngressArgs<span class=\"token punctuation\">(</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    egress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupEgressArgs<span class=\"token punctuation\">(</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"BlueLambdaFuncSecurityGroup-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>blue_sandbox_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs a Lambda IAM role\n\"\"\"</span>\nblue_lambda_execution_role <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>Role<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueLambdaExecutionRole\"</span><span class=\"token punctuation\">,</span>\n    assume_role_policy<span class=\"token operator\">=</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Version\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Statement\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"Action\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Effect\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Sid\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Principal\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"BlueLambdaExecutionRole\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\nlambda_vpc_managed_policy <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>get_policy<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"AWSLambdaVPCAccessExecutionRole\"</span><span class=\"token punctuation\">)</span>\n\nblue_lambda_execution_role_policy_attachment <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>RolePolicyAttachment<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueLambdaRolePolicyAttachment\"</span><span class=\"token punctuation\">,</span>\n    policy_arn<span class=\"token operator\">=</span>lambda_vpc_managed_policy<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    role<span class=\"token operator\">=</span>blue_lambda_execution_role\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nConstructs the Blue Lambda function:\n\"\"\"</span>\nblue_function <span class=\"token operator\">=</span> lambda_<span class=\"token punctuation\">.</span>Function<span class=\"token punctuation\">(</span><span class=\"token string\">\"BlueFunction\"</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>baseline_cost_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"BlueFunction\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    role<span class=\"token operator\">=</span>blue_lambda_execution_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    vpc_config<span class=\"token operator\">=</span>lambda_<span class=\"token punctuation\">.</span>FunctionVpcConfigArgs<span class=\"token punctuation\">(</span>\n        security_group_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>blue_lambda_func_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> blue_sandbox_app_subnets<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    replace_security_groups_on_destroy<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"BlueFunction\"</span><span class=\"token punctuation\">,</span>\n    runtime<span class=\"token operator\">=</span><span class=\"token string\">\"python3.8\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token operator\">=</span>AssetArchive<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\".\"</span><span class=\"token punctuation\">:</span> FileArchive<span class=\"token punctuation\">(</span><span class=\"token string\">\"./blue_app\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    handler<span class=\"token operator\">=</span><span class=\"token string\">\"main.lambda_handler\"</span><span class=\"token punctuation\">,</span>\n    environment<span class=\"token operator\">=</span>lambda_<span class=\"token punctuation\">.</span>FunctionEnvironmentArgs<span class=\"token punctuation\">(</span>\n        variables<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"BLUE_ENDPOINT\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"http://</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>shared_service_fqdn<span class=\"token punctuation\">}</span></span><span class=\"token string\">/?q=blue\"</span></span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>This is a rudimentary Lambda function to execute a GET request towards our shared service Lattice endpoint.</p>\n<h2>Testing Connectivity</h2>\n<p>You may have noticed that our environments are private, and all Lambda functions reside within their dedicated VPCs, which have no route to WAN. Let’s create a default test execution of our BlueFunction. First, we ensure the BLUE_ENDPOINT environment variable contains the “q=blue” query string:</p>\n<p><img src=\"/devops-pastebin/844ac503cea08f1f7521b90dbf07df87/BlueLambdaEnvConfig.png\" alt=\"AWS Lambda Blue Configuration Correct\"></p>\n<p>Executing the function will produce the desired result:</p>\n<p><img src=\"/devops-pastebin/d4548e3542c75d1226b76b23697491d1/BlueLambdaEndpointTestSuccess.png\" alt=\"AWS Lambda Blue Test Success\"></p>\n<p>Let’s now manually edit the query string within the BLUE_ENDPOINT environment variable:</p>\n<p><img src=\"/devops-pastebin/d4394d32cd13636ff7028daa5a45bba5/BlueLambdaEnvConfigWrong.png\" alt=\"AWS Lambda Blue Configuration Wrong\"></p>\n<p>And execute the function one more time:</p>\n<p><img src=\"/devops-pastebin/57826e5d64a5014fccb7a4314e280e90/BlueLambdaTestForbidden.png\" alt=\"AWS Lambda Blue Test Fail\"></p>\n<p>Success! Feel free to perform the same steps with the GreenFunction.</p>\n<h2>Cleaning Up</h2>\n<p>Run “pulumi destroy” on all the stacks in reverse order. Start from “green-service”, then “blue-service”, then “common-service”. Afterwards, delete CloudWatch Lambda log groups from all three accounts manually if needed. Due to AWS’s throttling, you may need to manually delete some VPC Lattice objects and do a “pulumi refresh” instead, although there is usually no need. If you experience throttling, running “pulumi destroy” several times resolves the issue.</p>","frontmatter":{"title":"VPC Lattice Part 2. Connecting Applications to Shared Services","date":"April 14, 2023","description":"Utilizing VPC Peering to separate AWS VPC Lattice Networks while providing access to a shared HTTP service."}},"previous":{"fields":{"slug":"/lattice-part-one/"},"frontmatter":{"title":"VPC Lattice Part 1. Overview"}},"next":null},"pageContext":{"id":"e8cb3abb-dd79-5151-ad5e-6ad4f9632e9a","previousPostId":"fad2d0d7-3f84-54f4-b816-9e7f23272db7","nextPostId":null}},"staticQueryHashes":["4135132960","805692932"],"slicesMap":{}}