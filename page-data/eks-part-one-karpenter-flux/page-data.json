{"componentChunkName":"component---src-templates-blog-post-js","path":"/eks-part-one-karpenter-flux/","result":{"data":{"site":{"siteMetadata":{"title":"Yet Another DevOps Pastebin"}},"markdownRemark":{"id":"0267b2f6-f967-55dd-9359-a8f9cd0681db","excerpt":"Introduction A good chunk of my work revolves around Kubernetes clusters on AWS. Recently, I’ve been planning to create a series of posts on EKS clusters with…","html":"<h2>Introduction</h2>\n<p>A good chunk of my work revolves around Kubernetes clusters on AWS. Recently, I’ve been planning to create a series of posts on EKS clusters with different network and security components available in the CNCF ecosystem - a no-thrills overview of service meshes and CNI solutions aimed at operations teams - in the format of ready-made infrastructure as code examples powered by Pulumi.</p>\n<p>I’m inquisitive about what Cilium will bring us, especially after Release 1.12 and further down the road after CNCF graduation. We may also find a demo use case or two for Linkerd. And so on.</p>\n<p>I’m going to start small with the first post of what hopefully will become a series - we will operationalize a barebones EKS cluster with <a href=\"https://karpenter.sh/v0.19.2/\">Karpenter</a> and <a href=\"https://fluxcd.io/\">Flux</a>.</p>\n<p>Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out pulumi.com if you still need to become familiar with it. You can deploy this demo stack using the Pulumi button below.</p>\n<p><a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-eks-karpenter-flux/tree/main\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<p>You may find the source code for this demo in <a href=\"https://github.com/svodwood/pulumi-eks-karpenter-flux\">this Github repo</a>. A sample Flux configuration repository for this project <a href=\"https://github.com/svodwood/eks-1-flux-config-repo\">is here</a>.</p>\n<h2>What We Are Going To Build</h2>\n<p>We will spin up a demo VPC and a Fargate-enabled EKS cluster. We will additionally create the necessary IAM roles for service accounts to run Karpenter in the cluster. Finally, we will initialize a demo workload to check cluster autoscaling using Flux as our GitOps engine.</p>\n<p>To start building, we are going to need to meet the prerequisites:</p>\n<ol>\n<li>An AWS account with a named AWS CLI profile configured.</li>\n<li>A working Pulumi environment.</li>\n<li>A GitHub repo to set up the GitOps flow powered by Flux.</li>\n<li>A GitHub personal access token.</li>\n<li><a href=\"https://fluxcd.io/flux/cmd/\">FluxCLI</a> installed locally.</li>\n</ol>\n<h2>Flux Configuration Repository Set-up</h2>\n<p>Before launching our Pulumi template, we must set up a Flux repository. This repository will hold all definitions of things running inside our EKS cluster. The demo template assumes we are using a personal public repo on GitHub. When created, clone it locally. Because of an unresolved issue with the <a href=\"https://github.com/fluxcd/flux2/issues/3138\">Flux bootstrap process on Fargate</a>, we will define some kustomizations to the default resource definitions before running the Pulumi stack.</p>\n<p>First, create the file structure Flux expects, assuming the EKS cluster name “demo-k8s” (this is the name of the cluster to be provisioned by the stack by default).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> clusters/demo-k8s/flux-system\n<span class=\"token function\">touch</span> clusters/demo-k8s/flux-system/gotk-components.yaml <span class=\"token punctuation\">\\</span>\n    clusters/demo-k8s/flux-system/gotk-sync.yaml <span class=\"token punctuation\">\\</span>\n    clusters/demo-k8s/flux-system/kustomization.yaml</code></pre></div>\n<p>Paste the following into kustomization.yaml, commit and push.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.config.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Kustomization\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> gotk<span class=\"token punctuation\">-</span>components.yaml\n<span class=\"token punctuation\">-</span> gotk<span class=\"token punctuation\">-</span>sync.yaml\n<span class=\"token key atrule\">patches</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n      <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span> app.kubernetes.io/part<span class=\"token punctuation\">-</span>of=flux\n    <span class=\"token key atrule\">patch</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      - op: replace\n        path: /spec/template/spec/containers/0/resources/limits/cpu\n        value: \"0.25\"\n      - op: replace\n        path: /spec/template/spec/containers/0/resources/requests/cpu\n        value: \"0.25\"\n      - op: replace\n        path: /spec/template/spec/containers/0/resources/limits/memory\n        value: 256M\n      - op: replace\n        path: /spec/template/spec/containers/0/resources/requests/memory\n        value: 256M</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">patch</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      apiVersion: apps/v1\n      kind: Deployment\n      metadata:\n        name: all\n      spec:\n        template:\n          spec:\n            nodeSelector:\n              $patch: delete</span>\n    <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n      <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span> app.kubernetes.io/part<span class=\"token punctuation\">-</span>of=flux</code></pre></div>\n<h2>Pulumi Stack: Basic Infrastructure</h2>\n<p>First, we will construct a VPC consisting of public subnets, private subnets for the Kubernetes worker nodes and finally, dedicated subnets for the EKS Control Plane network interfaces:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token triple-quoted-string string\">\"\"\"\nvpc.py\n\"\"\"</span>\n<span class=\"token comment\"># Create a VPC and Internet Gateway:</span>\ndemo_vpc <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Vpc<span class=\"token punctuation\">(</span><span class=\"token string\">\"demo-vpc\"</span><span class=\"token punctuation\">,</span>\n    cidr_block<span class=\"token operator\">=</span>demo_vpc_cidr<span class=\"token punctuation\">,</span>\n    enable_dns_hostnames<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    enable_dns_support<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-vpc-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>config<span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\ndemo_igw <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>InternetGateway<span class=\"token punctuation\">(</span><span class=\"token string\">\"demo-igw\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-igw-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>config<span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a default any-any security group for demo purposes:</span>\ndemo_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"demo-security-group\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"Allow any-any\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    ingress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupIngressArgs<span class=\"token punctuation\">(</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Any\"</span><span class=\"token punctuation\">,</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    egress<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ec2<span class=\"token punctuation\">.</span>SecurityGroupEgressArgs<span class=\"token punctuation\">(</span>\n        from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n        cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ipv6_cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"::/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-sg-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>config<span class=\"token punctuation\">.</span>region<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create subnets:</span>\ndemo_azs <span class=\"token operator\">=</span> get_availability_zones<span class=\"token punctuation\">(</span>state<span class=\"token operator\">=</span><span class=\"token string\">\"available\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>names\ndemo_public_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\ndemo_private_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\ndemo_eks_cp_subnets <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    prefix <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n    \n    demo_public_subnet <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-public-subnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>demo_public_subnet_cidrs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-public-subnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo_public_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>demo_public_subnet<span class=\"token punctuation\">)</span>\n\n    demo_public_route_table <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-public-rt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-public-rt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_public_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo_public_route_table_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-public-rt-association-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>demo_public_route_table<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>demo_public_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_public_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    demo_public_wan_route <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-public-wan-route-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>demo_public_route_table<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        gateway_id<span class=\"token operator\">=</span>demo_igw<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_public_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    demo_eip <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Eip<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eip-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eip-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo_nat_gateway <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>NatGateway<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-nat-gateway-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        allocation_id<span class=\"token operator\">=</span>demo_eip<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>demo_public_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-nat-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_vpc<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    demo_private_subnet <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-private-subnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>demo_private_subnet_cidrs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-private-subnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter.sh/discovery\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo_private_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>demo_private_subnet<span class=\"token punctuation\">)</span>\n\n    demo_private_route_table <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-private-rt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-private-rt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_private_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo_private_route_table_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-private-rt-association-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>demo_private_route_table<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>demo_private_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_private_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    demo_private_wan_route <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-private-wan-route-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>demo_private_route_table<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        nat_gateway_id<span class=\"token operator\">=</span>demo_nat_gateway<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_private_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    demo_eks_cp_subnet <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Subnet<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eks-cp-subnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        cidr_block<span class=\"token operator\">=</span>demo_eks_cp_subnet_cidrs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        availability_zone<span class=\"token operator\">=</span>demo_azs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eks-cp-subnet-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo_eks_cp_subnets<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>demo_eks_cp_subnet<span class=\"token punctuation\">)</span>\n\n    demo_eks_cp_route_table <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTable<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eks-cp-rt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eks-cp-rt-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_eks_cp_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    \n    demo__eks_cp_route_table_association <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>RouteTableAssociation<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eks-cp-rt-association-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>demo_eks_cp_route_table<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        subnet_id<span class=\"token operator\">=</span>demo_eks_cp_subnet<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_eks_cp_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n    demo_eks_cp_wan_route <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>Route<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"demo-eks-cp-wan-route-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>prefix<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        route_table_id<span class=\"token operator\">=</span>demo_eks_cp_route_table<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        nat_gateway_id<span class=\"token operator\">=</span>demo_nat_gateway<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        destination_cidr_block<span class=\"token operator\">=</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">,</span>\n        opts<span class=\"token operator\">=</span>pulumi<span class=\"token punctuation\">.</span>ResourceOptions<span class=\"token punctuation\">(</span>parent<span class=\"token operator\">=</span>demo_eks_cp_subnet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>We will additionally create all VPC endpoints required to operate a private EKS cluster:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token triple-quoted-string string\">\"\"\"\nvpc_endpoints.py\n\"\"\"</span>\n<span class=\"token comment\"># Create a shared security group for all AWS services VPC endpoints:</span>\nvpc_endpoints_sg <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"aws-vpc-endpoints-sg\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"Shared security groups for AWS services VPC endpoints\"</span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"aws-vpc-endpoints-sg\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\ninbound_endpoints_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string\">\"inbound-vpc-endpoint-cidrs\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ingress\"</span><span class=\"token punctuation\">,</span>\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span>\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    security_group_id<span class=\"token operator\">=</span>vpc_endpoints_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n<span class=\"token punctuation\">)</span>\n\noutbound_endpoints_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string\">\"outbound-vpc-endpoint-cidrs\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"egress\"</span><span class=\"token punctuation\">,</span>\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    security_group_id<span class=\"token operator\">=</span>vpc_endpoints_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create VPC endpoints:</span>\nendpoints <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> service <span class=\"token keyword\">in</span> endpoint_services<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> service <span class=\"token operator\">==</span> <span class=\"token string\">\"s3\"</span><span class=\"token punctuation\">:</span>\n        enable_dns <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        enable_dns <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n    endpoints<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>ec2<span class=\"token punctuation\">.</span>VpcEndpoint<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>service<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">-vpc-endpoint\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_id <span class=\"token operator\">=</span> demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        service_name <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"com.amazonaws.</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>deployment_region<span class=\"token punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>service<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        vpc_endpoint_type <span class=\"token operator\">=</span> <span class=\"token string\">\"Interface\"</span><span class=\"token punctuation\">,</span>\n        subnet_ids <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> demo_private_subnets<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        security_group_ids <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>vpc_endpoints_sg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        private_dns_enabled <span class=\"token operator\">=</span> enable_dns<span class=\"token punctuation\">,</span>\n        tags <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>service<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">-vpc-endpoint\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        opts <span class=\"token operator\">=</span> ResourceOptions<span class=\"token punctuation\">(</span>\n            depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>vpc_endpoints_sg<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            parent<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>With our basic infrastructure completed, we can continue configuring our EKS cluster.</p>\n<h2>Pulumi Stack: EKS, Fargate, Karpenter Role, Flux Bootstrap</h2>\n<p>First, we will take care of several IAM objects necessary to construct our working EKS environment, namely:</p>\n<ol>\n<li>An EKS service role.</li>\n<li>A Fargate pod execution role.</li>\n<li>A Karpenter-managed node instance profile.</li>\n</ol>\n<p>Second, we will spin up an EKS cluster with a Fargate profile covering pod provisioning in “karpenter”, “kube-system”, and “flux-system” namespaces. These are the only namespaces to be created as part of the cluster provisioning routine - bootstrapping the cluster to a minimal working state can be outsourced to Operations and subsequently passed to a development team for consumption. In this example, the development teams, in turn, can adopt the cluster using the established GitOps workflow. In addition, ops teams may use role-based access control to restrict the manipulation of resources in these “operations-managed” namespaces. Finally, we will set up an IAM role for the Karpenter service account.</p>\n<p>It is a deliberate choice to run CoreDNS on Fargate. We will leave this approach’s pros and cons outside this guide’s scope.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token triple-quoted-string string\">\"\"\"\neks.py\n\"\"\"</span>\n<span class=\"token comment\"># Create an EKS cluster role</span>\neks_iam_role_policy_arns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSClusterPolicy\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSVPCResourceController\"</span>\n<span class=\"token punctuation\">]</span>\n\neks_iam_role <span class=\"token operator\">=</span> create_iam_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-eks-role\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"eks.amazonaws.com\"</span><span class=\"token punctuation\">,</span> eks_iam_role_policy_arns<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a default node role for Karpenter</span>\nkarpenter_default_nodegroup_role_policy_arns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy\"</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># Create a default Fargate execution role:</span>\ndefault_fargate_pod_execution_role_policy <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy\"</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># VPC CNI service account policies:</span>\ncni_service_account_policy_arns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy\"</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># Create a default demo EKS cluster nodegroup security group:</span>\ndemo_nodegroup_security_group <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-node-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\"> custom node security group\"</span></span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-node-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter.sh/discovery\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\ndemo_nodegroup_security_group_inbound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"inbound-eks-node-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ingress\"</span><span class=\"token punctuation\">,</span>\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span>\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    security_group_id<span class=\"token operator\">=</span>demo_nodegroup_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n<span class=\"token punctuation\">)</span>\n\ndemo_nodegroup_security_group_oubound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"outbound-eks-node-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"egress\"</span><span class=\"token punctuation\">,</span>\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    security_group_id<span class=\"token operator\">=</span>demo_nodegroup_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a default demo EKS cluster security group:</span>\ndemo_cluster_security_group <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-cluster-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\"> custom security group\"</span></span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-cluster-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\ndemo_cluster_security_group_inbound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"inbound-eks-cp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ingress\"</span><span class=\"token punctuation\">,</span>\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span>\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    security_group_id<span class=\"token operator\">=</span>demo_cluster_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n<span class=\"token punctuation\">)</span>\n\ndemo_cluster_security_group_oubound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"outbound-eks-cp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"egress\"</span><span class=\"token punctuation\">,</span>\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    security_group_id<span class=\"token operator\">=</span>demo_cluster_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a default Karpenter node role and instance profile:</span>\nkarpenter_node_role <span class=\"token operator\">=</span> create_iam_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"KarpenterNodeRole-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ec2.amazonaws.com\"</span><span class=\"token punctuation\">,</span> karpenter_default_nodegroup_role_policy_arns<span class=\"token punctuation\">)</span>\nkarpenter_instance_profile <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>InstanceProfile<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"KarpenterNodeInstanceProfile-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    role<span class=\"token operator\">=</span>karpenter_node_role<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"KarpenterNodeInstanceProfile-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a Fargate profile service role:</span>\nfargate_profile_service_role <span class=\"token operator\">=</span> create_iam_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-fargate-role\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"eks-fargate-pods.amazonaws.com\"</span><span class=\"token punctuation\">,</span> default_fargate_pod_execution_role_policy<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create an EKS log group:</span>\ndemo_eks_loggroup <span class=\"token operator\">=</span> cloudwatch<span class=\"token punctuation\">.</span>LogGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"demo-eks-loggroup\"</span><span class=\"token punctuation\">,</span> \n    name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"/aws/eks/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">/cluster\"</span></span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span>general_tags<span class=\"token punctuation\">,</span>\n    retention_in_days<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create the cluster control plane and Fargate profiles:</span>\ndemo_eks_cluster <span class=\"token operator\">=</span> eks_provider<span class=\"token punctuation\">.</span>Cluster<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"eks-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    instance_role<span class=\"token operator\">=</span>karpenter_node_role<span class=\"token punctuation\">,</span>\n    cluster_security_group<span class=\"token operator\">=</span>demo_cluster_security_group<span class=\"token punctuation\">,</span>\n    create_oidc_provider<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    version<span class=\"token operator\">=</span><span class=\"token string\">\"1.24\"</span><span class=\"token punctuation\">,</span>\n    instance_profile_name<span class=\"token operator\">=</span>karpenter_instance_profile<span class=\"token punctuation\">,</span>\n    skip_default_node_group<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    service_role<span class=\"token operator\">=</span>eks_iam_role<span class=\"token punctuation\">,</span>\n    provider_credential_opts<span class=\"token operator\">=</span>eks_provider<span class=\"token punctuation\">.</span>KubeconfigOptionsArgs<span class=\"token punctuation\">(</span>\n        profile_name<span class=\"token operator\">=</span>config<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    endpoint_private_access<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    endpoint_public_access<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    enabled_cluster_log_types<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"api\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"audit\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"authenticator\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"controllerManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"scheduler\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    public_access_cidrs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> demo_eks_cp_subnets<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    fargate<span class=\"token operator\">=</span>eks<span class=\"token punctuation\">.</span>FargateProfileArgs<span class=\"token punctuation\">(</span>\n        cluster_name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> demo_private_subnets<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        pod_execution_role_arn<span class=\"token operator\">=</span>fargate_profile_service_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n        selectors<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"namespace\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"namespace\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"flux-system\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"namespace\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kube-system\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n            demo_nodegroup_security_group<span class=\"token punctuation\">,</span>\n            eks_iam_role<span class=\"token punctuation\">,</span>\n            demo_eks_loggroup\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ndemo_eks_cluster_oidc_arn <span class=\"token operator\">=</span> demo_eks_cluster<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>oidc_provider<span class=\"token punctuation\">.</span>arn\ndemo_eks_cluster_oidc_url <span class=\"token operator\">=</span> demo_eks_cluster<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>oidc_provider<span class=\"token punctuation\">.</span>url\n\n<span class=\"token comment\"># Create an IAM role for VPC CNI:</span>\niam_role_vpc_cni_service_account <span class=\"token operator\">=</span> create_oidc_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-aws-node\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"kube-system\"</span><span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_arn<span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_url<span class=\"token punctuation\">,</span> <span class=\"token string\">\"aws-node\"</span><span class=\"token punctuation\">,</span> cni_service_account_policy_arns<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a Karpenter IAM role scoped to karpenter namespace</span>\niam_role_karpenter_controller_policy <span class=\"token operator\">=</span> create_policy<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-karpenter-policy\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter_oidc_role_policy.json\"</span><span class=\"token punctuation\">)</span>\niam_role_karpenter_controller_service_account_role <span class=\"token operator\">=</span> create_oidc_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-karpenter\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_arn<span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_url<span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>iam_role_karpenter_controller_policy<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nexport<span class=\"token punctuation\">(</span><span class=\"token string\">\"karpenter-oidc-role-arn\"</span><span class=\"token punctuation\">,</span> iam_role_karpenter_controller_service_account_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># Install VPC CNI addon when the cluster is initialized:</span>\nvpc_cni_addon <span class=\"token operator\">=</span> eks<span class=\"token punctuation\">.</span>Addon<span class=\"token punctuation\">(</span><span class=\"token string\">\"vpc-cni-addon\"</span><span class=\"token punctuation\">,</span>\n    cluster_name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    addon_name<span class=\"token operator\">=</span><span class=\"token string\">\"vpc-cni\"</span><span class=\"token punctuation\">,</span>\n    addon_version<span class=\"token operator\">=</span><span class=\"token string\">\"v1.11.4-eksbuild.1\"</span><span class=\"token punctuation\">,</span>\n    resolve_conflicts<span class=\"token operator\">=</span><span class=\"token string\">\"OVERWRITE\"</span><span class=\"token punctuation\">,</span>\n    service_account_role_arn<span class=\"token operator\">=</span>iam_role_vpc_cni_service_account<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Install kube-proxy addon when the cluster is initialized:</span>\nkube_proxy_addon <span class=\"token operator\">=</span> eks<span class=\"token punctuation\">.</span>Addon<span class=\"token punctuation\">(</span><span class=\"token string\">\"kube-proxy-addon\"</span><span class=\"token punctuation\">,</span>\n    cluster_name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    addon_name<span class=\"token operator\">=</span><span class=\"token string\">\"kube-proxy\"</span><span class=\"token punctuation\">,</span>\n    addon_version<span class=\"token operator\">=</span><span class=\"token string\">\"v1.24.7-eksbuild.2\"</span><span class=\"token punctuation\">,</span>\n    resolve_conflicts<span class=\"token operator\">=</span><span class=\"token string\">\"OVERWRITE\"</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">,</span> vpc_cni_addon<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Install CoreDNS addon when the cluster is initialized:</span>\ncore_dns_addon <span class=\"token operator\">=</span> eks<span class=\"token punctuation\">.</span>Addon<span class=\"token punctuation\">(</span><span class=\"token string\">\"coredns-addon\"</span><span class=\"token punctuation\">,</span>\n    cluster_name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n    addon_name<span class=\"token operator\">=</span><span class=\"token string\">\"coredns\"</span><span class=\"token punctuation\">,</span>\n    addon_version<span class=\"token operator\">=</span><span class=\"token string\">\"v1.8.7-eksbuild.3\"</span><span class=\"token punctuation\">,</span>\n    resolve_conflicts<span class=\"token operator\">=</span><span class=\"token string\">\"OVERWRITE\"</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">,</span> vpc_cni_addon<span class=\"token punctuation\">,</span> kube_proxy_addon<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a kubernetes provider</span>\nrole_provider <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>Provider<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-kubernetes-provider\"</span></span><span class=\"token punctuation\">,</span>\n    kubeconfig<span class=\"token operator\">=</span>demo_eks_cluster<span class=\"token punctuation\">.</span>kubeconfig<span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a service account and cluster role binding for flux controller</span>\nflux_service_account <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ServiceAccount<span class=\"token punctuation\">(</span><span class=\"token string\">\"flux-controller-service-account\"</span><span class=\"token punctuation\">,</span>\n    api_version<span class=\"token operator\">=</span><span class=\"token string\">\"v1\"</span><span class=\"token punctuation\">,</span>\n    kind<span class=\"token operator\">=</span><span class=\"token string\">\"ServiceAccount\"</span><span class=\"token punctuation\">,</span>\n    metadata<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ObjectMetaArgs<span class=\"token punctuation\">(</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-controller\"</span><span class=\"token punctuation\">,</span>\n        namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nflux_controller_cluster_role_binding <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>rbac<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ClusterRoleBinding<span class=\"token punctuation\">(</span><span class=\"token string\">\"flux-controller-sa-crb\"</span><span class=\"token punctuation\">,</span>\n    role_ref<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>rbac<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>RoleRefArgs<span class=\"token punctuation\">(</span>\n        api_group<span class=\"token operator\">=</span><span class=\"token string\">\"rbac.authorization.k8s.io\"</span><span class=\"token punctuation\">,</span>\n        kind<span class=\"token operator\">=</span><span class=\"token string\">\"ClusterRole\"</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"cluster-admin\"</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    subjects<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n        k8s<span class=\"token punctuation\">.</span>rbac<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>SubjectArgs<span class=\"token punctuation\">(</span>\n            kind<span class=\"token operator\">=</span><span class=\"token string\">\"ServiceAccount\"</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-controller\"</span><span class=\"token punctuation\">,</span>\n            namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create the bootstrap job for flux-cli</span>\nflux_bootstrap_job <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>batch<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>Job<span class=\"token punctuation\">(</span><span class=\"token string\">\"fluxBootstrapJob\"</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>flux_service_account<span class=\"token punctuation\">,</span> flux_controller_cluster_role_binding<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    metadata<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ObjectMetaArgs<span class=\"token punctuation\">(</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-bootstrap-job\"</span><span class=\"token punctuation\">,</span>\n        namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span><span class=\"token punctuation\">,</span>\n        annotations<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"pulumi.com/replaceUnready\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    spec<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>batch<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>JobSpecArgs<span class=\"token punctuation\">(</span>\n        backoff_limit<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        template<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>PodTemplateSpecArgs<span class=\"token punctuation\">(</span>\n            spec<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>PodSpecArgs<span class=\"token punctuation\">(</span>\n                service_account_name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-controller\"</span><span class=\"token punctuation\">,</span>\n                containers<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ContainerArgs<span class=\"token punctuation\">(</span>\n                    env<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>outputs<span class=\"token punctuation\">.</span>EnvVar<span class=\"token punctuation\">(</span>\n                        name<span class=\"token operator\">=</span><span class=\"token string\">\"GITHUB_TOKEN\"</span><span class=\"token punctuation\">,</span>\n                        value<span class=\"token operator\">=</span>flux_github_token\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    command<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">\"flux\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"bootstrap\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"github\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-interpolation\"><span class=\"token string\">f\"--owner=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>flux_github_repo_owner<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-interpolation\"><span class=\"token string\">f\"--repository=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>flux_github_repo_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-interpolation\"><span class=\"token string\">f\"--path=./clusters/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"--private=false\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"--personal=true\"</span>\n                    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    image<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"fluxcd/flux-cli:v</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>flux_cli_version<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n                    name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-bootstrap\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                restart_policy<span class=\"token operator\">=</span><span class=\"token string\">\"OnFailure\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Create a karpenter namespace:</span>\nkarpenter_namespace <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>Namespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"karpenter-namespace\"</span><span class=\"token punctuation\">,</span>\n    metadata<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Let’s break down the above code into steps.</p>\n<p>First, we created two custom security groups: one for the EKS cluster (<code class=\"language-text\">custom-cluster-attach-demo-k8s</code>) and one for the Karpenter-managed nodes (<code class=\"language-text\">custom-node-attach-demo-k8s</code>). We will keep these “ANY-ANY” for the sake of the demonstration. We created these to provide future fine-grained controls over the Karpenter node to control plane network traffic and traffic coming in from the potential load balancers we might have. Notice that the node security group has a tag <code class=\"language-text\">\"karpenter.sh/discovery\": \"k8s-demo\"</code> that would allow the Karpenter controller to auto-discover this security group and attach it to a node.</p>\n<p>Second, we created a default instance profile for Karpenter-managed nodes. This profile has to have several managed policies attached, as outlined in Karpenter documentation. Additionally, we made a default Fargate profile role to use with Fargate.</p>\n<p>Finally, we feed everything to the EKS cluster definition, create the cluster and export its OIDC provider configuration. We will need these to provision an IAM role for the Karpenter service account. Note this role’s ARN via the stack’s export variable <code class=\"language-text\">karpenter-oidc-role-arn</code>.</p>\n<p>Once our EKS cluster is ready, we will use the <code class=\"language-text\">pulumi-kubernetes</code> provider to create our <code class=\"language-text\">flux-cli</code> bootstrap job, feeding it the GitHub repository name and authentication token. This way, we effectively use our infrastructure-as-code stack to set up EKS to manage itself via GitOps.</p>\n<blockquote>\n<p>We can establish a boundary between the operations/platform team (the enabling infrastructure team or function) and the platform’s end users. From here on out, resources may be managed entirely by GitOps, with several considerations. This way, we enable broader team autonomy and less backlog coupling. Exceptions may include IAM roles for additional service accounts, security groups and rules - essentially all AWS objects we might need for the workloads running on Kubernetes to function.</p>\n</blockquote>\n<p>Pulumi up!</p>\n<h2>Installing Things the GitOps Way: Karpenter and Demo Workload</h2>\n<p>Once our Pulumi stack has successfully run, we can add Karpenter installation to our Flux configuration repository. Now go ahead and pull the most recent changes that Flux bootstrap committed to our configuration repo. Let’s install Karpenter:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> clusters/demo-k8s/karpenter\n<span class=\"token function\">touch</span> clusters/demo-k8s/karpenter/release.yaml <span class=\"token punctuation\">\\</span>\n    clusters/demo-k8s/karpenter/source.yaml</code></pre></div>\n<p>source.yaml:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> source.toolkit.fluxcd.io/v1beta2\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HelmRepository\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> karpenter\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 1m\n  <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> oci<span class=\"token punctuation\">:</span>//public.ecr.aws/karpenter\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> oci</code></pre></div>\n<p>release.yaml:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> helm.toolkit.fluxcd.io/v2beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HelmRelease\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> karpenter\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">targetNamespace</span><span class=\"token punctuation\">:</span> karpenter\n  <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 5m\n  <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span> karpenter\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v0.19.2\n      <span class=\"token key atrule\">sourceRef</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HelmRepository\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> karpenter\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10m\n  <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">serviceAccount</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter\"</span>\n      <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> INSERT KARPENTER ROLE ARN (\"karpenter<span class=\"token punctuation\">-</span>oidc<span class=\"token punctuation\">-</span>role<span class=\"token punctuation\">-</span>arn\" stack export)\n    <span class=\"token key atrule\">settings</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">aws</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">clusterName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"demo-k8s\"</span>\n        <span class=\"token key atrule\">clusterEndpoint</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"INSERT HTTPS CLUSTER ENDPOINT OBTAINED FROM EKS\"</span>\n        <span class=\"token key atrule\">defaultInstanceProfile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"KarpenterNodeInstanceProfile-demo-k8s\"</span>\n    <span class=\"token key atrule\">logLevel</span><span class=\"token punctuation\">:</span> info\n  <span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">crds</span><span class=\"token punctuation\">:</span> CreateReplace\n  <span class=\"token key atrule\">upgrade</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">crds</span><span class=\"token punctuation\">:</span> CreateReplace</code></pre></div>\n<p>Commit your changes and push. Verify that Flux successfully reconciled both HelmRepository and HelmRelease:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl <span class=\"token parameter variable\">-n</span> karpenter get helmrepository\nkubectl <span class=\"token parameter variable\">-n</span> karpenter get helmrelease</code></pre></div>\n<p>We should see a “Helm repository is ready” status and “Release reconciliation succeeded”, respectively.</p>\n<p>Now, let’s test our Karpenter in action. For this to work, we have to create a Provisioner:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> clusters/demo-k8s/karpenter-provisioner\n<span class=\"token function\">touch</span> clusters/demo-k8s/karpenter-provisioner/default.yaml</code></pre></div>\n<p>default.yaml:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> karpenter.sh/v1alpha5\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Provisioner\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">node-type</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>karpenter\n  <span class=\"token key atrule\">requirements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter.sh/capacity-type\"</span>\n      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"on-demand\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kubernetes.io/arch\"</span>\n      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"amd64\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"node.kubernetes.io/instance-type\"</span>\n      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"t3.small\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"t3.medium\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"t3a.small\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"t3a.medium\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 10Gi\n  <span class=\"token key atrule\">providerRef</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\n  <span class=\"token key atrule\">ttlSecondsAfterEmpty</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n  <span class=\"token key atrule\">ttlSecondsUntilExpired</span><span class=\"token punctuation\">:</span> <span class=\"token number\">43200</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> karpenter.k8s.aws/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AWSNodeTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">amiFamily</span><span class=\"token punctuation\">:</span> Bottlerocket\n  <span class=\"token key atrule\">subnetSelector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">karpenter.sh/discovery</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>k8s\n  <span class=\"token key atrule\">securityGroupSelector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">karpenter.sh/discovery</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>k8s\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"KarpenterWorkerNode\"</span></code></pre></div>\n<p>Commit your changes and push. Then, run <code class=\"language-text\">kubectl get provisioner</code> to verify successful reconciliation. Finally, our infrastructure set-up is complete.</p>\n<h2>Summing It All Up</h2>\n<p>Let’s create a demo workload.</p>\n<p>inflate.yaml:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> inflate\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> inflate\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> inflate\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-type</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>karpenter\n      <span class=\"token key atrule\">terminationGracePeriodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> inflate\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> public.ecr.aws/eks<span class=\"token punctuation\">-</span>distro/kubernetes/pause<span class=\"token punctuation\">:</span><span class=\"token number\">3.7</span>\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></code></pre></div>\n<p>Let’s quickly install it from the command line, scale out our deployment and observe Karpenter in action:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> inflate.yaml\nkubectl kubectl scale deployment inflate <span class=\"token parameter variable\">--replicas</span> <span class=\"token number\">5</span>\nkubectl logs <span class=\"token parameter variable\">-f</span> <span class=\"token parameter variable\">-n</span> karpenter <span class=\"token parameter variable\">-l</span> app.kubernetes.io/name<span class=\"token operator\">=</span>karpenter <span class=\"token parameter variable\">-c</span> controller</code></pre></div>\n<p>In a matter of seconds, we will observe a scaling-out event. Success!</p>\n<h2>Cleaning Up</h2>\n<p>Before running <code class=\"language-text\">pulumi destroy</code>, it is best to run <code class=\"language-text\">flux uninstall</code> first to remove all finalizers that might otherwise interfere with the stack’s resources and delete the EC2 instances that Karpenter spun up for us. Then, after Flux is uninstalled and the instances are terminated, run <code class=\"language-text\">pulumi destroy</code> to clean up.</p>","frontmatter":{"title":"EKS Series Part 1. Operationalizing EKS with Karpenter and Flux","date":"November 29, 2022","description":"Starting with the basics. Spinning up EKS clusters the DevOps way with Karpenter and Flux GitOps."}},"previous":{"fields":{"slug":"/ec2-autoscaling-groups-prometheus-metrics/"},"frontmatter":{"title":"AWS EC2 Auto Scaling, Target Tracking Policies and Prometheus Exporters"}},"next":null},"pageContext":{"id":"0267b2f6-f967-55dd-9359-a8f9cd0681db","previousPostId":"cfbe8729-5f29-5754-95f7-4837e543d14c","nextPostId":null}},"staticQueryHashes":["4135132960","805692932"]}