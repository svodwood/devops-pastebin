{"componentChunkName":"component---src-templates-blog-post-js","path":"/eks-part-two-cilium-karpenter-flux/","result":{"data":{"site":{"siteMetadata":{"title":"Yet Another DevOps Pastebin"}},"markdownRemark":{"id":"b5b855a6-7caf-5b8e-8c0c-0e1121325026","excerpt":"Introduction What’s up with eBPF? You are likely familiar with the technology and might have heard about Cilium before from observing the CNCF landscape. EKS…","html":"<h2>Introduction</h2>\n<p>What’s up with eBPF? You are likely familiar with the technology and might have heard about <a href=\"https://cilium.io\">Cilium</a> before from observing the CNCF landscape. <a href=\"https://anywhere.eks.amazonaws.com/\">EKS Anywhere</a> uses that for pod networking and security, in case you did not know! If not, it’s probably best to introduce Cilium by quoting the product website:</p>\n<blockquote>\n<p>Cilium is an open-source project to provide networking, security, and observability for cloud-native environments such as Kubernetes clusters and other container orchestration platforms.</p>\n</blockquote>\n<blockquote>\n<p>At the foundation of Cilium is a new Linux kernel technology called eBPF, which enables the dynamic insertion of powerful security, visibility, and networking control logic into the Linux kernel. eBPF provides high-performance networking, multi-cluster and multi-cloud capabilities, advanced load balancing, transparent encryption, extensive network security capabilities, transparent observability, and much more.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 365px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/e59491c804d38d27e0228019960353c1/2e8d1/cilium.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAER0lEQVR42nWU+1NUZRjH+Q+cshgtURwR1N9oxtRUwBQyxWahQJeQFdg77A12l2XBC7pcXKWwuIgimJpNIqSiKDKVFoJKcicgLySUM0Y6GDMluLuf5pyVRJ2eme95nznv83zP9znzvl8fj8eDEMLqcrlwu91MTEyI75qa29gsmc+RXTM46pjBZkkAP1y5Ie4JNUKt0DOVw0dIhI0Xw+XyoFZtofvrV2HAV8TPJ15BrUzgicvzUr37KamP2+1NRkdHuXa1jast7dwcuEXN6UbsSn/oeo2/Lvvy6JIvdL9OpmI2NacaGRj8leb2Hlrau8Xe/xROyjVb0kmQh2LOkrBpcwgOxx7MBinDZ6dBt6+Ie/XTsOg3sjNvL0mhC3BEBZMSNh9Lmun5kevPNqLUreHWqJ3+B5m03jGQoo+lwHkAm2Ie16qmc/3wdDLl/uR/eog06VoeGf3BHgjZ87GFB3Lm4vfekcfHJ0iQSTnXrKB92MKVPiO9922UfRmLLSOTkvJDqNIsKE1mSvZXYN+6ndMxs8C+gBFTIP9Yg+hXziE5Loa/H094FdpsNsq/2sQvD7P4adDMwEM7uwqjyXEUkKFVY1+3nqz315OhVpHj/ITSqCDICmTMEgTZCzkvnYPNluFVKDzu3B4iVhrOmR8T+a5DQ0X1h+h1arJz8zn4hh+jswMY9ZtHxcxZZOUXYFDLufiRL8Mpc+lNepOEiLe5OfS7l1A4R0LU1NSSnJyI0ZiKQZdCSWUV5neW86d/EPcDFol4ODcI85JlFFcdxpiixpyqQLElnpM1tU+PmusZYXX1SZJVCRgtagwGjZdwRQgj/oGMBCzij4BFPPAPIn3ZCkqrKtFp9ehSrSQlqqiuPvGMUEgGbw2zPmY5Od8E42xYgunAQrSpcnY4Cyme6cfIrHkiSmb4sWOPE41SS8Ka7Vg2HkQv+Yy1qyQM3r397B9arVbSy9/iSH84+1tX8UX/apQ5i8nL20umyUi6JAqzJAqbwcTuQiebIvTsVp1jZ1I1TnU98sidIodIODH+hHjZRnLrlnCg7V0+bwqjsmc1ptJgbFY7ZeVl6K0WdBYLZfvLyM62I1ubTYGyjm2y4zjktaTFlBIfJ+Px+GOvwsYLl4iSB1PZG0ZFZxhFTUuRaSQU7S0kZIOcaOMxESGRSvYV7ebjWDn2uKPkJp8iX36GdSFxNH7b4FXo8XiNIcOWwQeyYJKsoUTGLaYgL58tCh3SrefR7OtGs6+LuG0XkMl1FOQ7CF8ZhXSDlvdWxmC1es+gxz3lLo+NjdHV0UdXez93B+/RcL6O0A0KVEWdJOZeFiEQr4yU01Bfx9BvQ3T3dtLT2yn2PneXJ0lfDJVaS7TpGNriPlKK+4lOO45SpRE6Xqqd5PCZao6CL0412I62VpavlhARv5WI+G1i3nbj+nMGK+Alg33xS5MQ4mrLFc7V1YpoaW56WuPm/yb7F8t7YWkwZAcrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Cilium\"\n        title=\"Cilium\"\n        src=\"/devops-pastebin/static/e59491c804d38d27e0228019960353c1/2e8d1/cilium.png\"\n        srcset=\"/devops-pastebin/static/e59491c804d38d27e0228019960353c1/c26ae/cilium.png 158w,\n/devops-pastebin/static/e59491c804d38d27e0228019960353c1/6bdcf/cilium.png 315w,\n/devops-pastebin/static/e59491c804d38d27e0228019960353c1/2e8d1/cilium.png 365w\"\n        sizes=\"(max-width: 365px) 100vw, 365px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>From the 1.12 release onwards, Cilium has become an all-in-one tool encompassing an integrated ingress controller with Layer 7 load-balancing, sidecar-free service mesh, the possibility to inject Envoy configuration anywhere in the network and many other cool features.</p>\n<p>We will not get deep into the inner workings of eBPF in this post. Instead, we will build on top of the Pulumi automation we reviewed in <a href=\"https://svodwood.github.io/devops-pastebin/eks-part-one-karpenter-flux/\">Part 1</a> of the EKS series and operationalize a bare EKS cluster with Cilium, replacing the default AWS kube-proxy and VPC CNI. No Fargate this time. Additionally, there will be a separate EKS series post on Cilium’s implementation (and extension) of standard Kubernetes NetworkPolicy.</p>\n<p>Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out pulumi.com if you still need to become familiar with it. You can deploy this demo stack using the Pulumi button below.</p>\n<p><a href=\"https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-eks-cilium\"><img src=\"https://get.pulumi.com/new/button.svg\" alt=\"Deploy\"></a></p>\n<p>You may find the source code for this demo in <a href=\"https://github.com/svodwood/pulumi-eks-cilium\">this Github repo</a>. A sample Flux configuration repository for this project <a href=\"https://github.com/svodwood/eks-2-flux-config-repo\">is here</a>.</p>\n<h2>What We Are Going To Build</h2>\n<p>We will spin up a demo VPC and a Cilium-enabled EKS cluster. We will additionally create the necessary IAM roles for service accounts to run Cilium and Karpenter in the cluster. Finally, we will initialize a demo workload to check Cilium features using Flux as our GitOps engine.</p>\n<p>To start building, we are going to need to meet the prerequisites:</p>\n<ol>\n<li>An AWS account with a named AWS CLI profile configured.</li>\n<li>A working Pulumi environment.</li>\n<li>A GitHub repo to set up the GitOps flow powered by Flux.</li>\n<li>A GitHub personal access token.</li>\n<li><a href=\"https://fluxcd.io/flux/cmd/\">FluxCLI</a> installed locally.</li>\n<li><a href=\"https://github.com/cilium/cilium-cli\">Cilium CLI</a> installed locally.</li>\n</ol>\n<h2>Flux Configuration Repository Set-up</h2>\n<p>Before launching our Pulumi template, we must set up a Flux repository. This repository will hold all definitions of things running inside our EKS cluster on the applicative level. The demo template assumes we are using a personal public repo on GitHub. Because we will not be using EKS Fargate for this demo, Flux will bootstrap itself as expected without any intervention.</p>\n<h2>Pulumi Stack: Basic Infrastructure</h2>\n<p>As before, we will construct a VPC consisting of public subnets, private subnets for the Kubernetes worker nodes, and dedicated subnets for the EKS Control Plane network interfaces. However, we will only focus on this a little in this particular post since we are re-using the previous stack’s components, covered in <a href=\"https://svodwood.github.io/devops-pastebin/eks-part-one-karpenter-flux/\">Part 1</a>. We should still end up with the following:</p>\n<ol>\n<li>A couple of public subnets for our ingress endpoints.</li>\n<li>A couple of private subnets for our nodes.</li>\n<li>A couple of private subnets for our EKS control plane network interfaces.</li>\n<li>Several VPC endpoints to facilitate network connectivity between our EKS cluster and AWS API in a secure fashion.</li>\n</ol>\n<h2>Pulumi Stack: EKS, Cilium, Karpenter, Flux Bootstrap</h2>\n<p>First, we will highlight several IAM objects necessary to construct our working EKS environment, namely:</p>\n<ol>\n<li>An EKS service role.</li>\n<li>An IAM role for the cilium-controller service account.</li>\n<li>A Karpenter-managed node role and instance profile.</li>\n</ol>\n<p>Second, we will spin up an EKS cluster without Fargate profiles. Karpenter namespace is to be created as part of the cluster provisioning routine - bootstrapping the cluster to a minimal working state can be outsourced to Operations and subsequently passed to a development team for consumption. In this example, the development teams, in turn, can adopt the cluster using the established GitOps workflow. In addition, ops teams may use role-based access control to restrict the manipulation of resources in these “operations-managed” namespaces. Additionally, we will create a patch to disable the “aws-node” DaemonSet - we want to outsource proxying capability to Cilium completely.</p>\n<p>To install Cilium, we need a node group. To initialize a node group, we need functioning CNI software. It’s a chicken and egg situation, but thankfully, Pulumi will carry out our tasks in parallel to bring everything up eventually. Finally, a Flux bootstrap job will create all Flux controllers in our EKS cluster and set up a connection with our configuration GitHub repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token triple-quoted-string string\">\"\"\"\r\nShared EKS resources\r\n\"\"\"</span>\r\n\r\n<span class=\"token comment\"># Create an EKS cluster role:</span>\r\neks_iam_role_policy_arns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSClusterPolicy\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSVPCResourceController\"</span>\r\n<span class=\"token punctuation\">]</span>\r\n\r\neks_iam_role <span class=\"token operator\">=</span> create_iam_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-eks-role\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"eks.amazonaws.com\"</span><span class=\"token punctuation\">,</span> eks_iam_role_policy_arns<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a default node role for Karpenter:</span>\r\nkarpenter_default_nodegroup_role_policy_arns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy\"</span>\r\n<span class=\"token punctuation\">]</span>\r\n\r\n<span class=\"token comment\"># Cilium CNI service account policies:</span>\r\ncni_service_account_policy_arns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token string\">\"arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy\"</span>\r\n<span class=\"token punctuation\">]</span>\r\n\r\n<span class=\"token comment\"># Create a default demo EKS cluster nodegroup security group:</span>\r\ndemo_nodegroup_security_group <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-node-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    description<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\"> custom node security group\"</span></span><span class=\"token punctuation\">,</span>\r\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\r\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-node-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter.sh/discovery\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\ndemo_nodegroup_security_group_inbound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"inbound-eks-node-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ingress\"</span><span class=\"token punctuation\">,</span>\r\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\r\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\r\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span>\r\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    security_group_id<span class=\"token operator\">=</span>demo_nodegroup_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\ndemo_nodegroup_security_group_oubound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"outbound-eks-node-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"egress\"</span><span class=\"token punctuation\">,</span>\r\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\r\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    security_group_id<span class=\"token operator\">=</span>demo_nodegroup_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a default demo EKS cluster security group:</span>\r\ndemo_cluster_security_group <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroup<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-cluster-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    description<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\"> custom security group\"</span></span><span class=\"token punctuation\">,</span>\r\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\r\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"custom-cluster-attach-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\ndemo_cluster_security_group_inbound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"inbound-eks-cp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ingress\"</span><span class=\"token punctuation\">,</span>\r\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\r\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">443</span><span class=\"token punctuation\">,</span>\r\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span>\r\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    security_group_id<span class=\"token operator\">=</span>demo_cluster_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\ndemo_cluster_security_group_oubound_custom_cidrs <span class=\"token operator\">=</span> ec2<span class=\"token punctuation\">.</span>SecurityGroupRule<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"outbound-eks-cp-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"egress\"</span><span class=\"token punctuation\">,</span>\r\n    to_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n    protocol<span class=\"token operator\">=</span><span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\r\n    from_port<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n    cidr_blocks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    security_group_id<span class=\"token operator\">=</span>demo_cluster_security_group<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a default Karpenter node role and instance profile:</span>\r\nkarpenter_node_role <span class=\"token operator\">=</span> create_iam_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"KarpenterNodeRole-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Service\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ec2.amazonaws.com\"</span><span class=\"token punctuation\">,</span> karpenter_default_nodegroup_role_policy_arns<span class=\"token punctuation\">)</span>\r\nkarpenter_instance_profile <span class=\"token operator\">=</span> iam<span class=\"token punctuation\">.</span>InstanceProfile<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"KarpenterNodeInstanceProfile-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    role<span class=\"token operator\">=</span>karpenter_node_role<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\r\n    name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"KarpenterNodeInstanceProfile-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create an EKS log group:</span>\r\ndemo_eks_loggroup <span class=\"token operator\">=</span> cloudwatch<span class=\"token punctuation\">.</span>LogGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"demo-eks-loggroup\"</span><span class=\"token punctuation\">,</span> \r\n    name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"/aws/eks/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">/cluster\"</span></span><span class=\"token punctuation\">,</span>\r\n    tags<span class=\"token operator\">=</span>general_tags<span class=\"token punctuation\">,</span>\r\n    retention_in_days<span class=\"token operator\">=</span><span class=\"token number\">1</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token triple-quoted-string string\">\"\"\"\r\nCreate an EKS control plane\r\n\"\"\"</span>\r\n\r\n<span class=\"token comment\"># Create the cluster control plane:</span>\r\ndemo_eks_cluster <span class=\"token operator\">=</span> eks_provider<span class=\"token punctuation\">.</span>Cluster<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"eks-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    vpc_id<span class=\"token operator\">=</span>demo_vpc<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\r\n    instance_role<span class=\"token operator\">=</span>karpenter_node_role<span class=\"token punctuation\">,</span>\r\n    cluster_security_group<span class=\"token operator\">=</span>demo_cluster_security_group<span class=\"token punctuation\">,</span>\r\n    create_oidc_provider<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n    version<span class=\"token operator\">=</span><span class=\"token string\">\"1.24\"</span><span class=\"token punctuation\">,</span>\r\n    instance_profile_name<span class=\"token operator\">=</span>karpenter_instance_profile<span class=\"token punctuation\">,</span>\r\n    skip_default_node_group<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n    service_role<span class=\"token operator\">=</span>eks_iam_role<span class=\"token punctuation\">,</span>\r\n    provider_credential_opts<span class=\"token operator\">=</span>eks_provider<span class=\"token punctuation\">.</span>KubeconfigOptionsArgs<span class=\"token punctuation\">(</span>\r\n        profile_name<span class=\"token operator\">=</span>config<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    endpoint_private_access<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n    endpoint_public_access<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n    enabled_cluster_log_types<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"api\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"audit\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"authenticator\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"controllerManager\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"scheduler\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    public_access_cidrs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> demo_eks_cp_subnets<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    default_addons_to_remove<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"coredns\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"kube-proxy\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"vpc-cni\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    fargate<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\r\n            demo_nodegroup_security_group<span class=\"token punctuation\">,</span>\r\n            eks_iam_role<span class=\"token punctuation\">,</span>\r\n            demo_eks_loggroup\r\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n\r\ndemo_eks_cluster_oidc_arn <span class=\"token operator\">=</span> demo_eks_cluster<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>oidc_provider<span class=\"token punctuation\">.</span>arn\r\ndemo_eks_cluster_oidc_url <span class=\"token operator\">=</span> demo_eks_cluster<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>oidc_provider<span class=\"token punctuation\">.</span>url\r\n\r\n<span class=\"token comment\"># Create an IAM role for Cilium CNI:</span>\r\niam_role_vpc_cni_service_account_role <span class=\"token operator\">=</span> create_oidc_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-cilium\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"kube-system\"</span><span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_arn<span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_url<span class=\"token punctuation\">,</span> <span class=\"token string\">\"cilium-operator\"</span><span class=\"token punctuation\">,</span> cni_service_account_policy_arns<span class=\"token punctuation\">)</span>\r\nexport<span class=\"token punctuation\">(</span><span class=\"token string\">\"cilium-oidc-role-arn\"</span><span class=\"token punctuation\">,</span> iam_role_vpc_cni_service_account_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a Karpenter IAM role scoped to karpenter namespace:</span>\r\niam_role_karpenter_controller_policy <span class=\"token operator\">=</span> create_policy<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-karpenter-policy\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter_oidc_role_policy.json\"</span><span class=\"token punctuation\">)</span>\r\niam_role_karpenter_controller_service_account_role <span class=\"token operator\">=</span> create_oidc_role<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-karpenter\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_arn<span class=\"token punctuation\">,</span> demo_eks_cluster_oidc_url<span class=\"token punctuation\">,</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>iam_role_karpenter_controller_policy<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\nexport<span class=\"token punctuation\">(</span><span class=\"token string\">\"karpenter-oidc-role-arn\"</span><span class=\"token punctuation\">,</span> iam_role_karpenter_controller_service_account_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a kubernetes provider:</span>\r\nrole_provider <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>Provider<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">-kubernetes-provider\"</span></span><span class=\"token punctuation\">,</span>\r\n    kubeconfig<span class=\"token operator\">=</span>demo_eks_cluster<span class=\"token punctuation\">.</span>kubeconfig<span class=\"token punctuation\">,</span>\r\n    enable_server_side_apply<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Patch the aws-node DaemonSet to make sure it's unshedulable to any node in the cluster, using server side apply:</span>\r\npatch_aws_node <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>apps<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>DaemonSetPatch<span class=\"token punctuation\">(</span><span class=\"token string\">\"aws-node-patch\"</span><span class=\"token punctuation\">,</span>\r\n    metadata<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ObjectMetaPatchArgs<span class=\"token punctuation\">(</span>\r\n        annotations<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\r\n            <span class=\"token string\">\"pulumi.com/patchForce\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"aws-node\"</span><span class=\"token punctuation\">,</span>\r\n        namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    spec<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>apps<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>DaemonSetSpecPatchArgs<span class=\"token punctuation\">(</span>\r\n        template<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>PodTemplateSpecPatchArgs<span class=\"token punctuation\">(</span>\r\n            spec<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>PodSpecPatchArgs<span class=\"token punctuation\">(</span>\r\n                affinity<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>AffinityPatchArgs<span class=\"token punctuation\">(</span>\r\n                    node_affinity<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>NodeAffinityPatchArgs<span class=\"token punctuation\">(</span>\r\n                        required_during_scheduling_ignored_during_execution<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>NodeSelectorPatchArgs<span class=\"token punctuation\">(</span>\r\n                            node_selector_terms<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>NodeSelectorTermPatchArgs<span class=\"token punctuation\">(</span>\r\n                                match_expressions<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>NodeSelectorRequirementPatchArgs<span class=\"token punctuation\">(</span>\r\n                                    key<span class=\"token operator\">=</span><span class=\"token string\">\"kubernetes.io/os\"</span><span class=\"token punctuation\">,</span>\r\n                                    operator<span class=\"token operator\">=</span><span class=\"token string\">\"In\"</span><span class=\"token punctuation\">,</span>\r\n                                    values<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"no-schedule\"</span><span class=\"token punctuation\">]</span>\r\n                                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\r\n                            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\r\n                        <span class=\"token punctuation\">)</span>\r\n                    <span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\ncluster_endpoint_fqdn <span class=\"token operator\">=</span> demo_eks_cluster<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>endpoint\r\n\r\n<span class=\"token triple-quoted-string string\">\"\"\"\r\nCreate a managed node group and install Cilium via helm in parallel. A managed nodegroup will fail to reach a \"Ready\" state \r\nwithout the CNI daemon running and the helm chart will fail to install if no nodes are available. Let the race begin!\r\n\"\"\"</span>\r\n\r\n<span class=\"token comment\"># Create a cilium Helm release when the control plane is initialized:</span>\r\ncilium_cni_release <span class=\"token operator\">=</span> Release<span class=\"token punctuation\">(</span><span class=\"token string\">\"cilium-cni\"</span><span class=\"token punctuation\">,</span>\r\n    ReleaseArgs<span class=\"token punctuation\">(</span>\r\n        chart<span class=\"token operator\">=</span><span class=\"token string\">\"cilium\"</span><span class=\"token punctuation\">,</span>\r\n        version<span class=\"token operator\">=</span>cilium_release_version<span class=\"token punctuation\">,</span>\r\n        namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span><span class=\"token punctuation\">,</span>\r\n        repository_opts<span class=\"token operator\">=</span>RepositoryOptsArgs<span class=\"token punctuation\">(</span>\r\n            repo<span class=\"token operator\">=</span><span class=\"token string\">\"https://helm.cilium.io\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n        values<span class=\"token operator\">=</span>Output<span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span>iam_role_vpc_cni_service_account_role<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span> cluster_endpoint_fqdn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">apply</span><span class=\"token punctuation\">(</span>\r\n            <span class=\"token keyword\">lambda</span> args<span class=\"token punctuation\">:</span>\r\n                <span class=\"token punctuation\">{</span>\r\n                <span class=\"token string\">\"ingressController\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token string\">\"enabled\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"eni\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token string\">\"enabled\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n                    <span class=\"token string\">\"iamRole\"</span><span class=\"token punctuation\">:</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\r\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"ipam\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token string\">\"mode\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"eni\"</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"egressMasqueradeInterfaces\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"eth0\"</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"tunnel\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"disabled\"</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"loadBalancer\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token string\">\"algorithm\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"maglev\"</span>\r\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"kubeProxyReplacement\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"strict\"</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"k8sServiceHost\"</span><span class=\"token punctuation\">:</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"https://\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token string\">\"hubble\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token string\">\"relay\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                        <span class=\"token string\">\"enabled\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n                    <span class=\"token string\">\"ui\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\r\n                        <span class=\"token string\">\"enabled\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span>\r\n                    <span class=\"token punctuation\">}</span>\r\n                <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">,</span> patch_aws_node<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create an initial Nodegroup when the control plane is initialized:</span>\r\ninitial_managed_nodegroup <span class=\"token operator\">=</span> eks_provider<span class=\"token punctuation\">.</span>ManagedNodeGroup<span class=\"token punctuation\">(</span><span class=\"token string\">\"cilium-initial-nodegroup\"</span><span class=\"token punctuation\">,</span>\r\n    cluster<span class=\"token operator\">=</span>demo_eks_cluster<span class=\"token punctuation\">,</span>\r\n    node_group_name<span class=\"token operator\">=</span><span class=\"token string\">\"initial-nodegroup\"</span><span class=\"token punctuation\">,</span>\r\n    node_role<span class=\"token operator\">=</span>karpenter_node_role<span class=\"token punctuation\">,</span>\r\n    subnet_ids<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> demo_private_subnets<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    force_update_version<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\r\n    ami_type<span class=\"token operator\">=</span><span class=\"token string\">\"BOTTLEROCKET_ARM_64\"</span><span class=\"token punctuation\">,</span>\r\n    instance_types<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"t4g.medium\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    scaling_config<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token string\">\"desired_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token string\">\"min_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token string\">\"max_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    capacity_type<span class=\"token operator\">=</span><span class=\"token string\">\"ON_DEMAND\"</span><span class=\"token punctuation\">,</span>\r\n    tags<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token operator\">**</span>general_tags<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"cilium-initial-nodegroup\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    taints<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\r\n        <span class=\"token punctuation\">{</span>\r\n            <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"node.cilium.io/agent-not-ready\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token string\">\"effect\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"NO_EXECUTE\"</span>\r\n        <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">,</span> patch_aws_node<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Install CoreDNS addon when the cluster is initialized:</span>\r\ncore_dns_addon <span class=\"token operator\">=</span> eks<span class=\"token punctuation\">.</span>Addon<span class=\"token punctuation\">(</span><span class=\"token string\">\"coredns-addon\"</span><span class=\"token punctuation\">,</span>\r\n    cluster_name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n    addon_name<span class=\"token operator\">=</span><span class=\"token string\">\"coredns\"</span><span class=\"token punctuation\">,</span>\r\n    addon_version<span class=\"token operator\">=</span><span class=\"token string\">\"v1.8.7-eksbuild.3\"</span><span class=\"token punctuation\">,</span>\r\n    resolve_conflicts<span class=\"token operator\">=</span><span class=\"token string\">\"OVERWRITE\"</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>initial_managed_nodegroup<span class=\"token punctuation\">,</span> cilium_cni_release<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a service account and cluster role binding for flux controller</span>\r\nflux_service_account <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ServiceAccount<span class=\"token punctuation\">(</span><span class=\"token string\">\"flux-controller-service-account\"</span><span class=\"token punctuation\">,</span>\r\n    api_version<span class=\"token operator\">=</span><span class=\"token string\">\"v1\"</span><span class=\"token punctuation\">,</span>\r\n    kind<span class=\"token operator\">=</span><span class=\"token string\">\"ServiceAccount\"</span><span class=\"token punctuation\">,</span>\r\n    metadata<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ObjectMetaArgs<span class=\"token punctuation\">(</span>\r\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-controller\"</span><span class=\"token punctuation\">,</span>\r\n        namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\nflux_controller_cluster_role_binding <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>rbac<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ClusterRoleBinding<span class=\"token punctuation\">(</span><span class=\"token string\">\"flux-controller-sa-crb\"</span><span class=\"token punctuation\">,</span>\r\n    role_ref<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>rbac<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>RoleRefArgs<span class=\"token punctuation\">(</span>\r\n        api_group<span class=\"token operator\">=</span><span class=\"token string\">\"rbac.authorization.k8s.io\"</span><span class=\"token punctuation\">,</span>\r\n        kind<span class=\"token operator\">=</span><span class=\"token string\">\"ClusterRole\"</span><span class=\"token punctuation\">,</span>\r\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"cluster-admin\"</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    subjects<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\r\n        k8s<span class=\"token punctuation\">.</span>rbac<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>SubjectArgs<span class=\"token punctuation\">(</span>\r\n            kind<span class=\"token operator\">=</span><span class=\"token string\">\"ServiceAccount\"</span><span class=\"token punctuation\">,</span>\r\n            name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-controller\"</span><span class=\"token punctuation\">,</span>\r\n            namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span>\r\n        <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create the bootstrap job for flux-cli</span>\r\nflux_bootstrap_job <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>batch<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>Job<span class=\"token punctuation\">(</span><span class=\"token string\">\"fluxBootstrapJob\"</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>flux_service_account<span class=\"token punctuation\">,</span> flux_controller_cluster_role_binding<span class=\"token punctuation\">,</span> core_dns_addon<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    metadata<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ObjectMetaArgs<span class=\"token punctuation\">(</span>\r\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-bootstrap-job\"</span><span class=\"token punctuation\">,</span>\r\n        namespace<span class=\"token operator\">=</span><span class=\"token string\">\"kube-system\"</span><span class=\"token punctuation\">,</span>\r\n        annotations<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"pulumi.com/replaceUnready\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    spec<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>batch<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>JobSpecArgs<span class=\"token punctuation\">(</span>\r\n        backoff_limit<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\r\n        template<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>PodTemplateSpecArgs<span class=\"token punctuation\">(</span>\r\n            spec<span class=\"token operator\">=</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>PodSpecArgs<span class=\"token punctuation\">(</span>\r\n                service_account_name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-controller\"</span><span class=\"token punctuation\">,</span>\r\n                containers<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>ContainerArgs<span class=\"token punctuation\">(</span>\r\n                    env<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>outputs<span class=\"token punctuation\">.</span>EnvVar<span class=\"token punctuation\">(</span>\r\n                        name<span class=\"token operator\">=</span><span class=\"token string\">\"GITHUB_TOKEN\"</span><span class=\"token punctuation\">,</span>\r\n                        value<span class=\"token operator\">=</span>flux_github_token\r\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n                    command<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\r\n                        <span class=\"token string\">\"flux\"</span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string\">\"bootstrap\"</span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string\">\"github\"</span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string-interpolation\"><span class=\"token string\">f\"--owner=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>flux_github_repo_owner<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string-interpolation\"><span class=\"token string\">f\"--repository=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>flux_github_repo_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string-interpolation\"><span class=\"token string\">f\"--path=./clusters/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>cluster_descriptor<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string\">\"--private=false\"</span><span class=\"token punctuation\">,</span>\r\n                        <span class=\"token string\">\"--personal=true\"</span>\r\n                    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n                    image<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"fluxcd/flux-cli:v</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>flux_cli_version<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\r\n                    name<span class=\"token operator\">=</span><span class=\"token string\">\"flux-bootstrap\"</span><span class=\"token punctuation\">,</span>\r\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n                restart_policy<span class=\"token operator\">=</span><span class=\"token string\">\"OnFailure\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\"># Create a karpenter namespace:</span>\r\nkarpenter_namespace <span class=\"token operator\">=</span> k8s<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">.</span>Namespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"karpenter-namespace\"</span><span class=\"token punctuation\">,</span>\r\n    metadata<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    opts<span class=\"token operator\">=</span>ResourceOptions<span class=\"token punctuation\">(</span>\r\n        provider<span class=\"token operator\">=</span>role_provider<span class=\"token punctuation\">,</span>\r\n        depends_on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>demo_eks_cluster<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>When the stack is up, let’s go ahead and add Karpenter to our Flux configuration repository. This time, we will create all the necessary files and push them to the repo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 616px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/d89a5edcab63c71a445fed59bfbb4e10/40040/flux-repo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 119.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAABYlAAAWJQFJUiTwAAACfElEQVR42pWUW5OiMBCF/f8/bmqmRpF7AgnIHZKAPp6pbsXVna0VH7qSKPnqdPfp7Ma+h0gTjrLQkCJFnkleQ99HmiRIkxj+0cM49DgvC5w1/I3KM75XVye0dY1MCOxkNeA7zvHppzikCp+BwFco8eHF+DgmfKagfahqqM5C9w6eKODLEp7QiHTN/x0Shd1oLNp+gMwVjkGIOJVQRQk/jJAICc8PESUpUpnh63sPXVYwboZxC4edl9t55v1udg7TNEJrBSkECq2RpgniKMI4DDifz5jnGfPssNDqHJyzcNY+r7f9zjkHYwyaukWWZZBScqRpiqqq0LQt2rZF3/domoa/pTvWWlha/4orcLLo25EhSZKgLEvEcYwoCvkcRRGCIOAYhoEVW1bmfsUNaO5AivymVGvNMLp8uVwYtKr7F+wP0Fh0zQAhxFOQSioDgeu6fgm7A6fRMFAXmlMkGCmkfZZJhGHI0P+l+gQcO4OqqhHFEauiIBjV7HQ6cbrLsryEMZA+6toOeZ6zXahmpI6KP47jJsgvIFmCgKSKmkJA+p0sMk0TB+03KeQaThOKomB1V7tcVVLtfN/H4XDgeGWZJ9sM7QQhBQOos2vQZarfapnrVLhXtjHo2p4Bj12mteu6ey03p0wXVhOvaa/Tst/vGbzFMu5x9IZuQq5yrttqbGrQmvLWbjPQGouejK2vxl4fB4JuTfXJNuMwYuinmxevIALTecu4PQGbpsPBj5HnGVuDgNQceurfSfUOnKYWdR1A6xJhGOB4PEIptbkJv4GmR1VTeorVrQ8BWWl9TN8C9qNBoBpEPBUBPM9juxCYRvJdpTv30MW1o+929hH4A3LOCoUMM0+BAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Karpenter Configuration in Flux repository\"\n        title=\"Karpenter Configuration in Flux repository\"\n        src=\"/devops-pastebin/static/d89a5edcab63c71a445fed59bfbb4e10/40040/flux-repo.png\"\n        srcset=\"/devops-pastebin/static/d89a5edcab63c71a445fed59bfbb4e10/c26ae/flux-repo.png 158w,\n/devops-pastebin/static/d89a5edcab63c71a445fed59bfbb4e10/6bdcf/flux-repo.png 315w,\n/devops-pastebin/static/d89a5edcab63c71a445fed59bfbb4e10/40040/flux-repo.png 616w\"\n        sizes=\"(max-width: 616px) 100vw, 616px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We create a single file <code class=\"language-text\">karpenter.yaml</code> in the cluster’s directory to map the dependency between Karpenter’s Helm release and the Provisioner:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\r\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.toolkit.fluxcd.io/v1beta2\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Kustomization\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter<span class=\"token punctuation\">-</span>release\r\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> flux<span class=\"token punctuation\">-</span>system\r\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 5m\r\n  <span class=\"token key atrule\">retryInterval</span><span class=\"token punctuation\">:</span> 1m\r\n  <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10m\r\n  <span class=\"token key atrule\">sourceRef</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> GitRepository\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flux<span class=\"token punctuation\">-</span>system\r\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ./karpenter/karpenter<span class=\"token punctuation\">-</span>release\r\n  <span class=\"token key atrule\">prune</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n  <span class=\"token key atrule\">wait</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n<span class=\"token punctuation\">---</span>\r\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.toolkit.fluxcd.io/v1beta2\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Kustomization\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter<span class=\"token punctuation\">-</span>provisioners\r\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> flux<span class=\"token punctuation\">-</span>system\r\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">dependsOn</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter<span class=\"token punctuation\">-</span>release\r\n  <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 5m\r\n  <span class=\"token key atrule\">retryInterval</span><span class=\"token punctuation\">:</span> 1m\r\n  <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10m\r\n  <span class=\"token key atrule\">sourceRef</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> GitRepository\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flux<span class=\"token punctuation\">-</span>system\r\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ./karpenter/karpenter<span class=\"token punctuation\">-</span>provisioner\r\n  <span class=\"token key atrule\">prune</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n  <span class=\"token key atrule\">wait</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>We place the actual Flux definitions in the root of our configuration repository.</p>\n<p>Contents of <code class=\"language-text\">./karpenter/karpenter-release/source.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\r\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> source.toolkit.fluxcd.io/v1beta2\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HelmRepository\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter\r\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> karpenter\r\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 1m\r\n  <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> oci<span class=\"token punctuation\">:</span>//public.ecr.aws/karpenter\r\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> oci</code></pre></div>\n<p>Contents of <code class=\"language-text\">./karpenter/karpenter-release/release.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> helm.toolkit.fluxcd.io/v2beta1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HelmRelease\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter\r\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> karpenter\r\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">targetNamespace</span><span class=\"token punctuation\">:</span> karpenter\r\n  <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 5m\r\n  <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span> karpenter\r\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v0.19.2\r\n      <span class=\"token key atrule\">sourceRef</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HelmRepository\r\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> karpenter\r\n        <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> karpenter\r\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10m\r\n  <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n    <span class=\"token key atrule\">serviceAccount</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter\"</span>\r\n      <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>289512055556<span class=\"token punctuation\">:</span>role/demo<span class=\"token punctuation\">-</span>k8s<span class=\"token punctuation\">-</span>cilium<span class=\"token punctuation\">-</span>karpenter\r\n    <span class=\"token key atrule\">settings</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">aws</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">clusterName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"demo-k8s-cilium\"</span>\r\n        <span class=\"token key atrule\">clusterEndpoint</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://38FF0DCDA70C42D8F589305FF132A172.gr7.eu-central-1.eks.amazonaws.com\"</span>\r\n        <span class=\"token key atrule\">defaultInstanceProfile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"KarpenterNodeInstanceProfile-demo-k8s-cilium\"</span>\r\n    <span class=\"token key atrule\">logLevel</span><span class=\"token punctuation\">:</span> info\r\n  <span class=\"token key atrule\">install</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">crds</span><span class=\"token punctuation\">:</span> CreateReplace\r\n  <span class=\"token key atrule\">upgrade</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">crds</span><span class=\"token punctuation\">:</span> CreateReplace</code></pre></div>\n<p>Contents of <code class=\"language-text\">./karpenter/karpenter-provisioner/default.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> karpenter.sh/v1alpha5\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Provisioner\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\r\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">node-type</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>karpenter\r\n  <span class=\"token key atrule\">requirements</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"karpenter.sh/capacity-type\"</span>\r\n      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\r\n      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"on-demand\"</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kubernetes.io/arch\"</span>\r\n      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\r\n      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"arm64\"</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"node.kubernetes.io/instance-type\"</span>\r\n      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\r\n      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"t4g.small\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"t4g.medium\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"t4g.large\"</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\r\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 10Gi\r\n  <span class=\"token key atrule\">providerRef</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\r\n  <span class=\"token key atrule\">ttlSecondsAfterEmpty</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\r\n  <span class=\"token key atrule\">ttlSecondsUntilExpired</span><span class=\"token punctuation\">:</span> <span class=\"token number\">43200</span>\r\n<span class=\"token punctuation\">---</span>\r\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> karpenter.k8s.aws/v1alpha1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AWSNodeTemplate\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\r\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">amiFamily</span><span class=\"token punctuation\">:</span> Bottlerocket\r\n  <span class=\"token key atrule\">subnetSelector</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">karpenter.sh/discovery</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>k8s<span class=\"token punctuation\">-</span>cilium\r\n  <span class=\"token key atrule\">securityGroupSelector</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">karpenter.sh/discovery</span><span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">-</span>k8s<span class=\"token punctuation\">-</span>cilium\r\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"KarpenterWorkerNode\"</span></code></pre></div>\n<p>Verify that everything is up and running:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/f2f8c/karpenter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.51898734177215%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAvUlEQVR42oXOy2rDMBCFYWHJsnWJbEMxOJvkBUtKcdykaeNbnLRP/ReUbLppFx+H4cDMiKF75uW4o233jMOZZeqZh8/otkxc55HL2PO1TFymnu/rzHj+4P2t5XToOB32d8eO9nWHKKontNJorZFSIpVCqRQhBFKqmM772KVax/lPm+2Wuq5pmoayLKOiKAgh4JzDWUsIK7z3WGvvR2XyyN+SJEE06zVVVcVFxhjyPCfLskjrjJUzBJP+/9nDD8wIcZUY0i96AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Karpenter up and running\"\n        title=\"Karpenter up and running\"\n        src=\"/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/f058b/karpenter.png\"\n        srcset=\"/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/c26ae/karpenter.png 158w,\n/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/6bdcf/karpenter.png 315w,\n/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/f058b/karpenter.png 630w,\n/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/40601/karpenter.png 945w,\n/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/78612/karpenter.png 1260w,\n/devops-pastebin/static/acc8cbee7afad3f6adc0fe7395fe75c7/f2f8c/karpenter.png 1490w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Checking out Hubble UI</h2>\n<p>Let’s go ahead and verify our Cilium installation via Hubble UI by port-forwarding the UI service:</p>\n<p><code class=\"language-text\">kubectl -n kube-system port-forward svc/hubble-ui 8080:80</code></p>\n<p>It looks like everything is in order:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/fc651/hubble.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaUlEQVR42mVQi5KbMBDj/z+ybSAP8Nu7NiYpRjdrIM1dmRESsiyv6Qbj8fs+4dd1RD8qDOOIm9J4WIu7Mbhr07SJETqExqNzGCbJOOgYMAaHPw8N9RjRTZZgfIajAk8FkQsCzW94YZ5hQgZxBqVy+LlxPL7FtzSj81KQFoRU4AUsvDSEA6J1mJHmJ2JecO5pOcnzrp0Uyms3vyN8ain0GZQL4rvkR/4s/Dfh94mELRcYmsG54KECAqX9qj/yJ+S3dSak1vyJ81QbZyjPrURbaoUu/p8/99iY0V3vI6zz4JTBnECcoK2H86Fp8YV9iHAhHt6O5seISNzyLhC6aVIopWDbtoZ1XTEMA5zzqLU2T57n8wlmbvrMyrrNCstrQd/30Maik5PlqVVC2Av7ATnnw6/vQiL6yO6FJk+t8HK5QGmDTluH1+uFKoFtw991xfV2QyTavTYlsEghM2Tetda2JmznfUK51aQ0vgAlJQCE1LWPBAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Cilium up and running\"\n        title=\"Cilium up and running\"\n        src=\"/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/f058b/hubble.png\"\n        srcset=\"/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/c26ae/hubble.png 158w,\n/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/6bdcf/hubble.png 315w,\n/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/f058b/hubble.png 630w,\n/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/40601/hubble.png 945w,\n/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/78612/hubble.png 1260w,\n/devops-pastebin/static/3327a82abc8724faccd3fd799780b807/fc651/hubble.png 3016w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Summing It All Up</h2>\n<p>We successfully initialized an EKS cluster with a managed node group running Cilium, Flux and Karpenter. Cilium acts as a kube-proxy replacement in our specific case. In the next part of the EKS series, we will explore Cilium’s implementation (and extension) of standard Kubernetes NetworkPolicy, ingress capability and Envoy configuration. Stay tuned!</p>\n<h2>Cleaning Up</h2>\n<p>Before running <code class=\"language-text\">pulumi destroy</code>, it is best to run <code class=\"language-text\">flux uninstall</code> first to remove all finalizers that might otherwise interfere with the stack’s resources and delete the EC2 instances that Karpenter spun up for us. Then, after Flux is uninstalled and the instances are terminated, run <code class=\"language-text\">pulumi destroy</code> to clean up.</p>","frontmatter":{"title":"EKS Series Part 2. All That eBPF: Operationalizing EKS with Cilium, Karpenter and Flux","date":"December 22, 2022","description":"Continuing to explore EKS with Cilium networking, security and observability, Karpenter autoscaling and Flux GitOps."}},"previous":{"fields":{"slug":"/eks-part-one-karpenter-flux/"},"frontmatter":{"title":"EKS Series Part 1. Operationalizing EKS with Karpenter and Flux"}},"next":{"fields":{"slug":"/eks-part-three-cilium-webstore/"},"frontmatter":{"title":"EKS Series Part 3. All That eBPF: Exploring Cilium in the Real World"}}},"pageContext":{"id":"b5b855a6-7caf-5b8e-8c0c-0e1121325026","previousPostId":"0267b2f6-f967-55dd-9359-a8f9cd0681db","nextPostId":"052162fa-1fe7-5143-8ac0-8aaf9fec1bcc"}},"staticQueryHashes":["4135132960","805692932"],"slicesMap":{}}