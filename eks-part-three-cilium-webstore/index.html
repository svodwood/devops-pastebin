<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.3.3"/><meta name="description" content="Exploring Cilium in a real-world web workload scenario with the help of Saleor, a distributed e-commerce platform." data-gatsby-head="true"/><meta property="og:title" content="EKS Series Part 3. All That eBPF: Exploring Cilium in the Real World" data-gatsby-head="true"/><meta property="og:description" content="Exploring Cilium in a real-world web workload scenario with the help of Saleor, a distributed e-commerce platform." data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="" data-gatsby-head="true"/><meta name="twitter:title" content="EKS Series Part 3. All That eBPF: Exploring Cilium in the Real World" data-gatsby-head="true"/><meta name="twitter:description" content="Exploring Cilium in a real-world web workload scenario with the help of Saleor, a distributed e-commerce platform." data-gatsby-head="true"/><style data-href="/devops-pastebin/styles.85ce37a33cee9bdbc90b.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/devops-pastebin/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/devops-pastebin/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/devops-pastebin/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/devops-pastebin/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/devops-pastebin/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/devops-pastebin/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/devops-pastebin/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/devops-pastebin/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/devops-pastebin/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/devops-pastebin/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/devops-pastebin/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/devops-pastebin/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/devops-pastebin/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/devops-pastebin/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/devops-pastebin/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/devops-pastebin/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/devops-pastebin/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/devops-pastebin/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/devops-pastebin/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/devops-pastebin/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/devops-pastebin/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/devops-pastebin/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/devops-pastebin/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/devops-pastebin/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/devops-pastebin/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/devops-pastebin/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/devops-pastebin/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/devops-pastebin/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-2xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#005b99;--color-text:#2e353f;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text-light);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio p,.bio-avatar{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><title data-gatsby-head="true">EKS Series Part 3. All That eBPF: Exploring Cilium in the Real World | Yet Another DevOps Pastebin</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-HKJ4LSENQ9"></script><script>
    window.GATSBY_GTAG_PLUGIN_GA_TRACKING_ID = (
      'G-HKJ4LSENQ9'
    );
    window.GATSBY_GTAG_PLUGIN_ANONYMIZE = true;

    var options = {
      send_page_view: false
    };
    if (true) {
      options.anonymize_ip = true;
    }

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', 'G-HKJ4LSENQ9', options);
  </script><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="alternate" type="application/rss+xml" title="Sergey&#x27;s DevOps Pastebin RSS Feed" href="/devops-pastebin/rss.xml"/><link rel="icon" href="/devops-pastebin/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/devops-pastebin/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/devops-pastebin/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/devops-pastebin/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/devops-pastebin/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/devops-pastebin/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/devops-pastebin/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/devops-pastebin/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/devops-pastebin/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/devops-pastebin/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header class="global-header"><a class="header-link-home" href="/devops-pastebin/">Yet Another DevOps Pastebin</a></header><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">EKS Series Part 3. All That eBPF: Exploring Cilium in the Real World</h1><p>January 10, 2023</p></header><section itemProp="articleBody"><h2>Introduction</h2>
<p>In this post, we will build on the knowledge we obtained in <a href="https://svodwood.github.io/devops-pastebin/eks-part-two-cilium-karpenter-flux/">Part 2</a> of the EKS series and explore the practical application of Cilium security and observability controls. We will create a functional web store with the help of <a href="https://saleor.io/">Saleor</a>, a relatively young cloud and container-friendly open-source e-commerce platform. We will utilize several managed AWS services to help us: S3 for our static assets hosting, Amazon RDS for PostgreSQL to store our stateful data, Amazon Elasticache for Redis as a caching layer and EKS with Karpenter. As usual, Flux, the GitOps engine, will drive the cluster workload provisioning. During the demo, we will emphasize several best-practise security controls we implemented across our infrastructure. Who doesn’t want a secure web store, right?</p>
<p>Pulumi IaC will help us bring up our infrastructure on the AWS Cloud. Check out pulumi.com if you still need to become familiar with it. You can deploy this demo stack using the Pulumi button below.</p>
<p><a href="https://app.pulumi.com/new?template=https://github.com/svodwood/pulumi-eks-cilium-demo-webstore"><img src="https://get.pulumi.com/new/button.svg" alt="Deploy"></a></p>
<p>You may find the source code for this demo in <a href="https://github.com/svodwood/pulumi-eks-cilium-demo-webstore">this Github repo</a>. A sample Flux configuration repository for this project <a href="https://github.com/svodwood/eks-3-flux-config-repo">is here</a>.</p>
<h2>What We Are Going To Build</h2>
<p>We aim to build a secure and highly available web store driven by Saleor on Kubernetes, running on EKS. Cilium network policy CRDs, Kubernetes ingresses and services will allow us to control the WAN traffic and server-to-server communications between various elements in the ecosystem. According to Saleor’s <a href="https://docs.saleor.io/docs/3.x/category/overview">documentation</a>, we should have the following components up and running:</p>
<ol>
<li><a href="https://github.com/saleor/saleor">Saleor Core</a> - the store’s backend.</li>
<li><a href="https://github.com/saleor/saleor-dashboard">Saleor Dashboard</a> - the store administration presentation layer.</li>
<li><a href="https://github.com/saleor/react-storefront">Saleor Storefront</a> - the actual web store presentation layer.</li>
<li><a href="https://redis.io/docs/">Redis</a> cache that Saleor Core uses.</li>
<li><a href="https://www.postgresql.org/docs/">PostgreSQL</a> database that Saleor Core uses to store state.</li>
</ol>
<p>Much like the previous post, we will spin up our best-practice VPC (this time adding some database subnets) and a demo EKS cluster, initialized with Cilium CNI, Karpenter and Flux controller. Additionally, we will create several S3 buckets, a PostgreSQL database and a Redis cluster over Elasticache.</p>
<h2>Flux Configuration Repository Set-up</h2>
<p>Before launching our Pulumi template, we must set up a Flux repository. This repository will hold all definitions of things running inside our EKS cluster on the applicative level. The demo template assumes we are using a personal public repo on GitHub. Because we will not be using EKS Fargate for this demo again, Flux will bootstrap itself as expected without any intervention.</p>
<h2>Pulumi Stack: Basic Infrastructure, Redis, PostgreSQL, S3</h2>
<p>To understand the flow of our infrastructure-as-code stack, we should first look at our main.py:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""An AWS Python Pulumi program"""</span>

<span class="token keyword">import</span> pulumi

<span class="token keyword">import</span> settings
<span class="token keyword">import</span> helpers
<span class="token keyword">import</span> s3
<span class="token keyword">import</span> vpc
<span class="token keyword">import</span> subnet_groups
<span class="token keyword">import</span> vpc_endpoints
<span class="token keyword">import</span> elasticache
<span class="token keyword">import</span> rds
<span class="token keyword">import</span> eks</code></pre></div>
<p>Skipping self-explanatory settings and helpers, we start with creating several S3 buckets:</p>
<ol>
<li>A bucket for Saleor Dashboard - a static web application for store administrators.</li>
<li>A bucket for static assets of Django (Saleor Core) - like CSS, js and the like.</li>
<li>A bucket for media files like images and videos used by the store.</li>
</ol>
<blockquote>
<p>Everything we host in S3 will not be served directly from S3 or CloudFront. Instead, we will use Nginx <a href="https://github.com/nginxinc/nginx-s3-gateway">proxy pods</a> to bring the application delivery layer into the Kubernetes cluster. This way, we have fine-grained control using ingress resources and can utilize Cilium’s functionality. Operating such a set-up in production would likely require fine-tuning due to the nature of the Nginx proxy and the way it authenticates against AWS sts API. Specifically, there would be a trade-off between the cache duration and the number of calls we make to AWS API.</p>
</blockquote>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
s3.py
"""</span>

<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> s3
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> export<span class="token punctuation">,</span> ResourceOptions

<span class="token keyword">from</span> settings <span class="token keyword">import</span> general_tags<span class="token punctuation">,</span> saleor_storefront_bucket_name<span class="token punctuation">,</span> saleor_dashboard_bucket_name<span class="token punctuation">,</span> saleor_media_bucket_name<span class="token punctuation">,</span> saleor_static_bucket_name

<span class="token triple-quoted-string string">"""
Create three S3 buckets: admin dashboard static frontend, media bucket and static assets bucket
"""</span>

<span class="token comment"># Create the saleor dashboard bucket:</span>
saleor_dashboard_bucket <span class="token operator">=</span> s3<span class="token punctuation">.</span>Bucket<span class="token punctuation">(</span><span class="token string">"saleor-dashboard-bucket"</span><span class="token punctuation">,</span>
    bucket<span class="token operator">=</span>saleor_dashboard_bucket_name<span class="token punctuation">,</span>
    force_destroy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>general_tags
<span class="token punctuation">)</span>

<span class="token comment"># Disable ACL's for saleor dashboard bucket:</span>
saleor_dashboard_bucket_ownership_controls <span class="token operator">=</span> s3<span class="token punctuation">.</span>BucketOwnershipControls<span class="token punctuation">(</span><span class="token string">"saleor-dashboard-bucket-acl"</span><span class="token punctuation">,</span>
    bucket<span class="token operator">=</span>saleor_dashboard_bucket<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    rule<span class="token operator">=</span>s3<span class="token punctuation">.</span>BucketOwnershipControlsRuleArgs<span class="token punctuation">(</span>
        object_ownership<span class="token operator">=</span><span class="token string">"BucketOwnerEnforced"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Create the saleor media bucket:</span>
saleor_media_bucket <span class="token operator">=</span> s3<span class="token punctuation">.</span>Bucket<span class="token punctuation">(</span><span class="token string">"saleor-media-bucket"</span><span class="token punctuation">,</span>
    bucket<span class="token operator">=</span>saleor_media_bucket_name<span class="token punctuation">,</span>
    force_destroy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>general_tags
<span class="token punctuation">)</span>

<span class="token comment"># Disable ACL's for saleor media bucket:</span>
saleor_media_bucket_ownership_controls <span class="token operator">=</span> s3<span class="token punctuation">.</span>BucketOwnershipControls<span class="token punctuation">(</span><span class="token string">"saleor-media-bucket-acl"</span><span class="token punctuation">,</span>
    bucket<span class="token operator">=</span>saleor_media_bucket<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    rule<span class="token operator">=</span>s3<span class="token punctuation">.</span>BucketOwnershipControlsRuleArgs<span class="token punctuation">(</span>
        object_ownership<span class="token operator">=</span><span class="token string">"BucketOwnerEnforced"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Create the saleor static assets bucket:</span>
saleor_static_bucket <span class="token operator">=</span> s3<span class="token punctuation">.</span>Bucket<span class="token punctuation">(</span><span class="token string">"saleor-static-bucket"</span><span class="token punctuation">,</span>
    bucket<span class="token operator">=</span>saleor_static_bucket_name<span class="token punctuation">,</span>
    force_destroy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>general_tags
<span class="token punctuation">)</span>
<span class="token comment"># Disable ACL's for saleor static bucket:</span>
saleor_static_bucket_ownership_controls <span class="token operator">=</span> s3<span class="token punctuation">.</span>BucketOwnershipControls<span class="token punctuation">(</span><span class="token string">"saleor-static-bucket-acl"</span><span class="token punctuation">,</span>
    bucket<span class="token operator">=</span>saleor_static_bucket<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    rule<span class="token operator">=</span>s3<span class="token punctuation">.</span>BucketOwnershipControlsRuleArgs<span class="token punctuation">(</span>
        object_ownership<span class="token operator">=</span><span class="token string">"BucketOwnerEnforced"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>Next, we are going to create the VPC and subnets, as usual:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
vpc.py
"""</span>

<span class="token keyword">import</span> pulumi
<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> ec2<span class="token punctuation">,</span> config<span class="token punctuation">,</span> get_availability_zones
<span class="token keyword">from</span> settings <span class="token keyword">import</span> general_tags<span class="token punctuation">,</span> cluster_descriptor<span class="token punctuation">,</span> demo_vpc_cidr<span class="token punctuation">,</span> demo_private_subnet_cidrs<span class="token punctuation">,</span> demo_public_subnet_cidrs<span class="token punctuation">,</span> demo_eks_cp_subnet_cidrs<span class="token punctuation">,</span> demo_db_subnet_cidrs

<span class="token triple-quoted-string string">"""
Creates a minium of AWS networking objects required for the demo stack to work
"""</span>

<span class="token comment"># Create a VPC and Internet Gateway:</span>
demo_vpc <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Vpc<span class="token punctuation">(</span><span class="token string">"demo-vpc"</span><span class="token punctuation">,</span>
    cidr_block<span class="token operator">=</span>demo_vpc_cidr<span class="token punctuation">,</span>
    enable_dns_hostnames<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    enable_dns_support<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-vpc-</span><span class="token interpolation"><span class="token punctuation">{</span>config<span class="token punctuation">.</span>region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

demo_igw <span class="token operator">=</span> ec2<span class="token punctuation">.</span>InternetGateway<span class="token punctuation">(</span><span class="token string">"demo-igw"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-igw-</span><span class="token interpolation"><span class="token punctuation">{</span>config<span class="token punctuation">.</span>region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Create a default any-any security group for demo purposes:</span>
demo_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"demo-security-group"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Allow any-any"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    ingress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupIngressArgs<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any"</span><span class="token punctuation">,</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    egress<span class="token operator">=</span><span class="token punctuation">[</span>ec2<span class="token punctuation">.</span>SecurityGroupEgressArgs<span class="token punctuation">(</span>
        from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
        cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ipv6_cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"::/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-sg-</span><span class="token interpolation"><span class="token punctuation">{</span>config<span class="token punctuation">.</span>region<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Create subnets:</span>
demo_azs <span class="token operator">=</span> get_availability_zones<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">"available"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>names
demo_public_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
demo_private_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
demo_eks_cp_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
demo_db_subnets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    
    demo_public_subnet <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-public-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>demo_public_subnet_cidrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-public-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_public_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>demo_public_subnet<span class="token punctuation">)</span>

    demo_public_route_table <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-public-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-public-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_public_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_public_route_table_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-public-rt-association-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_public_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>demo_public_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_public_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_public_wan_route <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-public-wan-route-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_public_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        gateway_id<span class="token operator">=</span>demo_igw<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_public_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_eip <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Eip<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-eip-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-eip-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_nat_gateway <span class="token operator">=</span> ec2<span class="token punctuation">.</span>NatGateway<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-nat-gateway-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        allocation_id<span class="token operator">=</span>demo_eip<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>demo_public_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-nat-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_vpc<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_private_subnet <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-private-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>demo_private_subnet_cidrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"cilium-pod-interfaces"</span><span class="token punctuation">:</span> <span class="token string">"private"</span> <span class="token punctuation">,</span><span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-private-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"karpenter.sh/discovery"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_private_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>demo_private_subnet<span class="token punctuation">)</span>

    demo_private_route_table <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-private-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-private-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_private_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_private_route_table_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-private-rt-association-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_private_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>demo_private_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_private_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_private_wan_route <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-private-wan-route-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_private_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        nat_gateway_id<span class="token operator">=</span>demo_nat_gateway<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_private_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_eks_cp_subnet <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-eks-cp-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>demo_eks_cp_subnet_cidrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-eks-cp-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_eks_cp_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>demo_eks_cp_subnet<span class="token punctuation">)</span>

    demo_eks_cp_route_table <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-eks-cp-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-eks-cp-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_eks_cp_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo__eks_cp_route_table_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-eks-cp-rt-association-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_eks_cp_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>demo_eks_cp_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_eks_cp_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_eks_cp_wan_route <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-eks-cp-wan-route-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_eks_cp_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        nat_gateway_id<span class="token operator">=</span>demo_nat_gateway<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_eks_cp_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_db_subnet <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Subnet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-db-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        cidr_block<span class="token operator">=</span>demo_db_subnet_cidrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        availability_zone<span class="token operator">=</span>demo_azs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-db-subnet-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo_db_subnets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>demo_db_subnet<span class="token punctuation">)</span>

    demo_db_route_table <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTable<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-db-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-db-rt-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_db_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    demo__db_route_table_association <span class="token operator">=</span> ec2<span class="token punctuation">.</span>RouteTableAssociation<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-db-rt-association-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_eks_cp_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        subnet_id<span class="token operator">=</span>demo_db_subnet<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_db_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    demo_db_wan_route <span class="token operator">=</span> ec2<span class="token punctuation">.</span>Route<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-db-wan-route-</span><span class="token interpolation"><span class="token punctuation">{</span>prefix<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        route_table_id<span class="token operator">=</span>demo_db_route_table<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        nat_gateway_id<span class="token operator">=</span>demo_nat_gateway<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        destination_cidr_block<span class="token operator">=</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">,</span>
        opts<span class="token operator">=</span>pulumi<span class="token punctuation">.</span>ResourceOptions<span class="token punctuation">(</span>parent<span class="token operator">=</span>demo_db_subnet<span class="token punctuation">)</span>
    <span class="token punctuation">)</span></code></pre></div>
<p>Notice above how we added some dedicated subnets for our PostgreSQL database. In addition, our VPC contains a pair of public subnets for our load balancer interfaces, private subnets for our Kubernetes nodes and dedicated private subnets for the EKS control plane network interfaces.</p>
<p>Next, let’s handle the subnet groups for our Elasticache and RDS resources. Subnet groups are a collection of subnets we dedicate to specific clusters, SQL or NoSQL.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
subnet_groups.py
"""</span>

<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> rds<span class="token punctuation">,</span> elasticache

<span class="token keyword">from</span> settings <span class="token keyword">import</span> general_tags
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> demo_vpc<span class="token punctuation">,</span> demo_db_subnets

demo_postgresql_subnet_group <span class="token operator">=</span> rds<span class="token punctuation">.</span>SubnetGroup<span class="token punctuation">(</span><span class="token string">"demo-postgresql-subnet-group"</span><span class="token punctuation">,</span>
    subnet_ids<span class="token operator">=</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> demo_db_subnets<span class="token punctuation">]</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Saleor PostgreSQL Subnet Group"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-postgresql-subnet-group"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

demo_redis_subnet_group <span class="token operator">=</span> elasticache<span class="token punctuation">.</span>SubnetGroup<span class="token punctuation">(</span><span class="token string">"demo-redis-subnet-group"</span><span class="token punctuation">,</span>
    subnet_ids<span class="token operator">=</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> demo_db_subnets<span class="token punctuation">]</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Saleor Redis Subnet Group"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"demo-redis-subnet-group"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span></code></pre></div>
<p>To establish private communication between AWS services and our EKS cluster, we need to build several VPC Interface endpoints. We will use a shared security group with port 443 open from our VPC CIDR range for simplicity. Here is the list of endpoints:</p>
<ul>
<li>ecr.api</li>
<li>ecr.dkr</li>
<li>ec2</li>
<li>sts</li>
<li>logs</li>
<li>s3</li>
<li>email-smtp</li>
<li>cloudformation</li>
</ul>
<p>Below is the code:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
vpc_endpoints.py
"""</span>

<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> ec2
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> ResourceOptions
<span class="token keyword">from</span> settings <span class="token keyword">import</span> deployment_region<span class="token punctuation">,</span> endpoint_services<span class="token punctuation">,</span> general_tags<span class="token punctuation">,</span> demo_vpc_cidr
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> demo_vpc<span class="token punctuation">,</span> demo_private_subnets


<span class="token comment"># Create a shared security group for all AWS services VPC endpoints:</span>
vpc_endpoints_sg <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string">"aws-vpc-endpoints-sg"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Shared security groups for AWS services VPC endpoints"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"aws-vpc-endpoints-sg"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

inbound_endpoints_cidrs <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string">"inbound-vpc-endpoint-cidrs"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"tcp"</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span>demo_vpc_cidr<span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>vpc_endpoints_sg<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

outbound_endpoints_cidrs <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string">"outbound-vpc-endpoint-cidrs"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"egress"</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>vpc_endpoints_sg<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Create VPC endpoints:</span>
endpoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> service <span class="token keyword">in</span> endpoint_services<span class="token punctuation">:</span>
    <span class="token keyword">if</span> service <span class="token operator">==</span> <span class="token string">"s3"</span><span class="token punctuation">:</span>
        enable_dns <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        enable_dns <span class="token operator">=</span> <span class="token boolean">True</span>
    endpoints<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ec2<span class="token punctuation">.</span>VpcEndpoint<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>service<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">-vpc-endpoint"</span></span><span class="token punctuation">,</span>
        vpc_id <span class="token operator">=</span> demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        service_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"com.amazonaws.</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>service<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        vpc_endpoint_type <span class="token operator">=</span> <span class="token string">"Interface"</span><span class="token punctuation">,</span>
        subnet_ids <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> demo_private_subnets<span class="token punctuation">]</span><span class="token punctuation">,</span>
        security_group_ids <span class="token operator">=</span> <span class="token punctuation">[</span>vpc_endpoints_sg<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        private_dns_enabled <span class="token operator">=</span> enable_dns<span class="token punctuation">,</span>
        tags <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>service<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">-vpc-endpoint"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        opts <span class="token operator">=</span> ResourceOptions<span class="token punctuation">(</span>
            depends_on<span class="token operator">=</span><span class="token punctuation">[</span>vpc_endpoints_sg<span class="token punctuation">]</span><span class="token punctuation">,</span>
            parent<span class="token operator">=</span>demo_vpc<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>Next, we provision an Elasticache Redis cluster for our Saleor core pods. Finally, we allow connection over port 6379 from our private Kubernetes node subnets. We will utilize AWS SSM Parameter Store to store the entire Redis connection string that our Saleor core application will consume later.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
elasticache.py
"""</span>

<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> elasticache<span class="token punctuation">,</span> cloudwatch<span class="token punctuation">,</span> ec2<span class="token punctuation">,</span> ssm
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> export<span class="token punctuation">,</span> Output

<span class="token keyword">from</span> settings <span class="token keyword">import</span> general_tags<span class="token punctuation">,</span> redis_instance_size<span class="token punctuation">,</span> demo_private_subnet_cidrs<span class="token punctuation">,</span> redis_connection_string_ssm_parameter_name
<span class="token keyword">from</span> subnet_groups <span class="token keyword">import</span> demo_redis_subnet_group
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> demo_vpc

<span class="token triple-quoted-string string">"""
Create the Redis Cloudwatch log group:
"""</span>
demo_redis_loggroup <span class="token operator">=</span> cloudwatch<span class="token punctuation">.</span>LogGroup<span class="token punctuation">(</span><span class="token string">"demo-redis-loggroup"</span><span class="token punctuation">,</span> 
    name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"/aws/elasticache/redis"</span></span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>general_tags<span class="token punctuation">,</span>
    retention_in_days<span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Create a Redis cluster security group:
"""</span>
demo_redis_security_group <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-redis-security-group"</span></span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Redis security group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"demo-redis-security-group"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow tcp Redis traffic from application subnets:</span>
demo_redis_security_group_inbound <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string">"demo-redis-security-group-inbound"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"tcp"</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span>demo_private_subnet_cidrs<span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_redis_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow outbound ANY:</span>
demo_redis_security_group_oubound <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string">"demo-redis-security-group-outbound"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"egress"</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_redis_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Create a Redis cluster:
"""</span>
demo_redis_cluster <span class="token operator">=</span> elasticache<span class="token punctuation">.</span>ReplicationGroup<span class="token punctuation">(</span><span class="token string">"demo-saleor-core-redis-cluster"</span><span class="token punctuation">,</span>
    automatic_failover_enabled<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Saleor Core Cache"</span><span class="token punctuation">,</span>
    node_type<span class="token operator">=</span>redis_instance_size<span class="token punctuation">,</span>
    multi_az_enabled<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    parameter_group_name<span class="token operator">=</span><span class="token string">"default.redis7"</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span>
    num_cache_clusters<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    subnet_group_name<span class="token operator">=</span>demo_redis_subnet_group<span class="token punctuation">,</span>
    security_group_ids<span class="token operator">=</span><span class="token punctuation">[</span>demo_redis_security_group<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    log_delivery_configurations<span class="token operator">=</span><span class="token punctuation">[</span>
        elasticache<span class="token punctuation">.</span>ReplicationGroupLogDeliveryConfigurationArgs<span class="token punctuation">(</span>
            destination<span class="token operator">=</span>demo_redis_loggroup<span class="token punctuation">,</span>
            destination_type<span class="token operator">=</span><span class="token string">"cloudwatch-logs"</span><span class="token punctuation">,</span>
            log_format<span class="token operator">=</span><span class="token string">"text"</span><span class="token punctuation">,</span>
            log_type<span class="token operator">=</span><span class="token string">"slow-log"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"demo-saleor-core-redis-cluster"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"redis-primary-endpoint"</span><span class="token punctuation">,</span> demo_redis_cluster<span class="token punctuation">.</span>primary_endpoint_address<span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"redis-reader-endpoint"</span><span class="token punctuation">,</span> demo_redis_cluster<span class="token punctuation">.</span>reader_endpoint_address<span class="token punctuation">)</span>

redis_endpoint <span class="token operator">=</span> Output<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token string">"redis://"</span><span class="token punctuation">,</span> demo_redis_cluster<span class="token punctuation">.</span>primary_endpoint_address<span class="token punctuation">,</span> <span class="token string">":6379"</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Populate SSM parameter store with the Redis connection string:
"""</span>
demo_redis_cluster_connection_string <span class="token operator">=</span> ssm<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span><span class="token string">"saleor-redis-connection-string"</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span>redis_connection_string_ssm_parameter_name<span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Redis connection string for Saleor Core in CACHE_URL format"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"SecureString"</span><span class="token punctuation">,</span>
    value<span class="token operator">=</span>redis_endpoint<span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"saleor-redis-cluster-connection-string"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span></code></pre></div>
<p>We will provide a simple PostgreSQL multi-az cluster for our database tier with one primary and one stand-by node. For the sake of the exercise, we will not cover all the intricacies of database provisioning and administration on RDS. We will create a security group that allows access from private subnets over port 5432. Like we did with Redis, we will utilize AWS SSM Parameter Store to store the entire PostgreSQL connection string that our Saleor core application will consume later:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
rds.py
"""</span>

<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> rds<span class="token punctuation">,</span> ec2<span class="token punctuation">,</span> ssm
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> export<span class="token punctuation">,</span> ResourceOptions<span class="token punctuation">,</span> Output

<span class="token keyword">from</span> settings <span class="token keyword">import</span> general_tags<span class="token punctuation">,</span> postgres_instance_size<span class="token punctuation">,</span> demo_db_subnet_cidrs<span class="token punctuation">,</span> demo_private_subnet_cidrs<span class="token punctuation">,</span> sql_user<span class="token punctuation">,</span> sql_password<span class="token punctuation">,</span> db_name<span class="token punctuation">,</span> sql_connection_string_ssm_parameter_name
<span class="token keyword">from</span> subnet_groups <span class="token keyword">import</span> demo_postgresql_subnet_group
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> demo_vpc

<span class="token triple-quoted-string string">"""
Create a PostgreSQL cluster security group:
"""</span>
demo_sql_security_group <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"demo-sql-security-group"</span></span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"PostgreSQL security group"</span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"demo-sql-security-group"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow tcp Redis traffic from application subnets:</span>
demo_sql_security_group_inbound <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string">"demo-sql-security-group-inbound"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">5432</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">5432</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"tcp"</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span>demo_private_subnet_cidrs<span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_sql_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow outbound ANY:</span>
demo_sql_security_group_oubound <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string">"demo-sql-security-group-outbound"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"egress"</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_sql_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
Create a PostgreSQL cluster:
"""</span>
demo_sql_cluster <span class="token operator">=</span> rds<span class="token punctuation">.</span>Instance<span class="token punctuation">(</span><span class="token string">"demo-saleor-core-sql-cluster"</span><span class="token punctuation">,</span>
    db_subnet_group_name<span class="token operator">=</span>demo_postgresql_subnet_group<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    vpc_security_group_ids<span class="token operator">=</span><span class="token punctuation">[</span>demo_sql_security_group<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    storage_encrypted<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allocated_storage<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
    storage_type<span class="token operator">=</span><span class="token string">"gp3"</span><span class="token punctuation">,</span>
    identifier<span class="token operator">=</span><span class="token string">"saleor"</span><span class="token punctuation">,</span>
    multi_az<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    engine<span class="token operator">=</span><span class="token string">"postgres"</span><span class="token punctuation">,</span>
    engine_version<span class="token operator">=</span><span class="token string">"13.7"</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token number">5432</span><span class="token punctuation">,</span>
    performance_insights_enabled<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    network_type<span class="token operator">=</span><span class="token string">"IPV4"</span><span class="token punctuation">,</span>
    instance_class<span class="token operator">=</span>postgres_instance_size<span class="token punctuation">,</span>
    skip_final_snapshot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    iam_database_authentication_enabled<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    auto_minor_version_upgrade<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    apply_immediately<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    username<span class="token operator">=</span>sql_user<span class="token punctuation">,</span>
    password<span class="token operator">=</span>sql_password<span class="token punctuation">,</span>
    db_name<span class="token operator">=</span>db_name<span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"demo-saleor-core-sql-cluster"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>delete_before_replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

export<span class="token punctuation">(</span><span class="token string">"postgres-endpoint"</span><span class="token punctuation">,</span> demo_sql_cluster<span class="token punctuation">.</span>endpoint<span class="token punctuation">)</span>
postgres_endpoint <span class="token operator">=</span> Output<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token string">"postgres://"</span><span class="token punctuation">,</span> sql_user<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> sql_password<span class="token punctuation">,</span> <span class="token string">"@"</span><span class="token punctuation">,</span> demo_sql_cluster<span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> db_name<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Populate SSM parameter store with the SQL connection string:
"""</span>
demo_sql_cluster_connection_string <span class="token operator">=</span> ssm<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span><span class="token string">"saleor-sql-connection-string"</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span>sql_connection_string_ssm_parameter_name<span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"PostgreSQL connection string for Saleor Core in DATABASE_URL format"</span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"SecureString"</span><span class="token punctuation">,</span>
    value<span class="token operator">=</span>postgres_endpoint<span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"saleor-sql-cluster-connection-string"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span></code></pre></div>
<p>Finally, we reached the exciting part - the EKS cluster:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
eks.py
"""</span>

<span class="token keyword">from</span> pulumi_aws <span class="token keyword">import</span> iam<span class="token punctuation">,</span> ec2<span class="token punctuation">,</span> eks<span class="token punctuation">,</span> config<span class="token punctuation">,</span> cloudwatch
<span class="token keyword">import</span> pulumi_eks <span class="token keyword">as</span> eks_provider
<span class="token keyword">from</span> pulumi <span class="token keyword">import</span> export<span class="token punctuation">,</span> ResourceOptions<span class="token punctuation">,</span> Output
<span class="token keyword">import</span> pulumi_kubernetes <span class="token keyword">as</span> k8s
<span class="token keyword">from</span> pulumi_kubernetes<span class="token punctuation">.</span>helm<span class="token punctuation">.</span>v3 <span class="token keyword">import</span> Release<span class="token punctuation">,</span> ReleaseArgs<span class="token punctuation">,</span> RepositoryOptsArgs

<span class="token keyword">import</span> json

<span class="token keyword">from</span> settings <span class="token keyword">import</span> general_tags<span class="token punctuation">,</span> cluster_descriptor<span class="token punctuation">,</span> flux_github_repo_owner<span class="token punctuation">,</span> flux_github_repo_name<span class="token punctuation">,</span> flux_github_token<span class="token punctuation">,</span> flux_cli_version<span class="token punctuation">,</span> cilium_release_version<span class="token punctuation">,</span> saleor_storefront_bucket_name<span class="token punctuation">,</span> saleor_dashboard_bucket_name<span class="token punctuation">,</span> saleor_media_bucket_name<span class="token punctuation">,</span> saleor_static_bucket_name<span class="token punctuation">,</span> sql_connection_string_ssm_parameter_name<span class="token punctuation">,</span> redis_connection_string_ssm_parameter_name<span class="token punctuation">,</span> deployment_region<span class="token punctuation">,</span> account_id
<span class="token keyword">from</span> vpc <span class="token keyword">import</span> demo_vpc<span class="token punctuation">,</span> demo_private_subnets<span class="token punctuation">,</span> demo_eks_cp_subnets
<span class="token keyword">from</span> helpers <span class="token keyword">import</span> create_iam_role<span class="token punctuation">,</span> create_oidc_role<span class="token punctuation">,</span> create_policy

<span class="token triple-quoted-string string">"""
Shared EKS resources: IAM policies for EKS, Karpenter and Cilium
"""</span>

<span class="token comment"># Create an EKS cluster role:</span>
eks_iam_role_policy_arns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"</span><span class="token punctuation">,</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEKSVPCResourceController"</span>
<span class="token punctuation">]</span>

eks_iam_role <span class="token operator">=</span> create_iam_role<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-eks-role"</span></span><span class="token punctuation">,</span> <span class="token string">"Service"</span><span class="token punctuation">,</span> <span class="token string">"eks.amazonaws.com"</span><span class="token punctuation">,</span> eks_iam_role_policy_arns<span class="token punctuation">)</span>

<span class="token comment"># Create a default node role for Karpenter:</span>
karpenter_default_nodegroup_role_policy_arns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"</span><span class="token punctuation">,</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"</span><span class="token punctuation">,</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"</span><span class="token punctuation">,</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"</span>
<span class="token punctuation">]</span>

<span class="token comment"># Cilium CNI service account policies:</span>
cni_service_account_policy_arns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"</span><span class="token punctuation">,</span>
    <span class="token string">"arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"</span>
<span class="token punctuation">]</span>

<span class="token triple-quoted-string string">"""
A set of custom security groups: one for the EKS cluster and one for the Karpenter-managed nodes.
"""</span>
<span class="token comment"># Both security groups created below. These security groups are attached to the EKS control plane interface endpoints as well as the nodes,</span>
<span class="token comment"># provisioned by Karpenter.</span>
<span class="token triple-quoted-string string">"""
Node security group:
"""</span>
<span class="token comment"># Create a custom default demo EKS cluster nodegroup security group:</span>
demo_nodegroup_security_group <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"custom-node-attach-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string"> custom node security group"</span></span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"custom-node-attach-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"karpenter.sh/discovery"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow all node instances to communicate with each other:</span>
demo_nodegroup_security_group_inbound_self <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"inbound-eks-node-self-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    self<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_nodegroup_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow outbound ANY:</span>
demo_nodegroup_security_group_oubound_custom_cidrs <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"outbound-eks-node-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"egress"</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_nodegroup_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Cluster security group:
"""</span>
<span class="token comment"># Create a default demo EKS cluster security group:</span>
demo_cluster_security_group <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroup<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"custom-cluster-attach-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string"> custom security group"</span></span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"custom-cluster-attach-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow all traffic from custom Karpenter node security group:</span>
demo_cluster_security_group_inbound_node <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"inbound-eks-cp-inbound-node-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    source_security_group_id<span class="token operator">=</span>demo_nodegroup_security_group<span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_cluster_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow kubectl from ANY:</span>
demo_cluster_security_group_inbound_443 <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"inbound-eks-cp-443-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">443</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_cluster_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow outbound ANY:</span>
demo_cluster_security_group_oubound_custom_cidrs <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"outbound-eks-cp-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"egress"</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    cidr_blocks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_cluster_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token comment"># Allow all traffic from cluster SG to nodes after the cluster SG is defined:</span>
demo_nodegroup_security_group_inbound_from_cp <span class="token operator">=</span> ec2<span class="token punctuation">.</span>SecurityGroupRule<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"inbound-eks-node-from-cp-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"ingress"</span><span class="token punctuation">,</span>
    from_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    to_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    protocol<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
    source_security_group_id<span class="token operator">=</span>demo_cluster_security_group<span class="token punctuation">,</span>
    security_group_id<span class="token operator">=</span>demo_nodegroup_security_group<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Instance profile for Karpenter-managed nodes:
"""</span>

<span class="token comment"># Create a default Karpenter node role and instance profile:</span>
karpenter_node_role <span class="token operator">=</span> create_iam_role<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"KarpenterNodeRole-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"Service"</span><span class="token punctuation">,</span> <span class="token string">"ec2.amazonaws.com"</span><span class="token punctuation">,</span> karpenter_default_nodegroup_role_policy_arns<span class="token punctuation">)</span>
karpenter_instance_profile <span class="token operator">=</span> iam<span class="token punctuation">.</span>InstanceProfile<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"KarpenterNodeInstanceProfile-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    role<span class="token operator">=</span>karpenter_node_role<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"KarpenterNodeInstanceProfile-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
EKS Control Plane
"""</span>

<span class="token comment"># Create an EKS log group:</span>
demo_eks_loggroup <span class="token operator">=</span> cloudwatch<span class="token punctuation">.</span>LogGroup<span class="token punctuation">(</span><span class="token string">"demo-eks-loggroup"</span><span class="token punctuation">,</span> 
    name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"/aws/eks/</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">/cluster"</span></span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span>general_tags<span class="token punctuation">,</span>
    retention_in_days<span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">)</span>

<span class="token comment"># Create the cluster control plane:</span>
demo_eks_cluster <span class="token operator">=</span> eks_provider<span class="token punctuation">.</span>Cluster<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"eks-</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    vpc_id<span class="token operator">=</span>demo_vpc<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    instance_role<span class="token operator">=</span>karpenter_node_role<span class="token punctuation">,</span>
    cluster_security_group<span class="token operator">=</span>demo_cluster_security_group<span class="token punctuation">,</span>
    create_oidc_provider<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">"1.24"</span><span class="token punctuation">,</span>
    instance_profile_name<span class="token operator">=</span>karpenter_instance_profile<span class="token punctuation">,</span>
    skip_default_node_group<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    service_role<span class="token operator">=</span>eks_iam_role<span class="token punctuation">,</span>
    provider_credential_opts<span class="token operator">=</span>eks_provider<span class="token punctuation">.</span>KubeconfigOptionsArgs<span class="token punctuation">(</span>
        profile_name<span class="token operator">=</span>config<span class="token punctuation">.</span>profile<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    endpoint_private_access<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    endpoint_public_access<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    enabled_cluster_log_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"api"</span><span class="token punctuation">,</span> <span class="token string">"audit"</span><span class="token punctuation">,</span> <span class="token string">"authenticator"</span><span class="token punctuation">,</span> <span class="token string">"controllerManager"</span><span class="token punctuation">,</span> <span class="token string">"scheduler"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    public_access_cidrs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"0.0.0.0/0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    subnet_ids<span class="token operator">=</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> demo_eks_cp_subnets<span class="token punctuation">]</span><span class="token punctuation">,</span>
    default_addons_to_remove<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"coredns"</span><span class="token punctuation">,</span> <span class="token string">"kube-proxy"</span><span class="token punctuation">,</span> <span class="token string">"vpc-cni"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    fargate<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>depends_on<span class="token operator">=</span><span class="token punctuation">[</span>
            demo_nodegroup_security_group<span class="token punctuation">,</span>
            eks_iam_role<span class="token punctuation">,</span>
            demo_eks_loggroup
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

demo_eks_cluster_oidc_arn <span class="token operator">=</span> demo_eks_cluster<span class="token punctuation">.</span>core<span class="token punctuation">.</span>oidc_provider<span class="token punctuation">.</span>arn
demo_eks_cluster_oidc_url <span class="token operator">=</span> demo_eks_cluster<span class="token punctuation">.</span>core<span class="token punctuation">.</span>oidc_provider<span class="token punctuation">.</span>url

<span class="token triple-quoted-string string">"""
Cilium service account, Karpenter service account:
"""</span>

<span class="token comment"># Create an IAM role for Cilium CNI:</span>
iam_role_vpc_cni_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-cilium"</span></span><span class="token punctuation">,</span> <span class="token string">"kube-system"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"cilium-operator"</span><span class="token punctuation">,</span> cni_service_account_policy_arns<span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"cilium-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_vpc_cni_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token comment"># Create a Karpenter IAM role scoped to karpenter namespace:</span>
iam_role_karpenter_controller_policy <span class="token operator">=</span> create_policy<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-karpenter-policy"</span></span><span class="token punctuation">,</span> <span class="token string">"karpenter_oidc_role_policy.json"</span><span class="token punctuation">)</span>
iam_role_karpenter_controller_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-karpenter"</span></span><span class="token punctuation">,</span> <span class="token string">"karpenter"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"karpenter"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>iam_role_karpenter_controller_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"karpenter-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_karpenter_controller_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Kubernetes Pulumi provider to create objects inside the cluster:
"""</span>

<span class="token comment"># Create a kubernetes provider:</span>
role_provider <span class="token operator">=</span> k8s<span class="token punctuation">.</span>Provider<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-kubernetes-provider"</span></span><span class="token punctuation">,</span>
    kubeconfig<span class="token operator">=</span>demo_eks_cluster<span class="token punctuation">.</span>kubeconfig<span class="token punctuation">,</span>
    enable_server_side_apply<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Patch the aws-node DaemonSet to make sure it's unshedulable to any node in the cluster, using server side apply:</span>
patch_aws_node <span class="token operator">=</span> k8s<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>DaemonSetPatch<span class="token punctuation">(</span><span class="token string">"aws-node-patch"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span>k8s<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>ObjectMetaPatchArgs<span class="token punctuation">(</span>
        annotations<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"pulumi.com/patchForce"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">"aws-node"</span><span class="token punctuation">,</span>
        namespace<span class="token operator">=</span><span class="token string">"kube-system"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    spec<span class="token operator">=</span>k8s<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>DaemonSetSpecPatchArgs<span class="token punctuation">(</span>
        template<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>PodTemplateSpecPatchArgs<span class="token punctuation">(</span>
            spec<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>PodSpecPatchArgs<span class="token punctuation">(</span>
                affinity<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>AffinityPatchArgs<span class="token punctuation">(</span>
                    node_affinity<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>NodeAffinityPatchArgs<span class="token punctuation">(</span>
                        required_during_scheduling_ignored_during_execution<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>NodeSelectorPatchArgs<span class="token punctuation">(</span>
                            node_selector_terms<span class="token operator">=</span><span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>NodeSelectorTermPatchArgs<span class="token punctuation">(</span>
                                match_expressions<span class="token operator">=</span><span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>NodeSelectorRequirementPatchArgs<span class="token punctuation">(</span>
                                    key<span class="token operator">=</span><span class="token string">"kubernetes.io/os"</span><span class="token punctuation">,</span>
                                    operator<span class="token operator">=</span><span class="token string">"In"</span><span class="token punctuation">,</span>
                                    values<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"no-schedule"</span><span class="token punctuation">]</span>
                                <span class="token punctuation">)</span><span class="token punctuation">]</span>
                            <span class="token punctuation">)</span><span class="token punctuation">]</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

cluster_endpoint_fqdn <span class="token operator">=</span> demo_eks_cluster<span class="token punctuation">.</span>core<span class="token punctuation">.</span>endpoint

<span class="token triple-quoted-string string">"""
Create a managed node group and install Cilium via helm in parallel. A managed nodegroup will fail to reach a "Ready" state 
without the CNI daemon running and the helm chart will fail to install if no nodes are available. Let the race begin!
"""</span>

<span class="token comment"># Create a cilium Helm release when the control plane is initialized:</span>
cilium_cni_release <span class="token operator">=</span> Release<span class="token punctuation">(</span><span class="token string">"cilium-cni"</span><span class="token punctuation">,</span>
    ReleaseArgs<span class="token punctuation">(</span>
        chart<span class="token operator">=</span><span class="token string">"cilium"</span><span class="token punctuation">,</span>
        version<span class="token operator">=</span>cilium_release_version<span class="token punctuation">,</span>
        namespace<span class="token operator">=</span><span class="token string">"kube-system"</span><span class="token punctuation">,</span>
        repository_opts<span class="token operator">=</span>RepositoryOptsArgs<span class="token punctuation">(</span>
            repo<span class="token operator">=</span><span class="token string">"https://helm.cilium.io"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        values<span class="token operator">=</span>Output<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>iam_role_vpc_cni_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">,</span> cluster_endpoint_fqdn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
            <span class="token keyword">lambda</span> args<span class="token punctuation">:</span>
                <span class="token punctuation">{</span>
                <span class="token string">"ingressController"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"eni"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token string">"iamRole"</span><span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"updateEC2AdapterLimitViaAPI"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token string">"awsReleaseExcessIPs"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token string">"subnetTagsFilter"</span><span class="token punctuation">:</span> <span class="token string">"cilium-pod-interfaces=private"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"ipam"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"mode"</span><span class="token punctuation">:</span> <span class="token string">"eni"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"egressMasqueradeInterfaces"</span><span class="token punctuation">:</span> <span class="token string">"eth0"</span><span class="token punctuation">,</span>
                <span class="token string">"tunnel"</span><span class="token punctuation">:</span> <span class="token string">"disabled"</span><span class="token punctuation">,</span>
                <span class="token string">"loadBalancer"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"algorithm"</span><span class="token punctuation">:</span> <span class="token string">"maglev"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"kubeProxyReplacement"</span><span class="token punctuation">:</span> <span class="token string">"strict"</span><span class="token punctuation">,</span>
                <span class="token string">"k8sServiceHost"</span><span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"https://"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"hubble"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"relay"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"ui"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">,</span> patch_aws_node<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Create an initial Nodegroup when the control plane is initialized:</span>
managed_nodegroup <span class="token operator">=</span> eks_provider<span class="token punctuation">.</span>ManagedNodeGroup<span class="token punctuation">(</span><span class="token string">"cilium-managed-nodegroup"</span><span class="token punctuation">,</span>
    cluster<span class="token operator">=</span>demo_eks_cluster<span class="token punctuation">,</span>
    node_group_name<span class="token operator">=</span><span class="token string">"managed-nodegroup"</span><span class="token punctuation">,</span>
    node_role<span class="token operator">=</span>karpenter_node_role<span class="token punctuation">,</span>
    subnet_ids<span class="token operator">=</span><span class="token punctuation">[</span>s<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> demo_private_subnets<span class="token punctuation">]</span><span class="token punctuation">,</span>
    force_update_version<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    ami_type<span class="token operator">=</span><span class="token string">"BOTTLEROCKET_ARM_64"</span><span class="token punctuation">,</span>
    instance_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"t4g.medium"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    scaling_config<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">"desired_size"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string">"min_size"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string">"max_size"</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    capacity_type<span class="token operator">=</span><span class="token string">"ON_DEMAND"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>general_tags<span class="token punctuation">,</span> <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"cilium-managed-nodegroup"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    taints<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"node.cilium.io/agent-not-ready"</span><span class="token punctuation">,</span>
            <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
            <span class="token string">"effect"</span><span class="token punctuation">:</span> <span class="token string">"NO_EXECUTE"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">,</span> patch_aws_node<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Default EKS core-dns add-on:
"""</span>

<span class="token comment"># Install CoreDNS addon when the cluster is initialized:</span>
core_dns_addon <span class="token operator">=</span> eks<span class="token punctuation">.</span>Addon<span class="token punctuation">(</span><span class="token string">"coredns-addon"</span><span class="token punctuation">,</span>
    cluster_name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    addon_name<span class="token operator">=</span><span class="token string">"coredns"</span><span class="token punctuation">,</span>
    addon_version<span class="token operator">=</span><span class="token string">"v1.8.7-eksbuild.3"</span><span class="token punctuation">,</span>
    resolve_conflicts<span class="token operator">=</span><span class="token string">"OVERWRITE"</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>managed_nodegroup<span class="token punctuation">,</span> cilium_cni_release<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Flux controller set-up:
"""</span>

<span class="token comment"># Create a service account and cluster role binding for flux controller</span>
flux_service_account <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>ServiceAccount<span class="token punctuation">(</span><span class="token string">"flux-controller-service-account"</span><span class="token punctuation">,</span>
    api_version<span class="token operator">=</span><span class="token string">"v1"</span><span class="token punctuation">,</span>
    kind<span class="token operator">=</span><span class="token string">"ServiceAccount"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span>k8s<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>ObjectMetaArgs<span class="token punctuation">(</span>
        name<span class="token operator">=</span><span class="token string">"flux-controller"</span><span class="token punctuation">,</span>
        namespace<span class="token operator">=</span><span class="token string">"kube-system"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

flux_controller_cluster_role_binding <span class="token operator">=</span> k8s<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>ClusterRoleBinding<span class="token punctuation">(</span><span class="token string">"flux-controller-sa-crb"</span><span class="token punctuation">,</span>
    role_ref<span class="token operator">=</span>k8s<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>RoleRefArgs<span class="token punctuation">(</span>
        api_group<span class="token operator">=</span><span class="token string">"rbac.authorization.k8s.io"</span><span class="token punctuation">,</span>
        kind<span class="token operator">=</span><span class="token string">"ClusterRole"</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">"cluster-admin"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    subjects<span class="token operator">=</span><span class="token punctuation">[</span>
        k8s<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>SubjectArgs<span class="token punctuation">(</span>
            kind<span class="token operator">=</span><span class="token string">"ServiceAccount"</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">"flux-controller"</span><span class="token punctuation">,</span>
            namespace<span class="token operator">=</span><span class="token string">"kube-system"</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Create the bootstrap job for flux-cli</span>
flux_bootstrap_job <span class="token operator">=</span> k8s<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Job<span class="token punctuation">(</span><span class="token string">"fluxBootstrapJob"</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>flux_service_account<span class="token punctuation">,</span> flux_controller_cluster_role_binding<span class="token punctuation">,</span> core_dns_addon<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span>k8s<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>ObjectMetaArgs<span class="token punctuation">(</span>
        name<span class="token operator">=</span><span class="token string">"flux-bootstrap-job"</span><span class="token punctuation">,</span>
        namespace<span class="token operator">=</span><span class="token string">"kube-system"</span><span class="token punctuation">,</span>
        annotations<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"pulumi.com/replaceUnready"</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    spec<span class="token operator">=</span>k8s<span class="token punctuation">.</span>batch<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>JobSpecArgs<span class="token punctuation">(</span>
        backoff_limit<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        template<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>PodTemplateSpecArgs<span class="token punctuation">(</span>
            spec<span class="token operator">=</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>PodSpecArgs<span class="token punctuation">(</span>
                service_account_name<span class="token operator">=</span><span class="token string">"flux-controller"</span><span class="token punctuation">,</span>
                containers<span class="token operator">=</span><span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>ContainerArgs<span class="token punctuation">(</span>
                    env<span class="token operator">=</span><span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span>EnvVar<span class="token punctuation">(</span>
                        name<span class="token operator">=</span><span class="token string">"GITHUB_TOKEN"</span><span class="token punctuation">,</span>
                        value<span class="token operator">=</span>flux_github_token
                    <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    command<span class="token operator">=</span><span class="token punctuation">[</span>
                        <span class="token string">"flux"</span><span class="token punctuation">,</span>
                        <span class="token string">"bootstrap"</span><span class="token punctuation">,</span>
                        <span class="token string">"github"</span><span class="token punctuation">,</span>
                        <span class="token string-interpolation"><span class="token string">f"--owner=</span><span class="token interpolation"><span class="token punctuation">{</span>flux_github_repo_owner<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                        <span class="token string-interpolation"><span class="token string">f"--repository=</span><span class="token interpolation"><span class="token punctuation">{</span>flux_github_repo_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                        <span class="token string-interpolation"><span class="token string">f"--path=./clusters/</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                        <span class="token string">"--private=false"</span><span class="token punctuation">,</span>
                        <span class="token string">"--personal=true"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    image<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"fluxcd/flux-cli:v</span><span class="token interpolation"><span class="token punctuation">{</span>flux_cli_version<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                    name<span class="token operator">=</span><span class="token string">"flux-bootstrap"</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                restart_policy<span class="token operator">=</span><span class="token string">"OnFailure"</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Karpenter namespace to deploy Karpenter controller into:
"""</span>

<span class="token comment"># Create a karpenter namespace:</span>
karpenter_namespace <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token string">"karpenter-namespace"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"karpenter"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Set up a service account role for cert-manager, should you need one with this stack
"""</span>
<span class="token comment"># cert-manager Service Account in kube-system</span>
iam_role_cert_manager_policy <span class="token operator">=</span> create_policy<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-cert-manager-policy"</span></span><span class="token punctuation">,</span> <span class="token string">"certmanager_oidc_role_policy.json"</span><span class="token punctuation">)</span>
iam_role_cert_manager_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string">"cert-manager-sa"</span><span class="token punctuation">,</span> <span class="token string">"kube-system"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"cert-manager-sa"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>iam_role_cert_manager_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"cert-manager-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_cert_manager_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Set up a service account role for external-dns, should you need one with this stack
"""</span>
<span class="token comment"># External DNS Service Account in kube-system</span>
iam_role_external_dns_controller_policy <span class="token operator">=</span> create_policy<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cluster_descriptor<span class="token punctuation">}</span></span><span class="token string">-external-dns-policy"</span></span><span class="token punctuation">,</span> <span class="token string">"external_dns_controller_oidc_role_policy.json"</span><span class="token punctuation">)</span>
iam_role_external_dns_controller_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string">"external-dns-controller-sa"</span><span class="token punctuation">,</span> <span class="token string">"kube-system"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"external-dns-controller-sa"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>iam_role_external_dns_controller_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"external-dns-controller-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_external_dns_controller_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
Set up namespace and service account for External Secrets operator
"""</span>
external_secrets_core_namespace <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token string">"external-secrets-namespace"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"external-secrets"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Add service account role for External Secrets SA to fetch RDS secret from Parameter Store:</span>
external_secrets_service_account_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">"external-secrets-sa-policy"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"External Secrets Service Account SSM Parameter Store Policy"</span><span class="token punctuation">,</span>
    policy<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ssm:GetParameter"</span><span class="token punctuation">,</span>
                <span class="token string">"ssm:GetParametersByPath"</span><span class="token punctuation">,</span>
                <span class="token string">"ssm:GetParameters"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:ssm:</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>account_id<span class="token punctuation">}</span></span><span class="token string">:parameter/</span><span class="token interpolation"><span class="token punctuation">{</span>sql_connection_string_ssm_parameter_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:ssm:</span><span class="token interpolation"><span class="token punctuation">{</span>deployment_region<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>account_id<span class="token punctuation">}</span></span><span class="token string">:parameter/</span><span class="token interpolation"><span class="token punctuation">{</span>redis_connection_string_ssm_parameter_name<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># External Secrets IAM role for service account:</span>
iam_role_external_secrets_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string">"external-secrets-sa"</span><span class="token punctuation">,</span> <span class="token string">"external-secrets"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"external-secrets-sa"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>external_secrets_service_account_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"external-secrets-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_external_secrets_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
Set up namespaces and service accounts for Saleor components
"""</span>
<span class="token comment"># Saleor Core namespace</span>
saleor_core_namespace <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token string">"saleor-core-namespace"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"saleor-core"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Saleor Core service account policy:</span>
saleor_core_service_account_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">"saleor-core-sa-policy"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Saleor Core Service Account S3 Bucket Policy"</span><span class="token punctuation">,</span>
    policy<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:*"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_media_bucket_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_media_bucket_name<span class="token punctuation">}</span></span><span class="token string">/*"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_static_bucket_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_static_bucket_name<span class="token punctuation">}</span></span><span class="token string">/*"</span></span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Saleor Core IAM role for service account:</span>
iam_role_saleor_core_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string">"saleor-core-sa"</span><span class="token punctuation">,</span> <span class="token string">"saleor-core"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"saleor-core-sa"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>saleor_core_service_account_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"saleor-core-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_saleor_core_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token comment"># Saleor Dashboard namespace</span>
saleor_dashboard_namespace <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token string">"saleor-dashboard-namespace"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"saleor-dashboard"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Saleor Dashboard service account policy:</span>
saleor_dashboard_service_account_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">"saleor-dashboard-sa-policy"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Saleor Dashboard Service Account S3 Bucket Policy"</span><span class="token punctuation">,</span>
    policy<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:ListBucket"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_dashboard_bucket_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_dashboard_bucket_name<span class="token punctuation">}</span></span><span class="token string">/*"</span></span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

iam_role_saleor_dashboard_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string">"saleor-dashboard-sa"</span><span class="token punctuation">,</span> <span class="token string">"saleor-dashboard"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"saleor-dashboard-sa"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>saleor_dashboard_service_account_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"saleor-dashboard-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_saleor_dashboard_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span>

<span class="token comment"># Saleor Storefront namespace</span>
saleor_storefront_namespace <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token string">"saleor-storefront-namespace"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"saleor-storefront"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Saleor Static Assets namespace</span>
saleor_assets_namespace <span class="token operator">=</span> k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token string">"saleor-assets-namespace"</span><span class="token punctuation">,</span>
    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"saleor-assets"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    opts<span class="token operator">=</span>ResourceOptions<span class="token punctuation">(</span>
        provider<span class="token operator">=</span>role_provider<span class="token punctuation">,</span>
        depends_on<span class="token operator">=</span><span class="token punctuation">[</span>demo_eks_cluster<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Saleor Assets service account policy:</span>
saleor_assets_service_account_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">"saleor-assets-sa-policy"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Saleor Assets Service Account S3 Bucket Policy"</span><span class="token punctuation">,</span>
    policy<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
        <span class="token string">"Statement"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token string">"Action"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:ListBucket"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Effect"</span><span class="token punctuation">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string">"Resource"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_media_bucket_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_media_bucket_name<span class="token punctuation">}</span></span><span class="token string">/*"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_static_bucket_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
                <span class="token string-interpolation"><span class="token string">f"arn:aws:s3:::</span><span class="token interpolation"><span class="token punctuation">{</span>saleor_static_bucket_name<span class="token punctuation">}</span></span><span class="token string">/*"</span></span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Saleor Assets IAM role for service account:</span>
iam_role_saleor_assets_service_account_role <span class="token operator">=</span> create_oidc_role<span class="token punctuation">(</span><span class="token string">"saleor-assets-sa"</span><span class="token punctuation">,</span> <span class="token string">"saleor-assets"</span><span class="token punctuation">,</span> demo_eks_cluster_oidc_arn<span class="token punctuation">,</span> demo_eks_cluster_oidc_url<span class="token punctuation">,</span> <span class="token string">"saleor-assets-sa"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>saleor_assets_service_account_policy<span class="token punctuation">.</span>arn<span class="token punctuation">]</span><span class="token punctuation">)</span>
export<span class="token punctuation">(</span><span class="token string">"saleor-assets-oidc-role-arn"</span><span class="token punctuation">,</span> iam_role_saleor_assets_service_account_role<span class="token punctuation">.</span>arn<span class="token punctuation">)</span></code></pre></div>
<p>Several noteworthy things happened here. First, we create several objects that are needed for our Kubernetes cluster to function, i.e.:</p>
<ol>
<li>A cluster role that allows EKS to call AWS services on its behalf.</li>
<li>A default node instance profile that our worker nodes will use.</li>
</ol>
<p>In addition, we will build two custom security groups: one for the cluster control plane and one for the nodes.</p>
<p>When provisioning the cluster, we will remove the default add-ons EKS installs for us, thus providing a clean cluster. The second important thing we need to do after the EKS control plane is up is to patch the aws-node daemonset. Since we will use Cilium to take control of networking instead of kube-proxy entirely, this daemonset needs to be disabled - easily achieved by modifying the daemonset’s nodeSelector.</p>
<p>Once done with the above, we must start provisioning of a managed node group to host our Cilium controller. The nodes will not come up without a Cilium daemon running on them, so a helm installation of Cilium itself must happen simultaneously. Thankfully, Pulumi will handle this for us. Please note that we limit the choice of subnets for Cilium to work with using the <code class="language-text">subnetTagsFilter</code> parameter. Another essential parameter to notice is <code class="language-text">kubeProxyReplacement</code> set to <code class="language-text">strict</code> to indicate total kube-proxy replacement. After we finish the node group and Cilium installation, we add the default CoreDNS add-on and a Flux bootstrap job.</p>
<p>With our cluster up and running, the last thing we need to do is to set up several namespaces and service account IAM roles for our workloads. The list of namespaces that we are going to create:</p>
<ol>
<li><code class="language-text">karpenter</code> - used to host our Karpenter controller.</li>
<li><code class="language-text">external-secrets</code> - used to host the External Secrets controller, to fetch connection strings from AWS SSM Parameter Store.</li>
<li><code class="language-text">saleor-assets</code> - used to host proxies that fetch Saleor’s static assets from S3.</li>
<li><code class="language-text">saleor-dashboard</code> - used to host a proxy to S3, where the static dashboard files reside.</li>
<li><code class="language-text">saleor-core</code> - used to host the Saleor Core Django web application.</li>
<li><code class="language-text">saleor-storefront</code> - used to host the storefront Next.js application.</li>
</ol>
<p>Every application running in Kubernetes that needs to interact with AWS API will need an OIDC service account. We will tightly lock down service account permissions with IAM policies to enforce “least privilege” access. The list of service account roles to create:</p>
<ol>
<li><code class="language-text">karpenter</code> scoped to the <code class="language-text">karpenter</code> namespace to interact with ec2, iam, ssm and pricing APIs.</li>
<li><code class="language-text">cert-manager-sa</code> scoped to the <code class="language-text">kube-system</code> namespace to interact with route53 API.</li>
<li><code class="language-text">external-dns-controller-sa</code> scoped to the <code class="language-text">kube-system</code> namespace to interact with route53 API.</li>
<li><code class="language-text">external-secrets-sa</code> scoped to the <code class="language-text">exteral-secrets</code> namespace to interact with AWS SSM Parameter Store.</li>
<li><code class="language-text">saleor-core-sa</code> scoped to the <code class="language-text">saleor-core</code> namespace to interact with S3 API.</li>
<li><code class="language-text">saleor-dashboard-sa</code> scoped to the <code class="language-text">saleor-dashboard</code> namespace to interact with S3 API.</li>
<li><code class="language-text">saleor-assets-sa</code> scoped to the <code class="language-text">saleor-assets</code> namespace to interact with S3 API.</li>
</ol>
<p>With all of the above created, we should have all the necessary AWS infrastructure to run our Saleor workloads on EKS powered by Cilium networking.</p>
<h2>In-cluster Configuration</h2>
<p>Let’s jump over to the Flux configuration repository to understand what we install in our Kubernetes cluster. We can divide all applications into two broad categories: supporting infrastructure and actual business workloads.</p>
<h3>Supporting Infrastructure</h3>
<p>Our supporting infrastructure will include several controllers, namely:</p>
<ol>
<li><a href="https://github.com/kubernetes-sigs/external-dns">ExternalDNS Operator</a> to automatically populate our public network load balancer addresses into Route 53 and create public DNS records for our HTTP application endpoints.</li>
<li><a href="https://cert-manager.io/">Cert Manager Operator</a>, to automatically issue Let’s Encrypt certificates for our HTTPS ingresses.</li>
<li><a href="https://external-secrets.io/v0.7.1/">External Secrets Operator</a> to automatically fetch our connection strings from AWS SSM Parameter Store and store them as Kubernetes secrets - to be consumed by the Saleor Core Django application.</li>
<li><a href="https://karpenter.sh/">Karpenter</a> to automatically manage our Kubernetes worker nodes.</li>
</ol>
<p>The first two operators in this list can be considered “standard practice”, tried and tested GA components and are used extensively by everyone running production Kubernetes in the public cloud. On the other hand, External Secrets Operator is less mature and may not be considered production ready. Our particular use case revolves around the necessity to publish the IaC stack to public Github and the functionality of Pulumi secrets. There are many ways to manage connection strings in production (AWS Secrets Manager, Hashicorp Vault) and build procedures with the help of various CI/CD tools. In our demo case, External Secrets does the job.</p>
<blockquote>
<p>You might wonder why we use Let’s Encrypt certificates to secure our ingresses instead of terminating AWS Certificate Manager certificates at the ingress load balancer - this is always a preferred solution in an AWS production environment for many reasons. One of those reasons is the extra compute resources we must pay for to terminate at the ingress controller. Unfortunately, it does not look like Cilium Ingress Controller supports terminating SSL at the NLB out of the box quite yet.</p>
</blockquote>
<p>Looking at karpenter, we will rely on three provisioners: one node group for the frontend, one for the backend and one for the assets proxies.</p>
<p>We will use this provisioner (<code class="language-text">./karpenter/karpenter-provisioner/frontend-proxy-provisioner.yaml</code>) to host our S3 proxy pods and store frontend pods:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> karpenter.sh/v1alpha5
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Provisioner
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>provisioner
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">node-type</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>proxy
  <span class="token key atrule">requirements</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"karpenter.sh/capacity-type"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"on-demand"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/arch"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"amd64"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"node.kubernetes.io/instance-type"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"t3.small"</span><span class="token punctuation">,</span> <span class="token string">"t3.medium"</span><span class="token punctuation">,</span> <span class="token string">"t3.large"</span><span class="token punctuation">]</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Gi
  <span class="token key atrule">providerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>proxy
  <span class="token key atrule">ttlSecondsAfterEmpty</span><span class="token punctuation">:</span> <span class="token number">60</span>
  <span class="token key atrule">ttlSecondsUntilExpired</span><span class="token punctuation">:</span> <span class="token number">3600</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> karpenter.k8s.aws/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AWSNodeTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>proxy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">amiFamily</span><span class="token punctuation">:</span> Bottlerocket
  <span class="token key atrule">subnetSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">karpenter.sh/discovery</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>web<span class="token punctuation">-</span>demo
  <span class="token key atrule">securityGroupSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">aws-ids</span><span class="token punctuation">:</span> <span class="token string">"sg-0e4b5d6ff6f9b73e0, sg-02c8ed0e928f4cc54"</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token key atrule">Name</span><span class="token punctuation">:</span> <span class="token string">"frontend-proxy-node"</span></code></pre></div>
<p>We will use this provisioner (<code class="language-text">./karpenter/karpenter-provisioner/backend-core-provisioner.yaml</code>) to host our Django API pods:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> karpenter.sh/v1alpha5
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Provisioner
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> backend<span class="token punctuation">-</span>core<span class="token punctuation">-</span>provisioner
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">node-type</span><span class="token punctuation">:</span> backend<span class="token punctuation">-</span>core
  <span class="token key atrule">requirements</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"karpenter.sh/capacity-type"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"on-demand"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/arch"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"arm64"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"node.kubernetes.io/instance-type"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"t4g.small"</span><span class="token punctuation">,</span> <span class="token string">"t4g.medium"</span><span class="token punctuation">,</span> <span class="token string">"t4g.large"</span><span class="token punctuation">]</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Gi
  <span class="token key atrule">providerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> backend<span class="token punctuation">-</span>core
  <span class="token key atrule">ttlSecondsAfterEmpty</span><span class="token punctuation">:</span> <span class="token number">60</span>
  <span class="token key atrule">ttlSecondsUntilExpired</span><span class="token punctuation">:</span> <span class="token number">3600</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> karpenter.k8s.aws/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AWSNodeTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> backend<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">amiFamily</span><span class="token punctuation">:</span> Bottlerocket
  <span class="token key atrule">subnetSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">karpenter.sh/discovery</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>web<span class="token punctuation">-</span>demo
  <span class="token key atrule">securityGroupSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">aws-ids</span><span class="token punctuation">:</span> <span class="token string">"sg-0e4b5d6ff6f9b73e0, sg-02c8ed0e928f4cc54"</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token key atrule">Name</span><span class="token punctuation">:</span> <span class="token string">"backend-core-node"</span></code></pre></div>
<p>We will use this provisioner (<code class="language-text">./karpenter/karpenter-provisioner/frontend-store-provisioner.yaml</code>) to host our Next.js Storefront pods:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> karpenter.sh/v1alpha5
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Provisioner
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>store<span class="token punctuation">-</span>provisioner
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">node-type</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>store
  <span class="token key atrule">requirements</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"karpenter.sh/capacity-type"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"on-demand"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"kubernetes.io/arch"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"arm64"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"node.kubernetes.io/instance-type"</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
      <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"t4g.medium"</span><span class="token punctuation">,</span> <span class="token string">"t4g.large"</span><span class="token punctuation">]</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Gi
  <span class="token key atrule">providerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>store
  <span class="token key atrule">ttlSecondsAfterEmpty</span><span class="token punctuation">:</span> <span class="token number">60</span>
  <span class="token key atrule">ttlSecondsUntilExpired</span><span class="token punctuation">:</span> <span class="token number">3600</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> karpenter.k8s.aws/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AWSNodeTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend<span class="token punctuation">-</span>store
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">amiFamily</span><span class="token punctuation">:</span> Bottlerocket
  <span class="token key atrule">subnetSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">karpenter.sh/discovery</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>web<span class="token punctuation">-</span>demo
  <span class="token key atrule">securityGroupSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">aws-ids</span><span class="token punctuation">:</span> <span class="token string">"sg-0e4b5d6ff6f9b73e0, sg-02c8ed0e928f4cc54"</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token key atrule">Name</span><span class="token punctuation">:</span> <span class="token string">"frontend-store-node"</span></code></pre></div>
<p>As mentioned, Saleor consists of three components: core API, static dashboard and storefront. The fourth and fifth “hidden” components are the two proxies towards S3 that serve:</p>
<ol>
<li>Static assets like CSS and js.</li>
<li>Images, videos etc.</li>
</ol>
<p>All of the above should be accessible from WAN, so we will eventually build ingresses to support that. We need to take care of the SSL certificates first, though. So, with cert-manager installed via Flux (<code class="language-text">./cert-manager</code>), let’s configure a ClusterIssuer and some certs(<code class="language-text">./cert-manager-issuer/cluster-issuer-prod.yaml</code>):</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>production
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">acme</span><span class="token punctuation">:</span>
    <span class="token key atrule">email</span><span class="token punctuation">:</span> sergeyv@duck.com
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//acme<span class="token punctuation">-</span>v02.api.letsencrypt.org/directory
    <span class="token key atrule">privateKeySecretRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> acme<span class="token punctuation">-</span>production<span class="token punctuation">-</span>account<span class="token punctuation">-</span>key
    <span class="token key atrule">solvers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">selector</span><span class="token punctuation">:</span>
        <span class="token key atrule">dnsZones</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token string">"cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token string">"dashboard.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token string">"graphql.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token string">"media.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token string">"static.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token string">"store.cilium.vodwood.codes"</span>
      <span class="token key atrule">dns01</span><span class="token punctuation">:</span>
        <span class="token key atrule">route53</span><span class="token punctuation">:</span>
          <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span><span class="token number">1</span>
          <span class="token key atrule">hostedZoneID</span><span class="token punctuation">:</span> Z02368503A60QUCYJBXIX</code></pre></div>
<p>Feel free to replace these with your domain!</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Certificate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>core<span class="token punctuation">-</span>cert
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>core<span class="token punctuation">-</span>cert
  <span class="token key atrule">issuerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>production
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
  <span class="token key atrule">dnsNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'graphql.cilium.vodwood.codes'</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Certificate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>cert
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>cert
  <span class="token key atrule">issuerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>production
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
  <span class="token key atrule">dnsNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'dashboard.cilium.vodwood.codes'</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Certificate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>cert
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>cert
  <span class="token key atrule">issuerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>production
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
  <span class="token key atrule">dnsNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'media.cilium.vodwood.codes'</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Certificate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>cert
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>cert
  <span class="token key atrule">issuerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>production
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
  <span class="token key atrule">dnsNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'static.cilium.vodwood.codes'</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Certificate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>storefront<span class="token punctuation">-</span>cert
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>storefront<span class="token punctuation">-</span>cert
  <span class="token key atrule">issuerRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>production
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
  <span class="token key atrule">dnsNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'store.cilium.vodwood.codes'</span></code></pre></div>
<p>The last piece of the puzzle is creating our Redis and PostgreSQL secrets with the help of the External Secrets Operator, which we install via Flux HelmRelease. Remember to include the service account role we created. We may fetch the service account role ARN from the Pulumi stack’s outputs. Configure the external secrets (<code class="language-text">./external-secrets-configuration.yaml</code>):</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterSecretStore
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>ssm<span class="token punctuation">-</span>parameter<span class="token punctuation">-</span>store
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">provider</span><span class="token punctuation">:</span>
    <span class="token key atrule">aws</span><span class="token punctuation">:</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span> ParameterStore
      <span class="token key atrule">region</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span><span class="token number">1</span>
      <span class="token key atrule">auth</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceAccountRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets<span class="token punctuation">-</span>sa
            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ExternalSecret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">refreshInterval</span><span class="token punctuation">:</span> 1m
  <span class="token key atrule">secretStoreRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>ssm<span class="token punctuation">-</span>parameter<span class="token punctuation">-</span>store
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterSecretStore
  <span class="token key atrule">target</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
    <span class="token key atrule">creationPolicy</span><span class="token punctuation">:</span> Owner
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
    <span class="token key atrule">remoteRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ExternalSecret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">refreshInterval</span><span class="token punctuation">:</span> 1m
  <span class="token key atrule">secretStoreRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>ssm<span class="token punctuation">-</span>parameter<span class="token punctuation">-</span>store
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterSecretStore
  <span class="token key atrule">target</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
    <span class="token key atrule">creationPolicy</span><span class="token punctuation">:</span> Owner
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
    <span class="token key atrule">remoteRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string</code></pre></div>
<p>Now that we have our SSL certificates and connection string secrets, we are ready to deploy the Saleor platform!</p>
<h3>Saleor Webstore Components</h3>
<p>Now that our base in-cluster infrastructure is ready let’s start deploying the actual Saleor workload.</p>
<h4>Core API</h4>
<p>First, let’s go ahead and deploy the Core API component. We can find the documentation <a href="https://docs.saleor.io/docs/3.x/">here</a>. The Core will reside in the <code class="language-text">saleor-core</code> namespace and consume our Redis and PostgreSQL connection strings, populated as secrets (<code class="language-text">./core/saleor-core.yaml</code>):</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core<span class="token punctuation">-</span>sa
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core<span class="token punctuation">-</span>sa
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>type
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> backend<span class="token punctuation">-</span>core
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>init<span class="token punctuation">-</span>migrations
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/saleor/saleor<span class="token punctuation">:</span>3.9.8
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATABASE_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-media-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STORAGE_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-static-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STATIC_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"static.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"media.cilium.vodwood.codes"</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token string">"python"</span>
          <span class="token punctuation">-</span> <span class="token string">"manage.py"</span>
          <span class="token punctuation">-</span> <span class="token string">"makemigrations"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>init<span class="token punctuation">-</span>migrate
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/saleor/saleor<span class="token punctuation">:</span>3.9.8
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATABASE_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-media-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STORAGE_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-static-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STATIC_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"static.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"media.cilium.vodwood.codes"</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token string">"python"</span>
          <span class="token punctuation">-</span> <span class="token string">"manage.py"</span>
          <span class="token punctuation">-</span> <span class="token string">"migrate"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>init<span class="token punctuation">-</span>populate
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/saleor/saleor<span class="token punctuation">:</span>3.9.8
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATABASE_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-media-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STORAGE_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-static-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STATIC_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"static.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"media.cilium.vodwood.codes"</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token string">"python"</span>
          <span class="token punctuation">-</span> <span class="token string">"manage.py"</span>
          <span class="token punctuation">-</span> <span class="token string">"populatedb"</span>
          <span class="token punctuation">-</span> <span class="token string">"--createsuperuser"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>init<span class="token punctuation">-</span>collectstatic
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/saleor/saleor<span class="token punctuation">:</span>3.9.8
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATABASE_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-media-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STORAGE_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-static-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STATIC_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"static.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"media.cilium.vodwood.codes"</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token string">"python"</span>
          <span class="token punctuation">-</span> <span class="token string">"manage.py"</span>
          <span class="token punctuation">-</span> <span class="token string">"collectstatic"</span>
          <span class="token punctuation">-</span> <span class="token string">"--noinput"</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>api
        <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/saleor/saleor<span class="token punctuation">:</span>3.9.8
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"100m"</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"256M"</span>
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">90</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATABASE_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_URL
            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
              <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis
                <span class="token key atrule">key</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>connection<span class="token punctuation">-</span>string
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-media-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STORAGE_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"saleor-static-silium-demo"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ALLOWED_HOSTS
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"graphql.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_STATIC_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"static.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_MEDIA_CUSTOM_DOMAIN
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"media.cilium.vodwood.codes"</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CREATE_IMAGES_ON_DEMAND
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span>  <span class="token number">8000</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span>  saleor<span class="token punctuation">-</span>api
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core<span class="token punctuation">-</span>sa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">eks.amazonaws.com/role-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>289512055556<span class="token punctuation">:</span>role/saleor<span class="token punctuation">-</span>core<span class="token punctuation">-</span>sa
    <span class="token key atrule">eks.amazonaws.com/sts-regional-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> core<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>api
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> core<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">"nlb"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"http"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> graphql.cilium.vodwood.codes
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>core<span class="token punctuation">-</span>cert
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> cilium
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> graphql.cilium.vodwood.codes 
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> core<span class="token punctuation">-</span>svc
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span></code></pre></div>
<p>By specifying the <code class="language-text">nodeSelectorTerms</code>, we aim to deploy the Core API pods to the nodes managed by the <code class="language-text">backend-core-provisioner</code> Karpenter provisioner. Furthermore, Django also consumes the names of the static and media buckets for WRITE operations and the FQDNs of the said buckets to construct valid web URLs of the files residing there. As mentioned, we will route all requests to the S3 content through ingresses in our Kubernetes cluster.</p>
<p>Once the Network load balancer is up, External DNS does its job to map that load balancer address to our custom domain. Looks good:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/a7396/graphql-api.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlUlEQVR42nWSS4/TMBRG+/837FnyI1gBEowYQEhApyr0kUmbpE1sx3Ecx0k6CHRQHi0UhsXR9et+97OvZ6ppWR8F8+2OIBWEQhFrQ3QmL675c08bQqmJjGN9yMmEYla4ln2q2e4zjD+hXYuumokWU5+G9dI/jPtVQz7Rj5VtSXRDVrZo1zFT1g8iRd0hrUedGQ57YqHZp4rdQRBl+SjUF50YhT15j/XM8ilRluOCqcd5bmtkWfPh0x0v37zl1c0tN+8/DgUSWVzIioqzRh9HwdJTutFpkNUUpkSV9XBoFcYs1gHf7iOW25Dldsf864bFKuButSWIj0PeRbC/mraOyp948uI77zYN/Oiwrh5cJ5kiUwXSWIRxV8gpnsVGQetx3vMlanl2+wA/HYuo4+nrDlt7lC5JRYE29pL0GL8d9k0pK5aHio1ocVXF59DxfN5ReY9UOXGSksn8kvg3/7xhVozW+5gWNab2+Gbs9FEown1MKvPpm/j/Mgn6R+1LO8bwILhPMoJEsk40kei7qy/dPihz9Ya/ALWQ7bCeN9vjAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Saleor Graphql is up"
        title="Saleor Graphql is up"
        src="/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/f058b/graphql-api.png"
        srcset="/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/c26ae/graphql-api.png 158w,
/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/6bdcf/graphql-api.png 315w,
/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/f058b/graphql-api.png 630w,
/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/40601/graphql-api.png 945w,
/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/78612/graphql-api.png 1260w,
/devops-pastebin/static/f8359c0e6dbeb8c896466569e441f081/a7396/graphql-api.png 3020w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Onwards!</p>
<h4>Media and Static Assets</h4>
<p>Let’s go ahead and deploy the assets proxies. The assets proxies will reside in the <code class="language-text">saleor-assets</code> namespace - their essential job is to proxy <code class="language-text">GET</code> requests from the Network load balancer to S3 buckets. Again, by utilizing <code class="language-text">nodeSelectorTerms</code>, we aim to deploy the proxy pods to the nodes managed by the <code class="language-text">frontend-proxy-provisioner</code> Karpenter provisioner.</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>sa
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>sa
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gateway
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginxinc/nginx<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gateway<span class="token punctuation">:</span>unprivileged<span class="token punctuation">-</span>oss<span class="token punctuation">-</span><span class="token number">20221216</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
            <span class="token key atrule">port</span><span class="token punctuation">:</span> http
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> http
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ALLOW_DIRECTORY_LIST
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_SIGS_VERSION
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'4'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_REGION
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'eu-central-1'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER
            <span class="token key atrule">value</span><span class="token punctuation">:</span> s3.eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span>1.amazonaws.com
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'saleor-media-silium-demo'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVIDE_INDEX_PAGE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_DEBUG
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER_PROTO
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'https'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER_PORT
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'443'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_STYLE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'virtual'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JS_TRUSTED_CERT_PATH
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'/etc/ssl/certs/Amazon_Root_CA_1.pem'</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>type
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> frontend<span class="token punctuation">-</span>proxy
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> static<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>sa
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>sa
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gateway
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginxinc/nginx<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gateway<span class="token punctuation">:</span>unprivileged<span class="token punctuation">-</span>oss<span class="token punctuation">-</span><span class="token number">20221216</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
            <span class="token key atrule">port</span><span class="token punctuation">:</span> http
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> http
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ALLOW_DIRECTORY_LIST
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_SIGS_VERSION
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'4'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_REGION
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'eu-central-1'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER
            <span class="token key atrule">value</span><span class="token punctuation">:</span> s3.eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span>1.amazonaws.com
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'saleor-static-silium-demo'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVIDE_INDEX_PAGE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_DEBUG
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER_PROTO
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'https'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER_PORT
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'443'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_STYLE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'virtual'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JS_TRUSTED_CERT_PATH
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'/etc/ssl/certs/Amazon_Root_CA_1.pem'</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>type
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> frontend<span class="token punctuation">-</span>proxy
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>sa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">eks.amazonaws.com/role-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>289512055556<span class="token punctuation">:</span>role/saleor<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>sa
    <span class="token key atrule">eks.amazonaws.com/sts-regional-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> static<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> static<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">"nlb"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"http"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> static.cilium.vodwood.codes
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>cert
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> cilium
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> static.cilium.vodwood.codes 
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> static<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>svc
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">"nlb"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"http"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> media.cilium.vodwood.codes
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>cert
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> cilium
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> media.cilium.vodwood.codes 
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>assets<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>svc
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span></code></pre></div>
<p>By specifying the <code class="language-text">nodeSelectorTerms</code>, we aim to deploy the S3 proxy pods to the nodes managed by the <code class="language-text">frontend-proxy-provisioner</code> Karpenter provisioner.</p>
<p>When everything is running, let’s verify that we can reach the files in S3 over HTTPS via a public URL. During the bootstrap of the Core API, we got some demo data populated to the bucket, a fruity drink of some sort in this instance:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/8c5dc/media-bucket-object.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 37.34177215189873%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABKElEQVR42oWRSVIDMQxF+/6n4DJcgR1UIAlJt0cNHtJN8Sm5IZUdi1eSXfK39DWdrg4f5wtczAiZsCSCS4SQMkKMYJF/iSnjOi+IKWE6H99xeHvF4hyY+Q4ZIsjEyMx7JHqIO8SElPfP7Tyl4BGDRyKGqkJLeUBRfvPySDUqSr9Ba7vfiwimy+JxOH6i2kMTVBNRSKmg0pFlvxdRMMt4RCxgypDlBMkBogW1ddTWMC0xY44MlxiBFZ4USSo8l5FLKaPQuowxIWcaftPlAH1+Qj29oG/f+ySqmBIrDucZx9kjaYe0DUkbolRELnDOo5SKbV2xriu2bRu03nHbvtBaH57fbPxSMJkfZqp1YwK99zG+FVnuvB8LM9NtiyZkHZuHf8vwIY5aE/wBulMXezIIyT8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Assets from S3, actual object"
        title="Assets from S3, actual object"
        src="/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/f058b/media-bucket-object.png"
        srcset="/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/c26ae/media-bucket-object.png 158w,
/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/6bdcf/media-bucket-object.png 315w,
/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/f058b/media-bucket-object.png 630w,
/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/40601/media-bucket-object.png 945w,
/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/78612/media-bucket-object.png 1260w,
/devops-pastebin/static/6aa3f3a14ecdc7c4080f26649cbe68cd/8c5dc/media-bucket-object.png 2384w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Let’s try to reach that via the Ingress:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/a7396/media-bucket-content.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABeUlEQVR42q2QTUtbQRSGr5qgmxsS7z+xYFeBkN/RRauLKE3TjbpRrGJFF92511Ioajbd1ILYTYuL0k0g1s+YJrl35sxEK/6ER2aUgJsu1MV73jmHeR/OTFCZmaH0tsLY5AQvxseZX35PI44563RoKkVLhKZWXu78V+ueL66u8rJUojw1xauJ11TKZYIgCFxhoL/f+/PRUbrWYkUQrTFa+GcvubQXvvczEbRSPBsZ8Zm+O0afY+RyOZyGo4jBoSGKxSJiDFprL6U1ewff+VH/iRGD0goRIVGKQqHgM1EUkc1mvQeZTAYnN0in0/6SuQM6QCdpMV19w2L1HV3T7QGVUuTzeVKplM+GYeg9CDMhTrfA1D2gFcNJu8nclw8sbS30tn4gULCScNi+Yu2rZf/XPmKeAHjUvmZl+5RvO7tYaz3oEU9W/GldMPvpN5+rm2h51Ia3f3jeOWd9b4OPO+solXjYg4AuFMcxJ8fH1Go16vU6jUaDJEn+C7wBWJ/sMFaOqfQAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Assets from S3, over the web"
        title="Assets from S3, over the web"
        src="/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/f058b/media-bucket-content.png"
        srcset="/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/c26ae/media-bucket-content.png 158w,
/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/6bdcf/media-bucket-content.png 315w,
/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/f058b/media-bucket-content.png 630w,
/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/40601/media-bucket-content.png 945w,
/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/78612/media-bucket-content.png 1260w,
/devops-pastebin/static/5ee9b8daad024920ec7be1c8700fa7c2/a7396/media-bucket-content.png 3020w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>It’s alive!</p>
<h4>Saleor Dashboard</h4>
<p>Saleor comes with a <a href="https://github.com/saleor/saleor-dashboard">pre-built administrative dashboard</a> to manage the store backend. It can be locally compiled to static and uploaded to S3 <code class="language-text">saleor-dashboard-cilium-demo</code> bucket by drag and drop. All we need, again, is an ingress and an S3 proxy to handle the application delivery:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>sa
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>sa
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gateway
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginxinc/nginx<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gateway<span class="token punctuation">:</span>unprivileged<span class="token punctuation">-</span>oss<span class="token punctuation">-</span><span class="token number">20221216</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
            <span class="token key atrule">port</span><span class="token punctuation">:</span> http
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> http
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ALLOW_DIRECTORY_LIST
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AWS_SIGS_VERSION
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'4'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_REGION
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'eu-central-1'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER
            <span class="token key atrule">value</span><span class="token punctuation">:</span> s3.eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span>1.amazonaws.com
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_BUCKET_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'saleor-dashboard-cilium-demo'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVIDE_INDEX_PAGE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_DEBUG
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER_PROTO
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'https'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_SERVER_PORT
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'443'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> S3_STYLE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'virtual'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JS_TRUSTED_CERT_PATH
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'/etc/ssl/certs/Amazon_Root_CA_1.pem'</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>type
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> frontend<span class="token punctuation">-</span>proxy
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>sa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">eks.amazonaws.com/role-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>289512055556<span class="token punctuation">:</span>role/saleor<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>sa
    <span class="token key atrule">eks.amazonaws.com/sts-regional-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">"nlb"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"http"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> dashboard.cilium.vodwood.codes
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>cert
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> cilium
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> dashboard.cilium.vodwood.codes 
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>svc
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span></code></pre></div>
<p>It looks like everything works as expected:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/fc651/dashboard-web.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48.734177215189874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJElEQVR42oVRa4+DMAzr//+L92m723iMDQYrfaX15CDY7nQalay0CTh2YnrvcLp2ONQVjk2NQ13j59Liu21w6jo0w7CLY9vg69zgUlUwD/tAKRkiCfM8a8xZFJKTvj+Bp6rOuN06REkw9/GOECN88GjaFtNjQkoJMUXElPS+vF9Y67Ob4ZxDQUEuWfOqMMQAyQJr7fJBKbsQEQzjhBjjr7yhInZKktD3PYZhUOsbnNvulrAW3ntVE0JUyy/CvBC64JSQP1Ehu39G1hiCR85ZyRiZ2yxzJklEI4vv+GuXh3k2p+X3ZmacRtjZKpHzS0fRDf8P1ukkhKAEJCQ4AtYM52edVcsr9s66FIpRhXkhZiNDAqrjQPtpRHXtNkt7WyYBF0Sslp9Otw5xZbgCmwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Saleor Dashboard in S3"
        title="Saleor Dashboard in S3"
        src="/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/f058b/dashboard-web.png"
        srcset="/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/c26ae/dashboard-web.png 158w,
/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/6bdcf/dashboard-web.png 315w,
/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/f058b/dashboard-web.png 630w,
/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/40601/dashboard-web.png 945w,
/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/78612/dashboard-web.png 1260w,
/devops-pastebin/static/d1dc16c9401eb25b71de6b8f8d4a8d61/fc651/dashboard-web.png 3016w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h4>Saleor Storefront</h4>
<p>We can use the <a href="https://github.com/saleor/react-storefront">React Storefront</a> project bundled with the Saleor ecosystem for the storefront.</p>
<p>Currently, there is no focus on publishing any production-ready images from this project, so we will build a basic image ourselves without any optimization or alteration - to get it working for our demo. The only thing we will add to the storefront configuration is the permissions for Next.js to fetch content from our static proxy domains. Then run:</p>
<p><code class="language-text">docker build -t sergeyv-storefront:latest  -f Dockerfile.base --build-arg SALEOR_API_URL=https://graphql.cilium.vodwood.codes/graphql/ --build-arg STOREFRONT_URL=https://store.cilium.vodwood.codes .</code></p>
<p>When it’s done building, let’s manually (outside of Pulumi) create an ECR repo and push our newly built image there:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/b77b1/saleor-storefront-image.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.075949367088604%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABAElEQVR42n1R2W7DMAzz///h+rQMaVLk8H0mazlQTYptGGZAPiiJomQ1Tgs+hhs6Wn/FbZpgrIPz/l/zIUAbg2XVWLSWu7EW6joMeLtc0Pc93rsOq9ZIOSPEiPiXpYQQwkFoMS+rkDrnYZ2DYrVpnlFqxf1+x77vaK1h47lt2A7jXfBtQykFIcSXn3itVQoqblRjjEUuRdTlnLGuWnB/qKEyEp2kPL33L3LmME6RhOqkYmuw1iGlBK0NUsqC810lJqCUinqQxphEBHNOlYpknw/IYsv1aH0Yx2fbrUlBJpPIOSfz4mh+L/pVOAb9w2KSz6GPI5CPiE+lfJ/Y9/gz5gvY4hveSoJnHgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Saleor Storefront ECR Image"
        title="Saleor Storefront ECR Image"
        src="/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/f058b/saleor-storefront-image.png"
        srcset="/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/c26ae/saleor-storefront-image.png 158w,
/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/6bdcf/saleor-storefront-image.png 315w,
/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/f058b/saleor-storefront-image.png 630w,
/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/40601/saleor-storefront-image.png 945w,
/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/78612/saleor-storefront-image.png 1260w,
/devops-pastebin/static/f3facaba4065a8414129c8b14ccc4ebe/b77b1/saleor-storefront-image.png 2408w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Grab the image URL, and we can proceed with the frontend deployment:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sergeyv<span class="token punctuation">-</span>storefront
        <span class="token key atrule">image</span><span class="token punctuation">:</span> 289512055556.dkr.ecr.eu<span class="token punctuation">-</span>central<span class="token punctuation">-</span>1.amazonaws.com/sergeyv<span class="token punctuation">-</span>storefront<span class="token punctuation">:</span><span class="token number">1.0</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"500m"</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"1024M"</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> sh
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
          <span class="token punctuation">-</span> <span class="token string">'(nginx &amp;) &amp;&amp; pnpm turbo run start --filter=storefront...'</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> http
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">90</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> http
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>type
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> frontend<span class="token punctuation">-</span>store
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> storefront<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> storefront<span class="token punctuation">-</span>s3<span class="token punctuation">-</span>gw<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> <span class="token string">"nlb"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"http"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> store.cilium.vodwood.codes
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>storefront<span class="token punctuation">-</span>cert
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> cilium
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> store.cilium.vodwood.codes
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> storefront<span class="token punctuation">-</span>svc
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">3000</span></code></pre></div>
<p>Our web store is up:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/0e288/saleor-storefront.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxUlEQVR42p1S207bQBDN1xXiklAiQbir/cN+AVVBFS2qqNoACcGkoN4kO/Ya79W7a59q145RQH3pSKPZmTl7tDN7OtvbQ2wN97Cze4DdvUMMBpvo9V+hvz5Af30DwcseXqwEWFkN0A166AZrra9219Drb2D/4DW2Nod4s3+IDgCUZQVtDKwtYcsST80Y6/1fVlVo+x3TEHHOEEUR/teuJiGkVPUL43mKbxdj75PpLaY3M1w7n97Wsc1ny33n1yFuwu94d3wKrU1NyDlHFCXIM4Y4TpCmGZKUgGQcKcmRpsTn2QMFZQJJQhpMBkKVjw85rUeu3ALcniqNuyRcGkOLe1SlaHOazfHzbhljfo3cLzS7rB4J/5Acb09PUH9SDTgbjUBI3F4eTX/g6Phjg7HQFjh7fwTF6XPCJJf48HXiyljUPl/eg5CsJZz9JvhyuXhhBVsBn87HUFI8ErpDUWgIwUE58Q1rLYSQKCSFMdrXlMNwBkbzVkpKShSMePwSobtsTNnqSRUFOBdeTsY6DRqfu57TrItSKQgpYZt8Qdpx+2KMYx5HXotO4FprT1Jo7c+L3EU3jZOHUgUYYxBCIE0TjCchKGX4C7xbKycoyB8TAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Saleor Storefront"
        title="Saleor Storefront"
        src="/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/f058b/saleor-storefront.png"
        srcset="/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/c26ae/saleor-storefront.png 158w,
/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/6bdcf/saleor-storefront.png 315w,
/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/f058b/saleor-storefront.png 630w,
/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/40601/saleor-storefront.png 945w,
/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/78612/saleor-storefront.png 1260w,
/devops-pastebin/static/586354f0d869bc336b727cf0ca502e61/0e288/saleor-storefront.png 3018w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2>Securing Workloads With Cilium Network Policies</h2>
<p>Finally, let’s jump into Cilium’s network policies and see how each component can be additionally secured.</p>
<h3>General Introduction</h3>
<p>For this demo, we are going to utilise CiliumNetworkPolicy objects. These act like an extension of the standard Kubernetes NetworkPolicy but, compared to the former, can enforce on Layer 3 through Layer 7 for both ingress and egress traffic. We installed the relevant CRDs to support CiliumNetworkPolicy during our cluster bootstrap.</p>
<h3>Saleor Core Network Policy</h3>
<p>Our Saleor Core pods must allow ingress traffic from WAN via an ingress. Additionally, the application’s pods need to be able to:</p>
<ul>
<li>Authenticate via AWS STS API.</li>
<li>Create, read, update and delete content in two S3 buckets.</li>
<li>Communicate with the RDS PostgreSQL endpoint.</li>
<li>Communicate with the Elasticache Redis endpoint.</li>
<li>Resolve DNS.</li>
</ul>
<p>Let’s combine all these requirements in a single policy, scoped to the correct pod selector and namespace:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cilium.io/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CiliumNetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpointSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>core
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">fromEntities</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cluster
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"8000"</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toEndpoints</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">io.kubernetes.pod.namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
            <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>dns
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"53"</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
          <span class="token key atrule">rules</span><span class="token punctuation">:</span>
            <span class="token key atrule">dns</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"demo-saleor-core-redis-cluster-8544b0a.adxo96.ng.0001.euc1.cache.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"6379"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"saleor.celfnipmusup.eu-central-1.rds.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"5432"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"*.s3.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchName</span><span class="token punctuation">:</span> <span class="token string">"sts.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span></code></pre></div>
<p>Notice how we combine Layer 4 and Layer 7 directives to achieve what we need - this is awesome.
Let’s head to Hubble UI and see these traffic patterns emerge:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/0e288/saleor-core-policy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABo0lEQVR42nVRa0/cMBDMn4MjB1RUh7ieKO2fLyS9JH6uX4nDVHYeFyr4MBp7PTPy7haHwwFPxxN+nH7i8HjEw/cDbspbXO/2M0rsbvYo93coy7vM6X51XeJqd4v7bw94fvmNp8cjfp2eUXBlIbWFcT1cGGBcALnwga3v4fuIkDCM+a6Mh/IRIY7Zl0CuR8GUBdcOibfg2uJPS2g6AakInbQ4c0LDNbqNJ9UXTyvNFCjIX6BdFic+C4tOEIQ2aKVD3WkQESTNmtmznFNWwZS7FPVFmExvnQGXGmSmH6R3ZcImZNJ/Gbg+zO0ocmDSoG4FuCS0XGHpaNF/Emg/tCrJoxbTPFzo0TCF14qByEBpAlNm1acfCvovkOt5DhtsZ9Mph6pREClI29XMP/Gkbou64VMrUqMTOjOTNEPnpZxZCiTwtO1Vo8GEXnUsj0SjeK1qWOswxIhhGOC9R1XXEFKi73uEEDAMPaRS4EKstYWZbmGMAWMsL684Ny1ijDCk4b3LoW9VBSkl4jjmt3EcYZ2DUgrj+3uuxThiiAM68xfW2RzofMA/+EEoI8PGmSkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Core Network Policy"
        title="Core Network Policy"
        src="/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/f058b/saleor-core-policy.png"
        srcset="/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/c26ae/saleor-core-policy.png 158w,
/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/6bdcf/saleor-core-policy.png 315w,
/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/f058b/saleor-core-policy.png 630w,
/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/40601/saleor-core-policy.png 945w,
/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/78612/saleor-core-policy.png 1260w,
/devops-pastebin/static/b817edb4f2dbe6b45631e60bcf9d6d8b/0e288/saleor-core-policy.png 3018w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3>Saleor Dashboard Network Policy</h3>
<p>Let’s handle the web store’s administrative dashboard now. The pod is an S3 proxy that needs to authenticate to S3 via AWS STS API to fetch some content. It also needs to be able to resolve DNS. So, again, we scope the policy to the correct pod and namespace:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cilium.io/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CiliumNetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpointSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">fromEntities</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cluster
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"8080"</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toEndpoints</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">io.kubernetes.pod.namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
            <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>dns
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"53"</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
          <span class="token key atrule">rules</span><span class="token punctuation">:</span>
            <span class="token key atrule">dns</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"s3.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchName</span><span class="token punctuation">:</span> <span class="token string">"sts.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span></code></pre></div>
<p>Hubble UI to visualize:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/0e288/saleor-dashboard-policy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpUlEQVR42m2SaY/aMBRF+XMzLGXaIqC0opr/TkVCIkKceI1DMqeyCdtoPlz56fn4+noZLZdLVusNm99bVqsNi8WaxWLFfP6D6XTO63jGZDJjNntjGjVnPJnx8jrlZfyNt+8/2f5959d6w/ufLaNKOcpKoUyD82e082jbPMgjrcc4j3UNvu2wTYs0Darp8F2P9S3Od2jXMiqlReiGMN7lbhLKkp40hVBIpW6MCEGk5VTf1xW1CYaOkDIAlW6o9KUWD73TsKBSNs6HXpyPfHPjAnMxvAJPxgOoHJmwnCqFlGrY8OuNvzS81iFVPSROMkF+rKiVicafA3wytJdET0d0JKXGOo80jjQXZPmJWkpErQfurifDS/wmHiPcyfVeIjCAeWk4hkfRl4e4co+6GWZHEY8Rdg7fp6yD9IMUx1JRCEklHxk11BdGSE1RKUb/9glZliGlpG3PeO9JD1nsGWNo2zZKaU1V17EOzHUsVYG1lizLEVXNKEkP7Pd78uxA4xxd15GkKbvdDqU0/ccHXdfj2xZtDH3fRyb0zt2ZwuS4xpEkCaKW/Aft1ibLHUq/KwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Dashboard Network Policy"
        title="Dashboard Network Policy"
        src="/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/f058b/saleor-dashboard-policy.png"
        srcset="/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/c26ae/saleor-dashboard-policy.png 158w,
/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/6bdcf/saleor-dashboard-policy.png 315w,
/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/f058b/saleor-dashboard-policy.png 630w,
/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/40601/saleor-dashboard-policy.png 945w,
/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/78612/saleor-dashboard-policy.png 1260w,
/devops-pastebin/static/4bd83c0d8745ead94e9dc57a15c61cb8/0e288/saleor-dashboard-policy.png 3018w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3>Saleor Assets Network Policy</h3>
<p>Since our assets proxies are the same as the dashboard proxy, we repeat the process:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cilium.io/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CiliumNetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpointSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>media<span class="token punctuation">-</span>assets
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">fromEntities</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cluster
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"8080"</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toEndpoints</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">io.kubernetes.pod.namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
            <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>dns
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"53"</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
          <span class="token key atrule">rules</span><span class="token punctuation">:</span>
            <span class="token key atrule">dns</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"s3.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchName</span><span class="token punctuation">:</span> <span class="token string">"sts.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cilium.io/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CiliumNetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>assets
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpointSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>static<span class="token punctuation">-</span>assets
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">fromEntities</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cluster
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"8080"</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toEndpoints</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">io.kubernetes.pod.namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
            <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>dns
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"53"</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
          <span class="token key atrule">rules</span><span class="token punctuation">:</span>
            <span class="token key atrule">dns</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"s3.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchName</span><span class="token punctuation">:</span> <span class="token string">"sts.eu-central-1.amazonaws.com"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span></code></pre></div>
<p>Hubble UI to visualize:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/0e288/saleor-assets-policy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkElEQVR42oVS2W4bMQzcn3PcnG6xjZsgPb7dgO3uqYu69sIU1K7TTQqkDwNK5HBIiczyPMfj/glPz9+Rf91j92WPh12Om7sdPl3fYbO9wdX2Np1n3Kf75uoam+0t7h8+4+XHL+wfv+Hn8wsySR7KOLjQwccBguIKXYKyPXQYYfwIChO062FchIkjunFC6AeEboQNPTJhPCQFsP0IRUsQiiCMwzqn1X85jXazoLIBysYZFF7vnCRpPlfKQ2oLnfxLbMm5cFgrE+Zt8hpqlVDUClIRJHe3FH7P/VCQfQ0/hQKMDTiXEq1Qqcv/CPp3T10RLs8ij7JWEFJDrAT/4bMg/4e6/Itd4eJfULYWmngYfvnDt/xZMCAraoFGGghNaHmKmuYutE1WLL5azn5eMcmTfo3ZFGd+IwnZuSgRQsAwjBiGATFGnM6/UVUVvHfo+z7BEKFpW2itQWTgvUfX8Z42cN6hqmqQ5bWRCtM0wVlCjLPw8XjE6XSCcy7FGFyorCocDgdoY1JxRuNK+BBQFmw7/AFlUibeLm92kQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Assets Network Policy"
        title="Assets Network Policy"
        src="/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/f058b/saleor-assets-policy.png"
        srcset="/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/c26ae/saleor-assets-policy.png 158w,
/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/6bdcf/saleor-assets-policy.png 315w,
/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/f058b/saleor-assets-policy.png 630w,
/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/40601/saleor-assets-policy.png 945w,
/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/78612/saleor-assets-policy.png 1260w,
/devops-pastebin/static/6cbb421c1c5d98b3d65f67cdd00b7d20/0e288/saleor-assets-policy.png 3018w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h3>Saleor Storefront Network Policy</h3>
<p>Let’s provide our Storefront container with the ability to call the Core API and media endpoints:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cilium.io/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CiliumNetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpointSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> saleor<span class="token punctuation">-</span>storefront
  <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">fromEntities</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cluster
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"3000"</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toEndpoints</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">io.kubernetes.pod.namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
            <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>dns
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"53"</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
          <span class="token key atrule">rules</span><span class="token punctuation">:</span>
            <span class="token key atrule">dns</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchPattern</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchName</span><span class="token punctuation">:</span> <span class="token string">"media.cilium.vodwood.codes"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">toFQDNs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchName</span><span class="token punctuation">:</span> <span class="token string">"graphql.cilium.vodwood.codes"</span>
      <span class="token key atrule">toPorts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"443"</span></code></pre></div>
<p>Hubble UI to visualize:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/0e288/saleor-storefront-policy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpklEQVR42l1Qi3KbMBDk5xLXzqspoWkn0/bfg3nERkjoLcDejs6ASZjZ2bvT3mpRkqYpnp5fkGW/8CPNkKYZXrJXPDw+4+7+CbebLTbfdtjt7rGdEPub2y1uNnd4ePyOtz//8DN7xd/fb0iEchBSQ9sAFwZiZRy09VDWU299D+0HGBcQ+pF6aTykHxHGE+25MEK7HkkrLbhyiLyA+hmXWdUotEKCS4P1Duuue40w0dBBaAdKqv2qdrTEp/mHsGg7hS7Otb+ckd4vmmg6GfpleQ2xWqgbSQmFNMvZV+1kaK/J9DVZnNXc0Ft12iIvGXg07NTqss96MuRqTrHC1DM5/5bDB1OXdFPCWTNz9GDRsD62YPGxO01vdIVeZpEPLGoUuNRoxWfdzA2XSN7zAnVdQ0qJvu/hvce+KFBVFdVxFqG0hhAd1SGEhZk6whgDxhi0sUiKskJZlpBSIX6n04kM3/McwzBg/sZxhLWO6vMZE5/RuiN88BBCwIceSVnVqKoazfEA5yz6YUBRFMj3e0oYjSK8D1BKUR0vGoaRtMwcYK0FbzmsC/gPWPsoAXLtM6QAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Storefront Network Policy"
        title="Storefront Network Policy"
        src="/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/f058b/saleor-storefront-policy.png"
        srcset="/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/c26ae/saleor-storefront-policy.png 158w,
/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/6bdcf/saleor-storefront-policy.png 315w,
/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/f058b/saleor-storefront-policy.png 630w,
/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/40601/saleor-storefront-policy.png 945w,
/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/78612/saleor-storefront-policy.png 1260w,
/devops-pastebin/static/fbd27932349eec291d8b493699fc31df/0e288/saleor-storefront-policy.png 3018w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2>Closing Thoughts</h2>
<p>In the following posts, we will explore this demo installation further, extending the stack with observability tools like Prometheus and Grafana.</p>
<p>Regarding the Cilium ingress controller, two specific things might bother someone looking to build this out for production:</p>
<ol>
<li>Inability to correctly identify the proper host and utilize a valid SSL certificate - if two or more hosts and certificates are referenced in a single ingress resource.</li>
<li>Inability to terminate SSL at the AWS Network load balancer.</li>
</ol>
<p>These observations may not be Cilium’s fault but my own, although some thorough testing does confirm the above quirks. Anyway, it is worth exploring the Gateway API integration once this becomes more stable in the subsequent releases of Cilium to battle the above shortcomings.</p>
<p>There is a <a href="https://editor.cilium.io/">fantastic tool</a> to construct Cilium Network Policies visually, and it does help a lot if you are just getting started. However, I look forward to a solution that helps generate policies based on the observed traffic patterns. While it is entirely possible to lock this up manually, this would require significant time for a cloud security administrator:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/0e288/kube-system-hubble.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABw0lEQVR42nWS607cMBCF8/4vwwu0EuVHoRJt6apLqy0qsLCbiy8zY8dOEKWn8jiLAKmWjkaOJ8ffnKTpPGPbWfzeM246wdWOsO0ZlkcMFGEownECj/OznCS0LsByAo0TOiLcDw6mN2gcj+CQEMaMME5aJWZQSCpfJCM4Jr1kzJMaUhj1nLU3Q8YJLmQ0Pk56K8UXUpIHlY+zksQ0Y6CEmGcYzghphqSHpbfKq2GYcDCttRIYCkpmdeRYa3nGUVX2lsrY5bzSuoOhlaw3W846Qmk0jmEsYTAMT4J95yAhou09iAPawcN60tob0ggWw6xUVOgO44cMLzW7Qts7gfWCzopSFiIn49JTc6aYl5EXk/+JlgxL6CU7rZTBCvK6Vw2d3pBfqdBqtiHDSUbvo3758lHKH2GoklWq6fmd4tXc71o4TwgxIoQACSU/D8+imZU9i8D5mhlLqApVnlnPvSf1aXofQBzxhLr+AmhbA+GIl+vxCUhpxtsVHwWPAHadgUx/0Hx9f4Rf61PsLk8wrD9iuF3h2/dj/Nico9+t4LbnsPsz3Fye4O52je31Chef3+Fqc4q77RoX6zPsf37C9ZcP2Bwf4R/uw0Oh9FC3yQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Storefront Network Policy"
        title="Storefront Network Policy"
        src="/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/f058b/kube-system-hubble.png"
        srcset="/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/c26ae/kube-system-hubble.png 158w,
/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/6bdcf/kube-system-hubble.png 315w,
/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/f058b/kube-system-hubble.png 630w,
/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/40601/kube-system-hubble.png 945w,
/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/78612/kube-system-hubble.png 1260w,
/devops-pastebin/static/ab346c16d295a06fd5a435d874f3dc8d/0e288/kube-system-hubble.png 3018w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Stay tuned!</p>
<h2>Cleaning Up</h2>
<p>Before running <code class="language-text">pulumi destroy</code>, it is best to run <code class="language-text">flux uninstall</code> first to remove all finalizers that might otherwise interfere with the stack’s resources and delete the EC2 instances that Karpenter spun up for us. Then, after Flux is uninstalled and the instances are terminated, run <code class="language-text">pulumi destroy</code> to clean up.</p></section><hr/><footer><div class="bio"><div data-gatsby-image-wrapper="" style="width:50px;height:50px" class="gatsby-image-wrapper bio-avatar"><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#383838;width:50px;height:50px;position:relative"></div><picture><source type="image/avif" data-srcset="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/d4bf4/profile-pic.avif 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" data-srcset="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/3faea/profile-pic.webp 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png" data-srcset="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e9b55/profile-pic.png 100w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/d4bf4/profile-pic.avif 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/ee81f/profile-pic.avif 100w" sizes="50px"/><source type="image/webp" srcSet="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/3faea/profile-pic.webp 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/6a679/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" src="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png" srcSet="/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e5610/profile-pic.png 50w,/devops-pastebin/static/0a99c64aac5a07989220024ceb35f5c9/e9b55/profile-pic.png 100w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p>Written by <strong>Sergey Vodwood,</strong> <!-- -->a rock climber, dad, and cloud infrastructure developer working in Israel.<!-- --> <a href="https://linkedin.com/in/vodwood">You should add him on LinkedIn.</a></p></div></footer></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/devops-pastebin/eks-part-two-cilium-karpenter-flux/">← <!-- -->EKS Series Part 2. All That eBPF: Operationalizing EKS with Cilium, Karpenter and Flux</a></li><li></li></ul></nav></main><footer>© <!-- -->2023<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/eks-part-three-cilium-webstore/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-b30435f07f03c3a4781a.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-86c6079eb03a2ae7dfe2.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-74138ca0a4cce02ffa2f.js\"],\"component---src-pages-using-typescript-tsx\":[\"/component---src-pages-using-typescript-tsx-594199879152f85e5f24.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-efe475c86500a1e03273.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="45f3a7073dd28b82d03b";</script><script src="/devops-pastebin/webpack-runtime-15a6a54a9e8a3ace077b.js" async></script><script src="/devops-pastebin/framework-21741add02df4f0bf800.js" async></script><script src="/devops-pastebin/app-b30435f07f03c3a4781a.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>